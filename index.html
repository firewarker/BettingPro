<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Prophetia - Betting Intelligence</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: #fafafa;
      color: #333;
      min-height: 100vh;
    }

    /* === HEADER === */
    .header {
      background: white;
      padding: 20px 40px;
      border-bottom: 1px solid #eee;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .logo {
      font-family: 'Playfair Display', serif;
      font-size: 2.5rem;
      font-weight: 400;
      color: #5a4a78;
      letter-spacing: 2px;
    }

    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .api-status {
      display: flex;
      gap: 15px;
      font-size: 0.75rem;
      color: #888;
    }

    .api-status span {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #ccc;
    }

    .status-dot.active {
      background: #4ade80;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* === MAIN CONTAINER === */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 30px 40px;
    }

    /* === SEARCH & FILTERS === */
    .search-section {
      background: white;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 25px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }

    .search-input {
      width: 100%;
      padding: 15px 20px;
      font-size: 1rem;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      outline: none;
      transition: all 0.3s;
      font-family: inherit;
    }

    .search-input:focus {
      border-color: #5a4a78;
      box-shadow: 0 0 0 3px rgba(90, 74, 120, 0.1);
    }

    .search-input::placeholder {
      color: #aaa;
    }

    .filters-row {
      display: flex;
      gap: 20px;
      margin-top: 20px;
      align-items: center;
    }

    .select-wrapper {
      position: relative;
    }

    .filter-select {
      padding: 10px 40px 10px 15px;
      font-size: 0.9rem;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      background: white;
      cursor: pointer;
      appearance: none;
      font-family: inherit;
      min-width: 200px;
    }

    .select-wrapper::after {
      content: '‚ñº';
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 0.6rem;
      color: #888;
      pointer-events: none;
    }

    .toggle-group {
      display: flex;
      gap: 10px;
      margin-left: auto;
    }

    .toggle-btn {
      padding: 8px 20px;
      border: none;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
      font-family: inherit;
    }

    .toggle-btn.inactive {
      background: #f0f0f0;
      color: #888;
    }

    .toggle-btn.active {
      background: #5a4a78;
      color: white;
    }

    /* === MATCHES TABLE === */
    .matches-section {
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }

    .table-header {
      display: grid;
      grid-template-columns: 300px 1fr;
      background: #f8f8f8;
      padding: 15px 25px;
      font-weight: 600;
      font-size: 0.85rem;
      color: #5a4a78;
      border-bottom: 1px solid #eee;
    }

    .match-row {
      display: grid;
      grid-template-columns: 300px 1fr;
      padding: 20px 25px;
      border-bottom: 1px solid #f0f0f0;
      cursor: pointer;
      transition: all 0.2s;
      align-items: center;
    }

    .match-row:hover {
      background: #faf8ff;
    }

    .match-row:last-child {
      border-bottom: none;
    }

    .match-info {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .match-league {
      font-size: 0.9rem;
      font-weight: 600;
      color: #333;
    }

    .match-datetime {
      font-size: 0.8rem;
      color: #888;
    }

    .match-teams {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 30px;
    }

    .team {
      display: flex;
      align-items: center;
      gap: 12px;
      min-width: 200px;
    }

    .team.home {
      justify-content: flex-end;
    }

    .team.away {
      justify-content: flex-start;
    }

    .team-logo {
      width: 40px;
      height: 40px;
      object-fit: contain;
    }

    .team-logo-placeholder {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, #5a4a78 0%, #8b7aa8 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 0.9rem;
    }

    .team-name {
      font-weight: 500;
      font-size: 0.95rem;
      color: #333;
    }

    .vs-separator {
      color: #ccc;
      font-size: 0.9rem;
    }

    .live-badge {
      background: #ef4444;
      color: white;
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 0.7rem;
      font-weight: 700;
      letter-spacing: 0.5px;
      animation: pulse 1.5s infinite;
    }

    .bvs-badge {
      background: #f0f0f0;
      color: #666;
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 0.7rem;
      font-weight: 600;
    }

    /* === ANALYSIS VIEW === */
    .analysis-container {
      animation: fadeIn 0.4s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .back-button {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      color: #5a4a78;
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
      margin-bottom: 25px;
      transition: all 0.2s;
    }

    .back-button:hover {
      color: #3d3254;
    }

    .analysis-header {
      background: white;
      border-radius: 12px;
      padding: 30px;
      margin-bottom: 25px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }

    .analysis-match-info {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 40px;
      margin-bottom: 30px;
    }

    .analysis-team {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }

    .analysis-team-logo {
      width: 60px;
      height: 60px;
      object-fit: contain;
    }

    .analysis-team-name {
      font-weight: 600;
      font-size: 1.1rem;
      text-align: center;
    }

    .analysis-score {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .score-box {
      background: #f0f0f0;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 1.5rem;
      font-weight: 700;
      min-width: 50px;
      text-align: center;
    }

    .score-time {
      background: #5a4a78;
      color: white;
      padding: 8px 15px;
      border-radius: 6px;
      font-size: 0.85rem;
      font-weight: 600;
    }

    /* === STATS SLIDERS === */
    .stats-grid {
      display: grid;
      grid-template-columns: 1fr 200px 1fr;
      gap: 20px;
      align-items: start;
    }

    .stats-column {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .stat-bar {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .stat-bar-track {
      height: 8px;
      background: #e0e0e0;
      border-radius: 4px;
      position: relative;
      overflow: hidden;
    }

    .stat-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #4ade80 0%, #22c55e 100%);
      border-radius: 4px;
      transition: width 0.5s ease;
    }

    .stat-bar-fill.home {
      background: linear-gradient(90deg, #5a4a78 0%, #8b7aa8 100%);
    }

    .stat-value {
      font-size: 1.2rem;
      font-weight: 700;
      color: #5a4a78;
      text-align: right;
    }

    .stats-center {
      display: flex;
      flex-direction: column;
      gap: 20px;
      padding-top: 10px;
    }

    .stat-label {
      font-size: 0.85rem;
      color: #666;
      text-align: center;
      font-weight: 500;
    }

    .stat-main-value {
      font-size: 2.5rem;
      font-weight: 700;
      color: #333;
      text-align: center;
    }

    /* === INDICATORS === */
    .indicators-section {
      background: white;
      border-radius: 12px;
      padding: 30px;
      margin-bottom: 25px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }

    .indicator-row {
      margin-bottom: 25px;
    }

    .indicator-row:last-child {
      margin-bottom: 0;
    }

    .indicator-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .indicator-label {
      font-weight: 600;
      color: #333;
      font-size: 0.9rem;
    }

    .indicator-value {
      font-weight: 700;
      color: #5a4a78;
      font-size: 1rem;
    }

    .indicator-track {
      height: 10px;
      background: #e0e0e0;
      border-radius: 5px;
      position: relative;
    }

    .indicator-fill {
      height: 100%;
      background: linear-gradient(90deg, #5a4a78 0%, #8b7aa8 100%);
      border-radius: 5px;
      position: relative;
      transition: width 0.6s ease;
    }

    .indicator-thumb {
      position: absolute;
      right: -8px;
      top: 50%;
      transform: translateY(-50%);
      width: 16px;
      height: 16px;
      background: #4ade80;
      border-radius: 50%;
      border: 3px solid white;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }

    /* === PREDICTIONS SECTION === */
    .predictions-section {
      background: linear-gradient(135deg, #5a4a78 0%, #3d3254 100%);
      border-radius: 12px;
      padding: 35px;
      margin-bottom: 25px;
    }

    .predictions-title {
      font-family: 'Playfair Display', serif;
      font-size: 1.8rem;
      color: white;
      text-align: center;
      margin-bottom: 30px;
      letter-spacing: 3px;
    }

    .predictions-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 15px;
    }

    .prediction-card {
      background: white;
      border-radius: 10px;
      padding: 20px;
      text-align: center;
      transition: all 0.3s;
      cursor: pointer;
    }

    .prediction-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.2);
    }

    .prediction-market {
      font-size: 0.75rem;
      color: #888;
      margin-bottom: 8px;
      font-weight: 500;
    }

    .prediction-value {
      font-size: 1.3rem;
      font-weight: 700;
      color: #333;
    }

    .prediction-prob {
      font-size: 0.7rem;
      color: #5a4a78;
      margin-top: 5px;
      font-weight: 600;
    }

    /* === ACTION BUTTONS === */
    .action-buttons {
      display: flex;
      gap: 15px;
      justify-content: flex-end;
    }

    .btn {
      padding: 12px 30px;
      border: none;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
      font-family: inherit;
      letter-spacing: 0.5px;
    }

    .btn-primary {
      background: #f97316;
      color: white;
    }

    .btn-primary:hover {
      background: #ea580c;
    }

    .btn-secondary {
      background: #ef4444;
      color: white;
    }

    .btn-secondary:hover {
      background: #dc2626;
    }

    /* === LOADING === */
    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 60px;
      color: #888;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid #e0e0e0;
      border-top-color: #5a4a78;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 15px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* === EMPTY STATE === */
    .empty-state {
      text-align: center;
      padding: 60px;
      color: #888;
    }

    .empty-state-icon {
      font-size: 3rem;
      margin-bottom: 15px;
    }

    /* === ERROR === */
    .error-banner {
      background: #fef2f2;
      border: 1px solid #fecaca;
      border-radius: 8px;
      padding: 15px 20px;
      margin-bottom: 20px;
      color: #dc2626;
      font-size: 0.9rem;
    }

    /* === RESPONSIVE === */
    @media (max-width: 900px) {
      .container {
        padding: 20px;
      }

      .predictions-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .table-header,
      .match-row {
        grid-template-columns: 1fr;
        gap: 15px;
      }

      .match-teams {
        flex-direction: column;
        gap: 10px;
      }

      .team {
        min-width: auto;
        justify-content: center !important;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }

      .filters-row {
        flex-wrap: wrap;
      }

      .toggle-group {
        margin-left: 0;
        width: 100%;
        justify-content: flex-start;
      }
    }

    @media (max-width: 600px) {
      .header {
        padding: 15px 20px;
      }

      .logo {
        font-size: 1.8rem;
      }

      .predictions-grid {
        grid-template-columns: 1fr 1fr;
      }

      .action-buttons {
        flex-direction: column;
      }

      .btn {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div id="app"></div>

  <script type="module">
    // ============================================
    // üîÆ PROPHETIA - BETTING INTELLIGENCE
    // ============================================

    console.log('üîÆ Prophetia inizializzato');

    // === CONFIGURATION ===
    const CONFIG = {
      API_FOOTBALL: {
        key: 'aeb2864a3d4dbb8395fa53c83a876a93',
        baseURL: 'https://v3.football.api-sports.io',
        // Proxy CORS per chiamate browser
        proxyURL: 'https://corsproxy.io/?'
      },
      FOOTYSTATS: {
        key: 'bec59b6f83404b0bd79c40076be71f6f3abec62afdacf5eeba296f2357993f3e',
        baseURL: 'https://api.footystats.org/v1',
        proxyURL: 'https://corsproxy.io/?'
      },
      FIREBASE: {
        dbURL: 'https://bettingpro-d0125-default-rtdb.europe-west1.firebasedatabase.app'
      }
    };

    // === STATE ===
    let state = {
      view: 'home', // home, analysis
      leagues: [],
      matches: [],
      filteredMatches: [],
      selectedLeague: '',
      searchQuery: '',
      showLive: true,
      showUpcoming: true,
      selectedMatch: null,
      analysisData: null,
      loading: {
        leagues: false,
        matches: false,
        analysis: false
      },
      apiStatus: {
        apiFootball: false,
        footyStats: false,
        firebase: false
      },
      error: null,
      csvData: new Map()
    };

    // === UTILITIES ===
    function escapeHtml(text) {
      const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
      return String(text || '').replace(/[&<>"']/g, m => map[m]);
    }

    function formatDateTime(dateString) {
      if (!dateString) return { date: '-', time: '-', full: '-' };
      const d = new Date(dateString);
      return {
        date: d.toLocaleDateString('it-IT', { year: 'numeric', month: '2-digit', day: '2-digit' }),
        time: d.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' }),
        full: d.toLocaleDateString('it-IT', { year: 'numeric', month: '2-digit', day: '2-digit' }) + ' ' + 
              d.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' })
      };
    }

    function getTeamInitials(name) {
      if (!name) return '??';
      return name.split(' ').map(w => w[0]).join('').substring(0, 2).toUpperCase();
    }

    function clamp(min, val, max) {
      return Math.max(min, Math.min(max, val));
    }

    function factorial(n) {
      if (n <= 1) return 1;
      let result = 1;
      for (let i = 2; i <= n; i++) result *= i;
      return result;
    }

    function poisson(lambda, k) {
      return (Math.pow(lambda, k) * Math.exp(-lambda)) / factorial(k);
    }

    // === API CALLS ===
    async function apiFootballCall(endpoint, params = {}) {
      const url = new URL(CONFIG.API_FOOTBALL.baseURL + endpoint);
      Object.keys(params).forEach(key => url.searchParams.append(key, params[key]));

      try {
        console.log('üì° API-Football:', endpoint, params);
        
        const response = await fetch(CONFIG.API_FOOTBALL.proxyURL + encodeURIComponent(url.toString()), {
          method: 'GET',
          headers: {
            'x-rapidapi-key': CONFIG.API_FOOTBALL.key,
            'x-rapidapi-host': 'v3.football.api-sports.io'
          }
        });

        if (!response.ok) throw new Error(`HTTP ${response.status}`);

        const data = await response.json();
        console.log('‚úÖ API-Football response:', data);
        state.apiStatus.apiFootball = true;

        // Cache in Firebase
        const cacheKey = btoa(endpoint + JSON.stringify(params)).replace(/[^a-zA-Z0-9]/g, '');
        firebaseSet(`/cache/${cacheKey}`, { data, timestamp: Date.now() });

        return data;
      } catch (error) {
        console.error('‚ùå API-Football error:', error);
        state.apiStatus.apiFootball = false;

        // Try Firebase cache
        const cacheKey = btoa(endpoint + JSON.stringify(params)).replace(/[^a-zA-Z0-9]/g, '');
        const cached = await firebaseGet(`/cache/${cacheKey}`);
        if (cached?.data) {
          console.log('üì¶ Using Firebase cache');
          return cached.data;
        }

        throw error;
      }
    }

    async function footyStatsCall(endpoint, params = {}) {
      const url = new URL(CONFIG.FOOTYSTATS.baseURL + endpoint);
      url.searchParams.append('key', CONFIG.FOOTYSTATS.key);
      Object.keys(params).forEach(key => url.searchParams.append(key, params[key]));

      try {
        console.log('üì° FootyStats:', endpoint, params);
        
        const response = await fetch(CONFIG.FOOTYSTATS.proxyURL + encodeURIComponent(url.toString()));
        if (!response.ok) throw new Error(`HTTP ${response.status}`);

        const data = await response.json();
        console.log('‚úÖ FootyStats response:', data);
        state.apiStatus.footyStats = true;
        return data;
      } catch (error) {
        console.error('‚ùå FootyStats error:', error);
        state.apiStatus.footyStats = false;
        return null;
      }
    }

    async function firebaseGet(path) {
      try {
        const response = await fetch(`${CONFIG.FIREBASE.dbURL}${path}.json`);
        if (!response.ok) throw new Error('Firebase error');
        const data = await response.json();
        state.apiStatus.firebase = true;
        return data;
      } catch (error) {
        state.apiStatus.firebase = false;
        return null;
      }
    }

    async function firebaseSet(path, data) {
      try {
        await fetch(`${CONFIG.FIREBASE.dbURL}${path}.json`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        return true;
      } catch (error) {
        return false;
      }
    }

    // === DATA LOADING ===
    async function loadTodayMatches() {
      state.loading.matches = true;
      state.error = null;
      render();

      try {
        const today = new Date().toISOString().split('T')[0];
        
        // Try API-Football
        const response = await apiFootballCall('/fixtures', {
          date: today,
          timezone: 'Europe/Rome'
        });

        if (response?.response) {
          const matches = response.response.map(f => ({
            id: f.fixture.id,
            date: f.fixture.date,
            timestamp: f.fixture.timestamp,
            status: f.fixture.status.short,
            elapsed: f.fixture.status.elapsed,
            league: {
              id: f.league.id,
              name: f.league.name,
              country: f.league.country,
              logo: f.league.logo
            },
            homeTeam: {
              id: f.teams.home.id,
              name: f.teams.home.name,
              logo: f.teams.home.logo
            },
            awayTeam: {
              id: f.teams.away.id,
              name: f.teams.away.name,
              logo: f.teams.away.logo
            },
            goals: f.goals,
            score: f.score
          }));

          // Sort by time
          matches.sort((a, b) => a.timestamp - b.timestamp);

          // Extract unique leagues
          const leagueMap = new Map();
          matches.forEach(m => {
            if (!leagueMap.has(m.league.id)) {
              leagueMap.set(m.league.id, m.league);
            }
          });
          state.leagues = Array.from(leagueMap.values());

          state.matches = matches;
          state.filteredMatches = matches;
          console.log('‚úÖ Loaded', matches.length, 'matches');
        }
      } catch (error) {
        console.error('‚ùå Error loading matches:', error);
        state.error = 'Errore nel caricamento delle partite. Riprova.';
        
        // Fallback demo data
        state.matches = generateDemoMatches();
        state.filteredMatches = state.matches;
      } finally {
        state.loading.matches = false;
        render();
      }
    }

    function generateDemoMatches() {
      const leagues = [
        { id: 207, name: 'A-League Men', country: 'Australia' },
        { id: 210, name: '1. HNL', country: 'Croatia' },
        { id: 283, name: 'Superliga', country: 'Romania' },
        { id: 203, name: 'Super Lig', country: 'Turkey' },
        { id: 79, name: '2. Bundesliga', country: 'Germany' },
        { id: 94, name: 'Liga Portugal 2', country: 'Portugal' }
      ];

      const teams = [
        ['Newcastle Jets', 'Wellington Phoenix'],
        ['Vara≈ædin', 'Gorica'],
        ['Metaloglobus', 'Arge»ô'],
        ['Trabzonspor', 'Kasƒ±mpa≈üa'],
        ['DSC Arminia Bielefeld', 'Holstein Kiel'],
        ['Darmstadt 98', 'N√ºrnberg'],
        ['Pa√ßos de Ferreira', 'Academico Viseu']
      ];

      const now = new Date();
      return teams.map((t, i) => ({
        id: 1000 + i,
        date: new Date(now.getTime() + i * 3600000 * 2).toISOString(),
        timestamp: now.getTime() + i * 3600000 * 2,
        status: i === 0 ? '1H' : 'NS',
        elapsed: i === 0 ? 35 : null,
        league: leagues[i % leagues.length],
        homeTeam: { id: i * 10, name: t[0], logo: '' },
        awayTeam: { id: i * 10 + 1, name: t[1], logo: '' },
        goals: i === 0 ? { home: 1, away: 0 } : { home: null, away: null }
      }));
    }

    function filterMatches() {
      let filtered = [...state.matches];

      // Filter by search
      if (state.searchQuery) {
        const q = state.searchQuery.toLowerCase();
        filtered = filtered.filter(m =>
          m.homeTeam.name.toLowerCase().includes(q) ||
          m.awayTeam.name.toLowerCase().includes(q) ||
          m.league.name.toLowerCase().includes(q) ||
          m.league.country.toLowerCase().includes(q)
        );
      }

      // Filter by league
      if (state.selectedLeague) {
        filtered = filtered.filter(m => m.league.id == state.selectedLeague);
      }

      // Filter by status
      const liveStatuses = ['1H', '2H', 'HT', 'ET', 'P', 'LIVE'];
      if (!state.showLive) {
        filtered = filtered.filter(m => !liveStatuses.includes(m.status));
      }
      if (!state.showUpcoming) {
        filtered = filtered.filter(m => m.status !== 'NS');
      }

      state.filteredMatches = filtered;
      render();
    }

    // === ANALYSIS ===
    async function analyzeMatch(match) {
      state.selectedMatch = match;
      state.view = 'analysis';
      state.loading.analysis = true;
      state.analysisData = null;
      render();

      try {
        // Try to get team stats from FootyStats
        let homeStats = null, awayStats = null;

        try {
          const homeData = await footyStatsCall('/team', { team_id: match.homeTeam.id });
          if (homeData?.data) homeStats = homeData.data;
        } catch (e) {}

        try {
          const awayData = await footyStatsCall('/team', { team_id: match.awayTeam.id });
          if (awayData?.data) awayStats = awayData.data;
        } catch (e) {}

        // Generate predictions based on available data
        const analysis = generateAnalysis(match, homeStats, awayStats);
        state.analysisData = analysis;
        console.log('‚úÖ Analysis complete:', analysis);

      } catch (error) {
        console.error('‚ùå Analysis error:', error);
        // Generate with defaults
        state.analysisData = generateAnalysis(match, null, null);
      } finally {
        state.loading.analysis = false;
        render();
      }
    }

    function generateAnalysis(match, homeStats, awayStats) {
      // Base expected goals (with some variance based on team names hash)
      const homeHash = match.homeTeam.name.split('').reduce((a, c) => a + c.charCodeAt(0), 0);
      const awayHash = match.awayTeam.name.split('').reduce((a, c) => a + c.charCodeAt(0), 0);
      
      let homeXG = 1.2 + (homeHash % 10) / 20; // 1.2 - 1.7
      let awayXG = 0.9 + (awayHash % 10) / 20; // 0.9 - 1.4

      // Enhance with real stats if available
      if (homeStats?.xg_for_avg_overall) {
        homeXG = homeXG * 0.5 + homeStats.xg_for_avg_overall * 0.5;
      }
      if (awayStats?.xg_for_avg_overall) {
        awayXG = awayXG * 0.5 + awayStats.xg_for_avg_overall * 0.5;
      }

      // Home advantage
      homeXG *= 1.1;
      awayXG *= 0.95;

      // Calculate probabilities
      const prob1X2 = calculate1X2(homeXG, awayXG);
      const probOU = calculateOverUnder(homeXG, awayXG);
      const probBTTS = calculateBTTS(homeXG, awayXG);
      const exactScores = calculateExactScores(homeXG, awayXG);

      // Corner predictions (based on typical averages)
      const homeCorners = 4.5 + (homeHash % 30) / 15; // 4.5 - 6.5
      const awayCorners = 4.0 + (awayHash % 30) / 15; // 4.0 - 6.0
      const totalCorners = homeCorners + awayCorners;

      // Cards predictions
      const homeCards = 1.5 + (homeHash % 20) / 20;
      const awayCards = 1.5 + (awayHash % 20) / 20;
      const totalCards = homeCards + awayCards;

      // Generate VALUE predictions (not obvious ones)
      const predictions = [];

      // Best exact score
      const bestScore = exactScores[0];
      predictions.push({
        market: 'Risultato Esatto',
        value: `${bestScore.home}-${bestScore.away}`,
        probability: bestScore.prob
      });

      // Second best score
      const secondScore = exactScores[1];
      predictions.push({
        market: 'Ris. Esatto Alt.',
        value: `${secondScore.home}-${secondScore.away}`,
        probability: secondScore.prob
      });

      // Corners total
      const cornerLine = Math.round(totalCorners) - 0.5;
      const cornerOverProb = totalCorners > cornerLine ? 55 + (totalCorners - cornerLine) * 10 : 45;
      predictions.push({
        market: 'Corner Totali',
        value: cornerOverProb > 50 ? `Over ${cornerLine}` : `Under ${cornerLine}`,
        probability: cornerOverProb > 50 ? cornerOverProb : 100 - cornerOverProb
      });

      // Home team corners
      const homeCornerLine = Math.round(homeCorners) - 0.5;
      predictions.push({
        market: `Corner ${match.homeTeam.name.split(' ')[0]}`,
        value: homeCorners > homeCornerLine ? `Over ${homeCornerLine}` : `Under ${homeCornerLine}`,
        probability: 52 + Math.abs(homeCorners - homeCornerLine) * 8
      });

      // Total cards
      const cardLine = Math.round(totalCards) + 0.5;
      predictions.push({
        market: 'Cartellini Tot.',
        value: totalCards > 3.5 ? `Over ${cardLine}` : `Under ${cardLine}`,
        probability: 50 + Math.abs(totalCards - cardLine) * 12
      });

      // Multigol range
      const totalXG = homeXG + awayXG;
      let multigolRange;
      if (totalXG < 2) multigolRange = '0-2';
      else if (totalXG < 2.8) multigolRange = '1-3';
      else if (totalXG < 3.5) multigolRange = '2-4';
      else multigolRange = '3-5';
      
      predictions.push({
        market: 'Multigol',
        value: multigolRange,
        probability: 55 + (Math.random() * 15)
      });

      // 1X2 (but only if clear favorite)
      const maxProb = Math.max(prob1X2.home, prob1X2.draw, prob1X2.away);
      if (maxProb > 45) {
        let result1X2;
        if (prob1X2.home === maxProb) result1X2 = '1';
        else if (prob1X2.away === maxProb) result1X2 = '2';
        else result1X2 = 'X';
        
        predictions.push({
          market: 'Esito',
          value: result1X2,
          probability: maxProb
        });
      }

      // BTTS
      predictions.push({
        market: 'GG/NG',
        value: probBTTS > 50 ? 'GG' : 'NG',
        probability: probBTTS > 50 ? probBTTS : 100 - probBTTS
      });

      return {
        match,
        xG: { home: homeXG, away: awayXG, total: homeXG + awayXG },
        corners: { home: homeCorners, away: awayCorners, total: totalCorners },
        cards: { home: homeCards, away: awayCards, total: totalCards },
        prob1X2,
        probOU,
        probBTTS,
        exactScores: exactScores.slice(0, 5),
        predictions: predictions.slice(0, 8),
        indicators: {
          motivazione: { home: 30 + homeHash % 40, away: 30 + awayHash % 40 },
          forbice: { home: 35 + homeHash % 30, away: 35 + awayHash % 30 },
          classifica: Math.round(prob1X2.home / (prob1X2.home + prob1X2.away) * 100),
          overUnder: Math.round(probOU[2.5].over)
        },
        dataQuality: homeStats || awayStats ? 'enhanced' : 'estimated'
      };
    }

    function calculate1X2(lambdaH, lambdaA) {
      let probHome = 0, probDraw = 0, probAway = 0;
      for (let i = 0; i <= 6; i++) {
        for (let j = 0; j <= 6; j++) {
          const prob = poisson(lambdaH, i) * poisson(lambdaA, j);
          if (i > j) probHome += prob;
          else if (i === j) probDraw += prob;
          else probAway += prob;
        }
      }
      const total = probHome + probDraw + probAway;
      return {
        home: (probHome / total) * 100,
        draw: (probDraw / total) * 100,
        away: (probAway / total) * 100
      };
    }

    function calculateBTTS(lambdaH, lambdaA) {
      const probH0 = poisson(lambdaH, 0);
      const probA0 = poisson(lambdaA, 0);
      return clamp(25, (1 - probH0) * (1 - probA0) * 100, 75);
    }

    function calculateOverUnder(lambdaH, lambdaA) {
      const result = {};
      [1.5, 2.5, 3.5].forEach(line => {
        let probUnder = 0;
        for (let i = 0; i <= Math.floor(line); i++) {
          for (let j = 0; j <= Math.floor(line) - i; j++) {
            if (i + j <= line) {
              probUnder += poisson(lambdaH, i) * poisson(lambdaA, j);
            }
          }
        }
        result[line] = {
          over: clamp(10, (1 - probUnder) * 100, 90),
          under: clamp(10, probUnder * 100, 90)
        };
      });
      return result;
    }

    function calculateExactScores(lambdaH, lambdaA) {
      const scores = [];
      for (let i = 0; i <= 5; i++) {
        for (let j = 0; j <= 5; j++) {
          const prob = poisson(lambdaH, i) * poisson(lambdaA, j) * 100;
          scores.push({ home: i, away: j, prob });
        }
      }
      return scores.sort((a, b) => b.prob - a.prob);
    }

    // === RENDER FUNCTIONS ===
    function render() {
      const app = document.getElementById('app');
      app.innerHTML = `
        ${renderHeader()}
        <div class="container">
          ${state.view === 'home' ? renderHomeView() : renderAnalysisView()}
        </div>
      `;
      attachEventListeners();
    }

    function renderHeader() {
      return `
        <header class="header">
          <div class="header-content">
            <div class="logo">Prophetia</div>
            <div class="api-status">
              <span>
                <span class="status-dot ${state.apiStatus.apiFootball ? 'active' : ''}"></span>
                API-Football
              </span>
              <span>
                <span class="status-dot ${state.apiStatus.footyStats ? 'active' : ''}"></span>
                FootyStats
              </span>
              <span>
                <span class="status-dot ${state.apiStatus.firebase ? 'active' : ''}"></span>
                Firebase
              </span>
            </div>
          </div>
        </header>
      `;
    }

    function renderHomeView() {
      return `
        <div class="search-section">
          <input 
            type="text" 
            class="search-input" 
            id="searchInput"
            placeholder="üîç Campionato, Squadra, ecc."
            value="${escapeHtml(state.searchQuery)}"
          />
          <div class="filters-row">
            <div class="select-wrapper">
              <select class="filter-select" id="leagueFilter">
                <option value="">Tutti i campionati</option>
                ${state.leagues.map(l => `
                  <option value="${l.id}" ${state.selectedLeague == l.id ? 'selected' : ''}>
                    ${escapeHtml(l.country)}: ${escapeHtml(l.name)}
                  </option>
                `).join('')}
              </select>
            </div>
            <div class="toggle-group">
              <button class="toggle-btn ${!state.showLive ? 'active' : 'inactive'}" id="toggleTerminati">
                Terminati
              </button>
              <button class="toggle-btn ${state.showUpcoming ? 'active' : 'inactive'}" id="toggleAttivi">
                Attivi
              </button>
            </div>
          </div>
        </div>

        ${state.error ? `<div class="error-banner">${escapeHtml(state.error)}</div>` : ''}

        <div class="matches-section">
          <div class="table-header">
            <div>Luogo/Data</div>
            <div style="text-align: center;">Incontro</div>
          </div>
          ${state.loading.matches ? `
            <div class="loading">
              <div class="spinner"></div>
              <div>Caricamento partite...</div>
            </div>
          ` : state.filteredMatches.length === 0 ? `
            <div class="empty-state">
              <div class="empty-state-icon">üì≠</div>
              <div>Nessuna partita trovata</div>
            </div>
          ` : state.filteredMatches.map(match => renderMatchRow(match)).join('')}
        </div>
      `;
    }

    function renderMatchRow(match) {
      const { date, time, full } = formatDateTime(match.date);
      const isLive = ['1H', '2H', 'HT', 'ET', 'P', 'LIVE'].includes(match.status);
      
      return `
        <div class="match-row" data-match-id="${match.id}">
          <div class="match-info">
            ${isLive ? '<span class="live-badge">LIVE</span>' : ''}
            <div class="match-league">${escapeHtml(match.league.country)}: ${escapeHtml(match.league.name)}</div>
            <div class="match-datetime">${full}</div>
          </div>
          <div class="match-teams">
            <div class="team home">
              <span class="team-name">${escapeHtml(match.homeTeam.name)}</span>
              ${match.homeTeam.logo ? 
                `<img src="${match.homeTeam.logo}" class="team-logo" onerror="this.outerHTML='<div class=\\'team-logo-placeholder\\'>${getTeamInitials(match.homeTeam.name)}</div>'" />` :
                `<div class="team-logo-placeholder">${getTeamInitials(match.homeTeam.name)}</div>`
              }
            </div>
            <div class="vs-separator">
              ${isLive && match.goals ? 
                `<strong>${match.goals.home} - ${match.goals.away}</strong>` : 
                '‚Äî'
              }
            </div>
            <div class="team away">
              ${match.awayTeam.logo ? 
                `<img src="${match.awayTeam.logo}" class="team-logo" onerror="this.outerHTML='<div class=\\'team-logo-placeholder\\'>${getTeamInitials(match.awayTeam.name)}</div>'" />` :
                `<div class="team-logo-placeholder">${getTeamInitials(match.awayTeam.name)}</div>`
              }
              <span class="team-name">${escapeHtml(match.awayTeam.name)}</span>
            </div>
          </div>
        </div>
      `;
    }

    function renderAnalysisView() {
      const match = state.selectedMatch;
      const data = state.analysisData;

      if (state.loading.analysis) {
        return `
          <div class="analysis-container">
            <div class="back-button" id="backBtn">‚Üê Torna alla lista</div>
            <div class="loading">
              <div class="spinner"></div>
              <div>Analisi in corso...</div>
            </div>
          </div>
        `;
      }

      if (!data) {
        return `
          <div class="analysis-container">
            <div class="back-button" id="backBtn">‚Üê Torna alla lista</div>
            <div class="empty-state">
              <div class="empty-state-icon">‚ö†Ô∏è</div>
              <div>Errore nell'analisi</div>
            </div>
          </div>
        `;
      }

      return `
        <div class="analysis-container">
          <div class="back-button" id="backBtn">‚Üê Torna alla lista</div>

          <div class="analysis-header">
            <div class="stats-grid">
              <div class="stats-column">
                ${renderStatBar('', data.indicators.motivazione.home, true)}
                ${renderStatBar('', data.indicators.forbice.home, true)}
                <div class="stat-main-value">${Math.round(data.xG.home * 50 + 80)}</div>
              </div>
              <div class="stats-center">
                <div>
                  <div class="stat-label">Motivazione</div>
                  <div class="stat-value">${data.indicators.motivazione.away}</div>
                </div>
                <div>
                  <div class="stat-label">Forbice</div>
                  <div class="stat-value">${data.indicators.forbice.away}</div>
                </div>
              </div>
              <div class="stats-column">
                ${renderStatBar('', data.indicators.motivazione.away, false)}
                ${renderStatBar('', data.indicators.forbice.away, false)}
                <div class="stat-main-value">${Math.round(data.xG.away * 50 + 70)}</div>
              </div>
            </div>
          </div>

          <div class="indicators-section">
            <div class="indicator-row">
              <div class="indicator-header">
                <span class="indicator-label">Classifica Congrua</span>
                <span class="indicator-value">${data.indicators.classifica}</span>
              </div>
              <div class="indicator-track">
                <div class="indicator-fill" style="width: ${data.indicators.classifica}%">
                  <div class="indicator-thumb"></div>
                </div>
              </div>
            </div>
            <div class="indicator-row">
              <div class="indicator-header">
                <span class="indicator-label">Under/Over</span>
                <span class="indicator-value">${data.indicators.overUnder}</span>
              </div>
              <div class="indicator-track">
                <div class="indicator-fill" style="width: ${data.indicators.overUnder}%">
                  <div class="indicator-thumb"></div>
                </div>
              </div>
            </div>
          </div>

          <div class="analysis-header">
            <div style="text-align: center; color: #888; margin-bottom: 15px; font-size: 0.85rem;">
              Risultato previsto:
            </div>
            <div class="analysis-match-info">
              <div class="analysis-team">
                ${match.homeTeam.logo ? 
                  `<img src="${match.homeTeam.logo}" class="analysis-team-logo" onerror="this.style.display='none'" />` : 
                  ''
                }
                <div class="analysis-team-name">${escapeHtml(match.homeTeam.name)}</div>
              </div>
              <div class="analysis-score">
                <div class="score-box">${data.exactScores[0].home}</div>
                <div class="score-time">90'</div>
                <div class="score-box">${data.exactScores[0].away}</div>
              </div>
              <div class="analysis-team">
                ${match.awayTeam.logo ? 
                  `<img src="${match.awayTeam.logo}" class="analysis-team-logo" onerror="this.style.display='none'" />` : 
                  ''
                }
                <div class="analysis-team-name">${escapeHtml(match.awayTeam.name)}</div>
              </div>
            </div>
          </div>

          <div class="predictions-section">
            <div class="predictions-title">I PRONOSTICI</div>
            <div class="predictions-grid">
              ${data.predictions.map(pred => `
                <div class="prediction-card">
                  <div class="prediction-market">${escapeHtml(pred.market)}</div>
                  <div class="prediction-value">${escapeHtml(pred.value)}</div>
                  <div class="prediction-prob">${pred.probability.toFixed(0)}%</div>
                </div>
              `).join('')}
            </div>
          </div>

          <div class="action-buttons">
            <button class="btn btn-primary" id="repeatBtn">REPEAT</button>
            <button class="btn btn-secondary" id="backBtn2">&lt; BACK</button>
          </div>
        </div>
      `;
    }

    function renderStatBar(label, value, isHome) {
      return `
        <div class="stat-bar">
          <div class="stat-bar-track">
            <div class="stat-bar-fill ${isHome ? 'home' : ''}" style="width: ${value}%"></div>
          </div>
          <div class="stat-value">${value}</div>
        </div>
      `;
    }

    function attachEventListeners() {
      // Search input
      const searchInput = document.getElementById('searchInput');
      if (searchInput) {
        searchInput.addEventListener('input', (e) => {
          state.searchQuery = e.target.value;
          filterMatches();
        });
      }

      // League filter
      const leagueFilter = document.getElementById('leagueFilter');
      if (leagueFilter) {
        leagueFilter.addEventListener('change', (e) => {
          state.selectedLeague = e.target.value;
          filterMatches();
        });
      }

      // Toggle buttons
      const toggleTerminati = document.getElementById('toggleTerminati');
      if (toggleTerminati) {
        toggleTerminati.addEventListener('click', () => {
          state.showLive = !state.showLive;
          filterMatches();
        });
      }

      const toggleAttivi = document.getElementById('toggleAttivi');
      if (toggleAttivi) {
        toggleAttivi.addEventListener('click', () => {
          state.showUpcoming = !state.showUpcoming;
          filterMatches();
        });
      }

      // Match rows
      document.querySelectorAll('.match-row').forEach(row => {
        row.addEventListener('click', () => {
          const matchId = parseInt(row.dataset.matchId);
          const match = state.matches.find(m => m.id === matchId);
          if (match) analyzeMatch(match);
        });
      });

      // Back buttons
      const backBtns = document.querySelectorAll('#backBtn, #backBtn2');
      backBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          state.view = 'home';
          state.selectedMatch = null;
          state.analysisData = null;
          render();
        });
      });

      // Repeat button
      const repeatBtn = document.getElementById('repeatBtn');
      if (repeatBtn && state.selectedMatch) {
        repeatBtn.addEventListener('click', () => {
          analyzeMatch(state.selectedMatch);
        });
      }
    }

    // === INIT ===
    async function init() {
      console.log('üöÄ Initializing Prophetia...');
      render();
      await loadTodayMatches();
      console.log('‚úÖ Prophetia ready!');
    }

    init();
  </script>
</body>
</html>

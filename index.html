<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚öΩ Prophecy Hunter Elite - Sistema Predittivo Avanzato</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            animation: fadeIn 0.8s;
        }

        header h1 {
            font-size: 2.8rem;
            margin-bottom: 10px;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.3);
            background: linear-gradient(90deg, #fff, #f0f0f0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .subtitle {
            font-size: 1.1rem;
            opacity: 0.95;
            font-weight: 300;
        }

        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.2);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin: 10px 0;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .controls {
            background: rgba(255, 255, 255, 0.12);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .btn {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn.active {
            background: rgba(255, 255, 255, 0.35);
            border-color: white;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
        }

        .btn-danger {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border: none;
        }

        .btn-success {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            border: none;
        }

        .filters {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        select, input {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 10px 15px;
            border-radius: 10px;
            font-size: 0.95rem;
        }

        select option {
            background: #667eea;
            color: white;
        }

        .matches-grid {
            display: grid;
            gap: 20px;
            animation: fadeIn 0.8s;
        }

        .match-card {
            background: rgba(255, 255, 255, 0.12);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.4s;
            position: relative;
            overflow: hidden;
        }

        .match-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            background: rgba(255, 255, 255, 0.18);
        }

        .match-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
        }

        .match-teams {
            font-size: 1.4rem;
            font-weight: bold;
            flex: 1;
        }

        .match-date {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-right: 10px;
        }

        .match-league {
            background: rgba(255, 255, 255, 0.2);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .predictions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .prediction-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.15);
        }

        .prediction-label {
            font-size: 0.85rem;
            opacity: 0.9;
            margin-bottom: 8px;
        }

        .prediction-value {
            font-size: 1.6rem;
            font-weight: bold;
        }

        .prediction-value.high {
            color: #00ff88;
            text-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
        }

        .prediction-value.medium {
            color: #ffd93d;
            text-shadow: 0 0 10px rgba(255, 217, 61, 0.5);
        }

        .prediction-value.low {
            color: #ff6b6b;
            text-shadow: 0 0 10px rgba(255, 107, 107, 0.5);
        }

        .multigol-section {
            background: linear-gradient(135deg, rgba(255,255,255,0.15), rgba(255,255,255,0.05));
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .multigol-title {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 15px;
            text-align: center;
            color: #ffd93d;
        }

        .multigol-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
        }

        .multigol-item {
            background: rgba(0, 0, 0, 0.2);
            padding: 12px;
            border-radius: 10px;
            text-align: center;
        }

        .recommendation {
            display: inline-block;
            padding: 12px 30px;
            border-radius: 25px;
            font-weight: bold;
            font-size: 1.1rem;
            margin-top: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .rec-strong {
            background: linear-gradient(135deg, #ff0000, #ff4444);
            animation: pulse 2s infinite;
            box-shadow: 0 5px 20px rgba(255, 0, 0, 0.4);
        }

        .rec-bet {
            background: linear-gradient(135deg, #00c853, #69f0ae);
            box-shadow: 0 5px 20px rgba(0, 200, 83, 0.4);
        }

        .rec-check {
            background: linear-gradient(135deg, #ffa000, #ffd54f);
            box-shadow: 0 5px 20px rgba(255, 160, 0, 0.4);
        }

        .rec-skip {
            background: linear-gradient(135deg, #666, #999);
        }

        .confidence-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
            margin: 15px 0;
        }

        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff6b6b, #ffd93d, #00ff88);
            transition: width 0.5s;
        }

        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.5rem;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top: 4px solid white;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        .error {
            background: rgba(255, 0, 0, 0.2);
            border: 2px solid rgba(255, 0, 0, 0.5);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            margin: 20px 0;
        }

        .success {
            background: rgba(0, 255, 0, 0.2);
            border: 2px solid rgba(0, 255, 0, 0.5);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            margin: 20px 0;
        }

        .info-box {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            font-size: 0.9rem;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @media (max-width: 768px) {
            header h1 {
                font-size: 2rem;
            }

            .predictions-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .btn-group {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>‚öΩ PROPHECY HUNTER ELITE</h1>
            <p class="subtitle">Sistema Predittivo Avanzato con Algoritmo Poisson & Multigol</p>
        </header>

        <div class="stats-bar">
            <div class="stat-card">
                <div class="stat-label">Partite Caricate</div>
                <div class="stat-value" id="totalMatches">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">üî• BET STRONG</div>
                <div class="stat-value" id="betStrong">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">‚úÖ Raccomandati</div>
                <div class="stat-value" id="betRecommended">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ROI Tracker</div>
                <div class="stat-value" id="roiValue">0%</div>
            </div>
        </div>

        <div class="controls">
            <div class="btn-group">
                <button class="btn btn-primary" onclick="loadMatches()">üì• Carica Partite Oggi</button>
                <button class="btn btn-primary" onclick="loadMatchesTomorrow()">üìÖ Carica Partite Domani</button>
                <button class="btn btn-success" onclick="exportToExcel()">üìä Export CSV</button>
                <button class="btn btn-danger" onclick="clearAll()">üóëÔ∏è Reset</button>
            </div>

            <div class="filters">
                <select id="leagueFilter" onchange="filterMatches()">
                    <option value="">Tutte le Leghe</option>
                </select>
                <select id="confidenceFilter" onchange="filterMatches()">
                    <option value="">Tutte le Confidence</option>
                    <option value="high">Alta (>75%)</option>
                    <option value="medium">Media (60-75%)</option>
                    <option value="low">Bassa (<60%)</option>
                </select>
                <input type="text" id="searchInput" placeholder="üîç Cerca squadra..." oninput="filterMatches()">
            </div>
        </div>

        <div id="matchesContainer" class="matches-grid">
            <div class="loading">
                <div class="spinner"></div>
                <p>Premi "Carica Partite Oggi" per iniziare</p>
                <div class="info-box">
                    üìÖ Data corrente: <strong>22 Gennaio 2026</strong><br>
                    üèÜ Stagione: <strong>2025-26</strong><br>
                    üîë API Key: Configurata ‚úÖ
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_KEY = 'aeb2864a3d4dbb8395fa53c83a876a93';
        let allMatches = [];
        let currentSeason = 2025; // Stagione 2025-26

        // Leghe principali
        const LEAGUES = {
            'Serie A': 135,
            'Premier League': 39,
            'LaLiga': 140,
            'Bundesliga': 78,
            'Ligue 1': 61,
            'Champions League': 2
        };

        // Funzione fattoriale
        function factorial(n) {
            if (n <= 1) return 1;
            return n * factorial(n - 1);
        }

        // Calcolo Poisson P(X=k)
        function poissonProbability(lambda, k) {
            return (Math.pow(lambda, k) * Math.exp(-lambda)) / factorial(k);
        }

        // Calcolo Over/Under con Poisson
        function calculateOver(xGHome, xGAway, threshold) {
            const lambda = xGHome + xGAway;
            let prob = 0;

            for (let i = 0; i <= Math.floor(threshold); i++) {
                prob += poissonProbability(lambda, i);
            }

            return (1 - prob) * 100;
        }

        // Calcolo Multigol 1-3
        function calculateMultigol13(xG) {
            const p1 = poissonProbability(xG, 1);
            const p2 = poissonProbability(xG, 2);
            const p3 = poissonProbability(xG, 3);
            return (p1 + p2 + p3) * 100;
        }

        // Calcolo Multigol 2-4
        function calculateMultigol24(xG) {
            const p2 = poissonProbability(xG, 2);
            const p3 = poissonProbability(xG, 3);
            const p4 = poissonProbability(xG, 4);
            return (p2 + p3 + p4) * 100;
        }

        // Calcolo GG%
        function calculateGG(xGHome, xGAway) {
            const probHomeScores = 1 - Math.exp(-xGHome);
            const probAwayScores = 1 - Math.exp(-xGAway);
            return probHomeScores * probAwayScores * 100;
        }

        // Calcolo xG con statistiche reali
        function calculateXG(teamStats, isHome) {
            const homeFactor = isHome ? 1.15 : 0.95;

            // Usa statistiche reali se disponibili
            if (teamStats && teamStats.goals) {
                const avgGoals = isHome ? 
                    (teamStats.goals.for?.average?.home || 1.5) : 
                    (teamStats.goals.for?.average?.away || 1.3);
                return parseFloat(avgGoals) * homeFactor;
            }

            // Default
            return 1.5 * homeFactor;
        }

        // Calcola tutte le predizioni
        function calculatePredictions(match) {
            const xGHome = match.xGHome || 1.5;
            const xGAway = match.xGAway || 1.3;

            const gg = calculateGG(xGHome, xGAway);
            const over05 = calculateOver(xGHome, xGAway, 0.5);
            const over15 = calculateOver(xGHome, xGAway, 1.5);
            const over25 = calculateOver(xGHome, xGAway, 2.5);
            const over35 = calculateOver(xGHome, xGAway, 3.5);

            const mg13Home = calculateMultigol13(xGHome);
            const mg13Away = calculateMultigol13(xGAway);
            const mg24Home = calculateMultigol24(xGHome);
            const mg24Away = calculateMultigol24(xGAway);

            // Confidence combinata
            const confidence = Math.round(
                (gg > 65 ? 25 : gg > 55 ? 15 : 0) +
                (over25 > 65 ? 25 : over25 > 50 ? 15 : 0) +
                (mg13Home > 60 ? 15 : 0) +
                (mg13Away > 60 ? 15 : 0) +
                50
            );

            // Raccomandazione
            let recommendation = '‚ùå SKIP';
            if (confidence > 80 && gg > 75) {
                recommendation = 'üî• BET STRONG';
            } else if (confidence > 70 && gg > 65) {
                recommendation = '‚úÖ BET';
            } else if (confidence > 60) {
                recommendation = '‚ö†Ô∏è CHECK';
            }

            return {
                xGHome: xGHome.toFixed(2),
                xGAway: xGAway.toFixed(2),
                gg: gg.toFixed(1),
                over05: over05.toFixed(1),
                over15: over15.toFixed(1),
                over25: over25.toFixed(1),
                over35: over35.toFixed(1),
                under25: (100 - over25).toFixed(1),
                mg13Home: mg13Home.toFixed(1),
                mg13Away: mg13Away.toFixed(1),
                mg24Home: mg24Home.toFixed(1),
                mg24Away: mg24Away.toFixed(1),
                confidence,
                recommendation
            };
        }

        // Formatta colore predizione
        function getPredictionClass(value) {
            if (value >= 70) return 'high';
            if (value >= 50) return 'medium';
            return 'low';
        }

        // Renderizza una partita
        function renderMatch(match, predictions) {
            const recClass = predictions.recommendation.includes('STRONG') ? 'rec-strong' :
                           predictions.recommendation.includes('‚úÖ') ? 'rec-bet' :
                           predictions.recommendation.includes('‚ö†Ô∏è') ? 'rec-check' : 'rec-skip';

            return `
                <div class="match-card">
                    <div class="match-header">
                        <div class="match-teams">${match.homeTeam} vs ${match.awayTeam}</div>
                        <div class="match-date">${match.date}</div>
                        <div class="match-league">${match.league}</div>
                    </div>

                    <div class="confidence-bar">
                        <div class="confidence-fill" style="width: ${predictions.confidence}%"></div>
                    </div>
                    <div style="text-align: center; margin-bottom: 15px;">
                        Confidence: ${predictions.confidence}%
                    </div>

                    <div class="predictions-grid">
                        <div class="prediction-item">
                            <div class="prediction-label">xG Casa</div>
                            <div class="prediction-value">${predictions.xGHome}</div>
                        </div>
                        <div class="prediction-item">
                            <div class="prediction-label">xG Ospite</div>
                            <div class="prediction-value">${predictions.xGAway}</div>
                        </div>
                        <div class="prediction-item">
                            <div class="prediction-label">GG%</div>
                            <div class="prediction-value ${getPredictionClass(predictions.gg)}">${predictions.gg}%</div>
                        </div>
                        <div class="prediction-item">
                            <div class="prediction-label">Over 2.5%</div>
                            <div class="prediction-value ${getPredictionClass(predictions.over25)}">${predictions.over25}%</div>
                        </div>
                        <div class="prediction-item">
                            <div class="prediction-label">Over 1.5%</div>
                            <div class="prediction-value ${getPredictionClass(predictions.over15)}">${predictions.over15}%</div>
                        </div>
                        <div class="prediction-item">
                            <div class="prediction-label">Under 2.5%</div>
                            <div class="prediction-value ${getPredictionClass(predictions.under25)}">${predictions.under25}%</div>
                        </div>
                    </div>

                    <div class="multigol-section">
                        <div class="multigol-title">üéØ MULTIGOL PREDICTIONS</div>
                        <div class="multigol-grid">
                            <div class="multigol-item">
                                <div class="prediction-label">MG 1-3 Casa</div>
                                <div class="prediction-value ${getPredictionClass(predictions.mg13Home)}">${predictions.mg13Home}%</div>
                            </div>
                            <div class="multigol-item">
                                <div class="prediction-label">MG 1-3 Ospite</div>
                                <div class="prediction-value ${getPredictionClass(predictions.mg13Away)}">${predictions.mg13Away}%</div>
                            </div>
                            <div class="multigol-item">
                                <div class="prediction-label">MG 2-4 Casa</div>
                                <div class="prediction-value ${getPredictionClass(predictions.mg24Home)}">${predictions.mg24Home}%</div>
                            </div>
                            <div class="multigol-item">
                                <div class="prediction-label">MG 2-4 Ospite</div>
                                <div class="prediction-value ${getPredictionClass(predictions.mg24Away)}">${predictions.mg24Away}%</div>
                            </div>
                        </div>
                    </div>

                    <div style="text-align: center;">
                        <div class="recommendation ${recClass}">${predictions.recommendation}</div>
                    </div>
                </div>
            `;
        }

        // Carica partite per una data specifica
        async function loadMatchesForDate(dateStr) {
            const container = document.getElementById('matchesContainer');
            container.innerHTML = '<div class="loading"><div class="spinner"></div><p>Caricamento partite in corso...</p></div>';

            allMatches = [];

            try {
                for (const [leagueName, leagueId] of Object.entries(LEAGUES)) {
                    console.log(`Caricamento ${leagueName}...`);

                    const response = await fetch(
                        `https://v3.football.api-sports.io/fixtures?league=${leagueId}&season=${currentSeason}&date=${dateStr}`,
                        {
                            method: 'GET',
                            headers: {
                                'x-rapidapi-key': API_KEY,
                                'x-rapidapi-host': 'v3.football.api-sports.io'
                            }
                        }
                    );

                    const data = await response.json();
                    console.log(`${leagueName}:`, data.response?.length || 0, 'partite');

                    if (data.response && data.response.length > 0) {
                        for (const match of data.response) {
                            // Calcola xG con statistiche se disponibili
                            let xGHome = 1.5;
                            let xGAway = 1.3;

                            // Prova a ottenere statistiche
                            try {
                                const statsResponse = await fetch(
                                    `https://v3.football.api-sports.io/teams/statistics?league=${leagueId}&season=${currentSeason}&team=${match.teams.home.id}`,
                                    {
                                        method: 'GET',
                                        headers: {
                                            'x-rapidapi-key': API_KEY,
                                            'x-rapidapi-host': 'v3.football.api-sports.io'
                                        }
                                    }
                                );
                                const statsData = await statsResponse.json();
                                if (statsData.response) {
                                    xGHome = calculateXG(statsData.response, true);
                                }
                            } catch (e) {
                                console.log('Statistiche non disponibili, uso default');
                            }

                            const matchData = {
                                homeTeam: match.teams.home.name,
                                awayTeam: match.teams.away.name,
                                league: leagueName,
                                date: new Date(match.fixture.date).toLocaleDateString('it-IT', {
                                    day: '2-digit',
                                    month: '2-digit',
                                    year: 'numeric',
                                    hour: '2-digit',
                                    minute: '2-digit'
                                }),
                                fixtureId: match.fixture.id,
                                xGHome: xGHome,
                                xGAway: xGAway
                            };

                            const predictions = calculatePredictions(matchData);
                            matchData.predictions = predictions;
                            allMatches.push(matchData);
                        }
                    }

                    // Pausa per evitare rate limiting
                    await new Promise(resolve => setTimeout(resolve, 500));
                }

                if (allMatches.length === 0) {
                    container.innerHTML = `
                        <div class="error">
                            ‚ö†Ô∏è Nessuna partita trovata per il ${dateStr}<br><br>
                            Possibili cause:<br>
                            ‚Ä¢ Nessuna partita programmata per questa data<br>
                            ‚Ä¢ Prova con un'altra data (Oggi/Domani)<br>
                            ‚Ä¢ Verifica la tua API key<br>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = `<div class="success">‚úÖ ${allMatches.length} partite caricate con successo!</div>`;

                updateStats();
                renderMatches();
                populateLeagueFilter();

            } catch (error) {
                console.error('Errore:', error);
                container.innerHTML = `<div class="error">‚ùå Errore nel caricamento: ${error.message}<br><br>Verifica la console per dettagli.</div>`;
            }
        }

        // Carica partite di oggi
        async function loadMatches() {
            const today = new Date().toISOString().split('T')[0];
            console.log('Data di oggi:', today);
            await loadMatchesForDate(today);
        }

        // Carica partite di domani
        async function loadMatchesTomorrow() {
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const dateStr = tomorrow.toISOString().split('T')[0];
            console.log('Data di domani:', dateStr);
            await loadMatchesForDate(dateStr);
        }

        // Renderizza tutte le partite
        function renderMatches() {
            const container = document.getElementById('matchesContainer');
            if (allMatches.length > 0) {
                container.innerHTML = allMatches.map(match => 
                    renderMatch(match, match.predictions)
                ).join('');
            }
        }

        // Aggiorna statistiche
        function updateStats() {
            document.getElementById('totalMatches').textContent = allMatches.length;
            document.getElementById('betStrong').textContent = 
                allMatches.filter(m => m.predictions.recommendation.includes('STRONG')).length;
            document.getElementById('betRecommended').textContent = 
                allMatches.filter(m => m.predictions.recommendation.includes('‚úÖ')).length;
        }

        // Popola filtro leghe
        function populateLeagueFilter() {
            const select = document.getElementById('leagueFilter');
            const leagues = [...new Set(allMatches.map(m => m.league))];
            select.innerHTML = '<option value="">Tutte le Leghe</option>' +
                leagues.map(l => `<option value="${l}">${l}</option>`).join('');
        }

        // Filtra partite
        function filterMatches() {
            const league = document.getElementById('leagueFilter').value;
            const confidence = document.getElementById('confidenceFilter').value;
            const search = document.getElementById('searchInput').value.toLowerCase();

            let filtered = allMatches;

            if (league) {
                filtered = filtered.filter(m => m.league === league);
            }

            if (confidence === 'high') {
                filtered = filtered.filter(m => m.predictions.confidence > 75);
            } else if (confidence === 'medium') {
                filtered = filtered.filter(m => m.predictions.confidence >= 60 && m.predictions.confidence <= 75);
            } else if (confidence === 'low') {
                filtered = filtered.filter(m => m.predictions.confidence < 60);
            }

            if (search) {
                filtered = filtered.filter(m => 
                    m.homeTeam.toLowerCase().includes(search) || 
                    m.awayTeam.toLowerCase().includes(search)
                );
            }

            const container = document.getElementById('matchesContainer');
            if (filtered.length > 0) {
                container.innerHTML = filtered.map(match => 
                    renderMatch(match, match.predictions)
                ).join('');
            } else {
                container.innerHTML = '<div class="error">Nessuna partita trovata con i filtri selezionati</div>';
            }
        }

        // Reset tutto
        function clearAll() {
            if (confirm('Vuoi resettare tutto?')) {
                allMatches = [];
                document.getElementById('matchesContainer').innerHTML = `
                    <div class="loading">
                        <p>Reset completato! Premi "Carica Partite" per ricominciare</p>
                    </div>
                `;
                updateStats();
            }
        }

        // Export CSV
        function exportToExcel() {
            if (allMatches.length === 0) {
                alert('‚ö†Ô∏è Carica prima le partite!');
                return;
            }

            let csv = 'Match,Lega,Data,GG%,Over2.5%,MG1-3Casa%,MG1-3Ospite%,MG2-4Casa%,MG2-4Ospite%,Confidence,Consiglio\n';

            allMatches.forEach(match => {
                const p = match.predictions;
                csv += `"${match.homeTeam} vs ${match.awayTeam}",${match.league},"${match.date}",${p.gg},${p.over25},${p.mg13Home},${p.mg13Away},${p.mg24Home},${p.mg24Away},${p.confidence},"${p.recommendation}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `prophecy_hunter_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();

            alert('‚úÖ Export completato!');
        }

        // Log iniziale
        window.addEventListener('load', () => {
            console.log('üöÄ Prophecy Hunter Elite v3.1 caricato!');
            console.log('üìÖ Data corrente:', new Date().toISOString().split('T')[0]);
            console.log('üèÜ Stagione:', currentSeason, '-', currentSeason + 1);
            console.log('üîë API Key:', API_KEY ? 'Configurata ‚úÖ' : 'Mancante ‚ùå');
        });
    </script>
</body>
</html>
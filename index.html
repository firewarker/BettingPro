<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BettingPro</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;800&display=swap');

    * { 
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Poppins', sans-serif;
    }

    body { 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    .card {
      background: white;
      border-radius: 20px;
      padding: 30px;
      margin-bottom: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }

    .logo {
      font-size: 3rem;
      font-weight: 800;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-align: center;
      margin-bottom: 10px;
    }

    .subtitle {
      text-align: center;
      color: white;
      font-size: 1.2rem;
      margin-bottom: 30px;
    }

    .btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px 30px;
      border-radius: 10px;
      border: none;
      font-weight: 700;
      cursor: pointer;
      font-size: 1rem;
      transition: all 0.3s;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
    }

    .match-item {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 15px;
      margin-bottom: 15px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .match-item:hover {
      background: #e9ecef;
      transform: translateX(5px);
    }

    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 5px;
    }

    .green { background: #10b981; }
    .red { background: #ef4444; }

    .loader {
      border: 5px solid rgba(255,255,255,0.3);
      border-top: 5px solid #667eea;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 30px auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .prediction {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 25px;
      border-radius: 15px;
      margin-bottom: 15px;
    }

    .stat-box {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 15px;
      margin-bottom: 15px;
    }
  </style>
</head>
<body>
  <div id="app"></div>

<script>
// ============================================
// BETTINGPRO - VERSIONE FUNZIONANTE
// ============================================

console.log('üöÄ BettingPro started');

// CONFIG
const API_KEY = 'aeb2864a3d4dbb8395fa53c83a876a93';
const API_HOST = 'v3.football.api-sports.io';
const API_BASE = 'https://v3.football.api-sports.io';

// STATE
let state = {
  view: 'home',
  leagues: [],
  matches: [],
  selectedMatch: null,
  analysis: null,
  loading: false,
  error: null,
  apiOk: false
};

// UTILS
function esc(str) {
  const div = document.createElement('div');
  div.textContent = str || '';
  return div.innerHTML;
}

function formatDate(dateStr) {
  if (!dateStr) return { date: '-', time: '-' };
  const d = new Date(dateStr);
  const date = d.toLocaleDateString('it-IT');
  const time = d.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
  return { date, time };
}

// API CALL
async function apiCall(endpoint, params) {
  const url = new URL(API_BASE + endpoint);
  if (params) {
    Object.keys(params).forEach(key => url.searchParams.append(key, params[key]));
  }

  try {
    console.log('API call:', endpoint);
    const res = await fetch(url, {
      headers: {
        'x-rapidapi-key': API_KEY,
        'x-rapidapi-host': API_HOST
      }
    });

    if (!res.ok) throw new Error('HTTP ' + res.status);

    const data = await res.json();
    console.log('API OK:', data);
    state.apiOk = true;
    return data;

  } catch (err) {
    console.error('API error:', err);
    state.apiOk = false;
    throw err;
  }
}

// LOAD LEAGUES
async function loadLeagues() {
  state.loading = true;
  state.error = null;
  render();

  try {
    const data = await apiCall('/leagues', {});

    if (data && data.response) {
      state.leagues = data.response
        .filter(l => l.league && l.league.type === 'League')
        .slice(0, 30)
        .map(l => ({
          id: l.league.id,
          name: l.league.name,
          country: l.country.name,
          logo: l.league.logo,
          season: 2025
        }));

      console.log('Leagues loaded:', state.leagues.length);
    }
  } catch (err) {
    state.error = 'Errore caricamento campionati';
  }

  state.loading = false;
  render();
}

// LOAD MATCHES
async function loadMatches(leagueId) {
  state.loading = true;
  state.view = 'matches';
  state.error = null;
  render();

  try {
    const data = await apiCall('/fixtures', {
      league: leagueId,
      season: 2025,
      next: 20
    });

    if (data && data.response) {
      state.matches = data.response.map(f => ({
        id: f.fixture.id,
        date: f.fixture.date,
        home: {
          id: f.teams.home.id,
          name: f.teams.home.name,
          logo: f.teams.home.logo
        },
        away: {
          id: f.teams.away.id,
          name: f.teams.away.name,
          logo: f.teams.away.logo
        },
        league: state.leagues.find(l => l.id == leagueId)
      }));

      console.log('Matches loaded:', state.matches.length);
    }
  } catch (err) {
    state.error = 'Errore caricamento partite';
  }

  state.loading = false;
  render();
}

// ANALYZE MATCH
async function analyzeMatch(matchIndex) {
  const match = state.matches[matchIndex];
  state.selectedMatch = match;
  state.loading = true;
  state.view = 'analysis';
  state.error = null;
  render();

  try {
    // Get predictions
    let predictions = null;
    try {
      const data = await apiCall('/predictions', { fixture: match.id });
      if (data && data.response && data.response[0]) {
        predictions = data.response[0];
      }
    } catch (e) {
      console.warn('Predictions not available');
    }

    // Calculate analysis
    const analysis = generateAnalysis(match, predictions);
    state.analysis = analysis;

    console.log('Analysis complete');

  } catch (err) {
    state.error = 'Errore analisi';
  }

  state.loading = false;
  render();
}

// GENERATE ANALYSIS
function generateAnalysis(match, predictions) {
  let homeXg = 1.4;
  let awayXg = 1.1;

  if (predictions && predictions.predictions && predictions.predictions.goals) {
    const goals = predictions.predictions.goals;
    if (goals.home) homeXg = parseFloat(goals.home.split('-')[0]) || homeXg;
    if (goals.away) awayXg = parseFloat(goals.away.split('-')[0]) || awayXg;
  }

  const total = homeXg + awayXg;
  const homeWin = (homeXg / total) * 100;
  const awayWin = (awayXg / total) * 100;
  const draw = 100 - homeWin - awayWin;

  const btts = total > 2.5 ? 65 : 35;
  const over25 = total > 2.5 ? 70 : 30;

  const predList = [];

  if (homeWin > awayWin && homeWin > draw) {
    predList.push({
      market: '1X2',
      bet: '1 (Casa)',
      desc: match.home.name + ' vince',
      prob: homeWin.toFixed(0),
      conf: Math.min(85, 50 + (homeWin - 33)).toFixed(0)
    });
  } else if (awayWin > homeWin && awayWin > draw) {
    predList.push({
      market: '1X2',
      bet: '2 (Trasferta)',
      desc: match.away.name + ' vince',
      prob: awayWin.toFixed(0),
      conf: Math.min(85, 50 + (awayWin - 33)).toFixed(0)
    });
  } else {
    predList.push({
      market: '1X2',
      bet: 'X (Pareggio)',
      desc: 'Finisce in pareggio',
      prob: draw.toFixed(0),
      conf: Math.min(75, 50 + (draw - 33)).toFixed(0)
    });
  }

  predList.push({
    market: 'Goal/NoGoal',
    bet: btts >= 50 ? 'GG' : 'NG',
    desc: btts >= 50 ? 'Entrambe segnano' : 'Almeno una non segna',
    prob: btts >= 50 ? btts : (100 - btts),
    conf: Math.min(85, 50 + Math.abs(btts - 50)).toFixed(0)
  });

  predList.push({
    market: 'Over/Under 2.5',
    bet: over25 >= 50 ? 'Over 2.5' : 'Under 2.5',
    desc: over25 >= 50 ? 'Oltre 2.5 gol' : 'Meno di 2.5 gol',
    prob: over25 >= 50 ? over25 : (100 - over25),
    conf: Math.min(85, 50 + Math.abs(over25 - 50)).toFixed(0)
  });

  predList.push({
    market: 'Risultato Esatto',
    bet: '1-1',
    desc: 'Finale 1-1',
    prob: '18',
    conf: '62'
  });

  predList.push({
    market: 'Risultato Esatto',
    bet: '2-1',
    desc: 'Finale 2-1',
    prob: '15',
    conf: '58'
  });

  return {
    xG: { home: homeXg, away: awayXg, total },
    prob1X2: { home: homeWin, draw, away: awayWin },
    predictions: predList,
    hasApi: !!predictions
  };
}

// NAVIGATION
function goHome() {
  state.view = 'home';
  state.selectedMatch = null;
  state.analysis = null;
  render();
}

function goMatches(leagueId) {
  loadMatches(leagueId);
}

function goAnalysis(index) {
  analyzeMatch(index);
}

// RENDER
function render() {
  const app = document.getElementById('app');

  if (state.view === 'home') {
    app.innerHTML = renderHome();
  } else if (state.view === 'matches') {
    app.innerHTML = renderMatches();
  } else if (state.view === 'analysis') {
    app.innerHTML = renderAnalysis();
  }
}

function renderHome() {
  return `
    <div class="container">
      <h1 class="logo">BettingPro</h1>
      <p class="subtitle">Elite Betting Analysis</p>

      <div class="card">
        <div style="margin-bottom: 20px;">
          <span class="status-dot ${state.apiOk ? 'green' : 'red'}"></span>
          <span style="font-weight: 600;">API Status: ${state.apiOk ? 'Connesso' : 'Disconnesso'}</span>
        </div>

        <h2 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 20px;">üìã Campionati</h2>

        ${state.loading ? `
          <div class="loader"></div>
          <p style="text-align: center; color: #666;">Caricamento...</p>
        ` : state.leagues.length === 0 ? `
          <div style="text-align: center; padding: 40px 0;">
            <p style="font-size: 1.2rem; color: #666; margin-bottom: 20px;">üëã Benvenuto!</p>
            <button onclick="loadLeagues()" class="btn">üöÄ Carica Campionati</button>
          </div>
        ` : `
          <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px;">
            ${state.leagues.map(l => `
              <div onclick="goMatches(${l.id})" class="match-item">
                <div style="font-weight: 700; font-size: 1.1rem; margin-bottom: 5px;">${esc(l.name)}</div>
                <div style="color: #666; font-size: 0.9rem;">${esc(l.country)}</div>
              </div>
            `).join('')}
          </div>
        `}

        ${state.error ? `
          <div style="background: #fee; border: 2px solid #f88; border-radius: 10px; padding: 15px; margin-top: 20px;">
            <p style="color: #c00; font-weight: 600;">${esc(state.error)}</p>
          </div>
        ` : ''}
      </div>
    </div>
  `;
}

function renderMatches() {
  return `
    <div class="container">
      <button onclick="goHome()" class="btn" style="margin-bottom: 20px;">‚Üê Indietro</button>

      <div class="card">
        <h2 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 20px;">‚öΩ Partite</h2>

        ${state.loading ? `
          <div class="loader"></div>
          <p style="text-align: center; color: #666;">Caricamento partite...</p>
        ` : state.matches.length === 0 ? `
          <p style="text-align: center; color: #666; padding: 40px 0;">Nessuna partita disponibile</p>
        ` : `
          ${state.matches.map((m, i) => {
            const dt = formatDate(m.date);
            return `
              <div onclick="goAnalysis(${i})" class="match-item">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                  <span style="font-size: 0.8rem; color: #666; font-weight: 600;">${dt.date} ${dt.time}</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <div style="font-weight: 700;">${esc(m.home.name)}</div>
                  <div style="color: #999; font-weight: 700;">vs</div>
                  <div style="font-weight: 700;">${esc(m.away.name)}</div>
                </div>
              </div>
            `;
          }).join('')}
        `}
      </div>
    </div>
  `;
}

function renderAnalysis() {
  const m = state.selectedMatch;
  const a = state.analysis;

  if (!m || !a) return '<div class="container"><p>Errore</p></div>';

  return `
    <div class="container">
      <button onclick="state.view='matches'; render();" class="btn" style="margin-bottom: 20px;">‚Üê Partite</button>

      <div class="card">
        <h2 style="font-size: 1.8rem; font-weight: 700; text-align: center; margin-bottom: 20px;">
          ${esc(m.home.name)} <span style="color: #667eea;">vs</span> ${esc(m.away.name)}
        </h2>

        ${a.hasApi ? `
          <div style="background: #d1fae5; border-radius: 10px; padding: 10px; text-align: center; margin-bottom: 20px;">
            <span style="color: #065f46; font-weight: 700;">‚úÖ Dati API-Football Caricati</span>
          </div>
        ` : ''}

        <div class="stat-box">
          <h3 style="font-weight: 700; margin-bottom: 15px;">üìä Expected Goals (xG)</h3>
          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; text-align: center;">
            <div>
              <div style="font-size: 0.9rem; color: #666; margin-bottom: 5px;">Casa</div>
              <div style="font-size: 2.5rem; font-weight: 800; color: #667eea;">${a.xG.home.toFixed(2)}</div>
            </div>
            <div>
              <div style="font-size: 0.9rem; color: #666; margin-bottom: 5px;">Totale</div>
              <div style="font-size: 2.5rem; font-weight: 800; color: #333;">${a.xG.total.toFixed(2)}</div>
            </div>
            <div>
              <div style="font-size: 0.9rem; color: #666; margin-bottom: 5px;">Trasferta</div>
              <div style="font-size: 2.5rem; font-weight: 800; color: #764ba2;">${a.xG.away.toFixed(2)}</div>
            </div>
          </div>
        </div>

        <div class="stat-box">
          <h3 style="font-weight: 700; margin-bottom: 15px;">üìà Probabilit√† 1X2</h3>
          <div style="margin-bottom: 10px;">
            <div style="display: flex; justify-between; margin-bottom: 5px;">
              <span style="font-weight: 600;">1 (Casa)</span>
              <span style="font-weight: 700; color: #667eea;">${a.prob1X2.home.toFixed(0)}%</span>
            </div>
            <div style="background: #e5e7eb; height: 10px; border-radius: 10px; overflow: hidden;">
              <div style="background: linear-gradient(90deg, #667eea, #764ba2); height: 100%; width: ${a.prob1X2.home}%;"></div>
            </div>
          </div>
          <div style="margin-bottom: 10px;">
            <div style="display: flex; justify-between; margin-bottom: 5px;">
              <span style="font-weight: 600;">X (Pareggio)</span>
              <span style="font-weight: 700; color: #667eea;">${a.prob1X2.draw.toFixed(0)}%</span>
            </div>
            <div style="background: #e5e7eb; height: 10px; border-radius: 10px; overflow: hidden;">
              <div style="background: linear-gradient(90deg, #667eea, #764ba2); height: 100%; width: ${a.prob1X2.draw}%;"></div>
            </div>
          </div>
          <div>
            <div style="display: flex; justify-between; margin-bottom: 5px;">
              <span style="font-weight: 600;">2 (Trasferta)</span>
              <span style="font-weight: 700; color: #667eea;">${a.prob1X2.away.toFixed(0)}%</span>
            </div>
            <div style="background: #e5e7eb; height: 10px; border-radius: 10px; overflow: hidden;">
              <div style="background: linear-gradient(90deg, #667eea, #764ba2); height: 100%; width: ${a.prob1X2.away}%;"></div>
            </div>
          </div>
        </div>

        <h3 style="font-weight: 700; font-size: 1.5rem; margin-bottom: 20px; text-align: center;">üéØ PRONOSTICI</h3>

        ${a.predictions.map(p => `
          <div class="prediction">
            <div style="font-size: 0.8rem; opacity: 0.8; margin-bottom: 5px;">${esc(p.market)}</div>
            <div style="font-size: 1.5rem; font-weight: 800; margin-bottom: 5px;">${esc(p.bet)}</div>
            <div style="font-size: 0.95rem; opacity: 0.9; margin-bottom: 10px;">${esc(p.desc)}</div>
            <div style="display: flex; justify-content: space-between;">
              <div>
                <div style="font-size: 0.75rem; opacity: 0.7;">Probabilit√†</div>
                <div style="font-size: 1.2rem; font-weight: 700;">${p.prob}%</div>
              </div>
              <div>
                <div style="font-size: 0.75rem; opacity: 0.7;">Confidence</div>
                <div style="font-size: 1.2rem; font-weight: 700;">${p.conf}%</div>
              </div>
            </div>
          </div>
        `).join('')}
      </div>
    </div>
  `;
}

// INIT
console.log('Initializing...');
render();
console.log('Ready!');

</script>
</body>
</html>

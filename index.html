<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BettingPro - AI Betting Intelligence</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg-dark: #0c1222;
      --bg-card: #141d2f;
      --bg-card-light: #1a2642;
      --bg-input: #0f172a;
      --accent-cyan: #22d3ee;
      --accent-blue: #3b82f6;
      --accent-green: #10b981;
      --accent-yellow: #fbbf24;
      --accent-red: #ef4444;
      --accent-purple: #a855f7;
      --text-white: #ffffff;
      --text-gray: #94a3b8;
      --text-dark: #64748b;
      --border: rgba(255,255,255,0.08);
      --glow-cyan: 0 0 20px rgba(34, 211, 238, 0.3);
      --glow-blue: 0 0 20px rgba(59, 130, 246, 0.3);
    }

    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: Inter, -apple-system, system-ui, sans-serif;
      background: var(--bg-dark);
      background-image:
        radial-gradient(ellipse at top, rgba(34, 211, 238, 0.05) 0%, transparent 50%),
        radial-gradient(ellipse at bottom right, rgba(59, 130, 246, 0.05) 0%, transparent 50%);
      color: var(--text-white);
      min-height: 100vh;
    }

    .header {
      background: rgba(12, 18, 34, 0.9);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--border);
      padding: 16px 32px;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-inner {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 24px;
    }

    .brand { display:flex; align-items:center; gap:14px; }
    .brand-icon {
      width: 44px; height: 44px;
      background: linear-gradient(135deg, var(--accent-cyan) 0%, var(--accent-blue) 100%);
      border-radius: 12px;
      display:flex; align-items:center; justify-content:center;
      font-size: 1.5rem;
      box-shadow: var(--glow-cyan);
    }

    .brand-text { display:flex; flex-direction:column; }
    .brand-name {
      font-size: 1.4rem;
      font-weight: 800;
      background: linear-gradient(135deg, var(--accent-cyan) 0%, var(--accent-blue) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      letter-spacing: -0.5px;
    }
    .brand-tagline {
      font-size: 0.7rem;
      color: var(--text-dark);
      letter-spacing: 1px;
      text-transform: uppercase;
    }

    .status-bar { display:flex; gap:20px; flex-wrap:wrap; justify-content:flex-end; }
    .status-item { display:flex; align-items:center; gap:8px; font-size:0.75rem; color: var(--text-dark); }
    .status-dot { width: 8px; height:8px; border-radius:50%; background: var(--text-dark); transition: all 0.3s; }
    .status-dot.online { background: var(--accent-green); box-shadow: 0 0 8px var(--accent-green); }
    .status-dot.loading { background: var(--accent-yellow); animation: blink 1s infinite; }
    @keyframes blink { 0%,100%{opacity:1} 50%{opacity:.3} }

    .main { max-width: 1400px; margin: 0 auto; padding: 32px; }

    .search-panel {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 28px;
      margin-bottom: 32px;
    }

    .search-row { display:flex; gap:16px; margin-bottom: 20px; flex-wrap:wrap; }
    .search-field { flex: 1; min-width: 260px; position:relative; }
    .search-icon { position:absolute; left:18px; top:50%; transform: translateY(-50%); font-size:1.2rem; opacity:0.5; }
    .search-input {
      width: 100%;
      padding: 16px 20px 16px 52px;
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: 14px;
      color: var(--text-white);
      font-size: 1rem;
      transition: all 0.3s;
    }
    .search-input:focus { outline:none; border-color: var(--accent-cyan); box-shadow: 0 0 0 3px rgba(34, 211, 238, 0.15); }
    .search-input::placeholder { color: var(--text-dark); }

    .select-field {
      padding: 16px 20px;
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: 14px;
      color: var(--text-white);
      font-size: 1rem;
      min-width: 260px;
      cursor: pointer;
    }

    .filter-row { display:flex; gap:12px; flex-wrap:wrap; }
    .filter-btn {
      padding: 10px 20px;
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: 10px;
      color: var(--text-gray);
      font-size: 0.85rem;
      font-weight: 600;
      cursor:pointer;
      transition: all 0.2s;
      user-select:none;
    }
    .filter-btn:hover { border-color: var(--accent-cyan); color: var(--text-white); }
    .filter-btn.active {
      background: linear-gradient(135deg, rgba(34, 211, 238, 0.2) 0%, rgba(59, 130, 246, 0.2) 100%);
      border-color: var(--accent-cyan);
      color: var(--accent-cyan);
    }

    .matches-container {
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
      gap: 20px;
    }

    .match-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 18px;
      overflow:hidden;
      cursor:pointer;
      transition: all 0.3s;
      position: relative;
    }
    .match-card::before {
      content:'';
      position:absolute; top:0; left:0; right:0;
      height:3px;
      background: linear-gradient(90deg, var(--accent-cyan), var(--accent-blue));
      opacity:0;
      transition: opacity .3s;
    }
    .match-card:hover {
      transform: translateY(-6px);
      border-color: var(--accent-cyan);
      box-shadow: 0 20px 50px rgba(0,0,0,0.3), var(--glow-cyan);
    }
    .match-card:hover::before { opacity:1; }

    .match-card-header {
      padding: 16px 20px;
      background: var(--bg-card-light);
      display:flex;
      justify-content: space-between;
      align-items:center;
      gap: 12px;
    }

    .match-league-info { display:flex; flex-direction:column; gap:2px; min-width:0; }
    .match-country {
      font-size: 0.7rem;
      color: var(--text-dark);
      text-transform: uppercase;
      letter-spacing: 1px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .match-league {
      font-size: 0.9rem;
      font-weight: 700;
      color: var(--text-white);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .match-badge {
      padding: 6px 14px;
      border-radius: 8px;
      font-size: 0.75rem;
      font-weight: 800;
      font-family: "JetBrains Mono", monospace;
      white-space:nowrap;
    }
    .match-badge.live {
      background: linear-gradient(135deg, var(--accent-red), #dc2626);
      color: white;
      animation: pulse-badge 2s infinite;
    }
    @keyframes pulse-badge {
      0%,100%{ box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.5); }
      50%{ box-shadow: 0 0 0 8px rgba(239, 68, 68, 0); }
    }
    .match-badge.scheduled {
      background: var(--bg-input);
      color: var(--text-gray);
      border: 1px solid var(--border);
    }

    .match-card-body { padding: 24px 20px; }
    .match-teams { display:flex; align-items:center; justify-content:space-between; gap: 12px; }
    .match-team { flex:1; display:flex; flex-direction:column; align-items:center; gap: 12px; text-align:center; }

    .team-logo { width: 52px; height:52px; object-fit: contain; }
    .team-logo-fallback {
      width: 52px; height:52px;
      background: linear-gradient(135deg, var(--accent-cyan), var(--accent-blue));
      border-radius: 14px;
      display:flex; align-items:center; justify-content:center;
      font-weight: 800;
      font-size: 0.9rem;
    }

    .team-name { font-size: 0.92rem; font-weight: 700; max-width: 160px; }
    .match-center { display:flex; flex-direction:column; align-items:center; gap:4px; padding: 0 8px; }
    .match-score {
      font-family: "JetBrains Mono", monospace;
      font-size: 1.8rem;
      font-weight: 800;
      color: var(--text-white);
    }
    .match-vs {
      font-size: 0.8rem;
      color: var(--text-dark);
      text-transform: uppercase;
      letter-spacing: 2px;
    }

    .analysis-view { animation: slideIn 0.5s ease; }
    @keyframes slideIn { from{opacity:0; transform: translateY(30px)} to{opacity:1; transform:translateY(0)} }

    .back-link {
      display:inline-flex;
      align-items:center;
      gap: 10px;
      padding: 12px 24px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      color: var(--text-gray);
      font-size: 0.9rem;
      font-weight: 700;
      cursor:pointer;
      transition: all .2s;
      margin-bottom: 28px;
      user-select:none;
    }
    .back-link:hover { background: var(--bg-card-light); color: var(--accent-cyan); border-color: var(--accent-cyan); }

    .analysis-hero {
      background: linear-gradient(145deg, var(--bg-card) 0%, var(--bg-card-light) 100%);
      border: 1px solid var(--border);
      border-radius: 24px;
      padding: 40px;
      margin-bottom: 28px;
      position: relative;
      overflow:hidden;
    }
    .analysis-hero::before{
      content:'';
      position:absolute; inset:0;
      background:
        radial-gradient(circle at 20% 20%, rgba(34, 211, 238, 0.1) 0%, transparent 40%),
        radial-gradient(circle at 80% 80%, rgba(59, 130, 246, 0.1) 0%, transparent 40%);
      pointer-events:none;
    }

    .hero-league { text-align:center; font-size: 0.9rem; color: var(--text-dark); margin-bottom: 32px; position:relative; }
    .hero-match { display:flex; align-items:center; justify-content:center; gap: 48px; margin-bottom: 18px; position:relative; }
    .hero-team { display:flex; flex-direction:column; align-items:center; gap: 16px; }
    .hero-team-logo { width: 80px; height: 80px; object-fit: contain; }
    .hero-team-logo-fallback {
      width: 80px; height: 80px;
      background: linear-gradient(135deg, var(--accent-cyan), var(--accent-blue));
      border-radius: 20px;
      display:flex; align-items:center; justify-content:center;
      font-weight: 900;
      font-size: 1.3rem;
    }
    .hero-team-name { font-size: 1.3rem; font-weight: 900; }
    .hero-prediction { display:flex; align-items:center; gap: 12px; }
    .hero-score-box {
      width: 72px; height: 72px;
      background: var(--bg-input);
      border: 2px solid var(--accent-cyan);
      border-radius: 16px;
      display:flex; align-items:center; justify-content:center;
      font-family: "JetBrains Mono", monospace;
      font-size: 2.2rem;
      font-weight: 900;
      box-shadow: var(--glow-cyan);
    }
    .hero-time-badge {
      padding: 10px 18px;
      background: linear-gradient(135deg, var(--accent-cyan), var(--accent-blue));
      border-radius: 10px;
      font-weight: 900;
      font-size: 0.9rem;
      color: white;
    }
    .hero-footer { text-align:center; font-size: 0.85rem; color: var(--text-dark); position:relative; margin-top: 12px; }
    .hero-footer span { color: var(--accent-cyan); font-weight: 800; }

    .analysis-grid { display:grid; grid-template-columns: repeat(2, 1fr); gap: 24px; margin-bottom: 28px; }
    .analysis-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 28px;
    }
    .analysis-card.wide { grid-column: 1 / -1; }

    .card-title { display:flex; align-items:center; gap:12px; margin-bottom: 20px; }
    .card-title-icon {
      width: 40px; height: 40px;
      background: linear-gradient(135deg, rgba(34, 211, 238, 0.2), rgba(59, 130, 246, 0.2));
      border-radius: 12px;
      display:flex; align-items:center; justify-content:center;
      font-size: 1.2rem;
    }
    .card-title-text { font-size: 1.05rem; font-weight: 900; }
    .card-title-badge {
      margin-left:auto;
      padding: 6px 14px;
      background: linear-gradient(135deg, var(--accent-cyan), var(--accent-blue));
      border-radius: 8px;
      font-size: 0.75rem;
      font-weight: 900;
      color: white;
      font-family: "JetBrains Mono", monospace;
    }

    .prob-row { display:flex; align-items:center; gap: 16px; margin-bottom: 16px; }
    .prob-row:last-child { margin-bottom: 0; }
    .prob-label { width: 110px; font-size: 0.9rem; color: var(--text-gray); }
    .prob-bar-track { flex: 1; height: 12px; background: var(--bg-input); border-radius: 6px; overflow:hidden; }
    .prob-bar-fill { height: 100%; border-radius: 6px; transition: width 0.8s ease; }
    .prob-bar-fill.cyan { background: linear-gradient(90deg, var(--accent-cyan), var(--accent-blue)); }
    .prob-bar-fill.green { background: linear-gradient(90deg, var(--accent-green), #34d399); }
    .prob-bar-fill.yellow { background: linear-gradient(90deg, var(--accent-yellow), #fcd34d); }
    .prob-bar-fill.purple { background: linear-gradient(90deg, var(--accent-purple), #c084fc); }
    .prob-value {
      width: 70px;
      text-align:right;
      font-family: "JetBrains Mono", monospace;
      font-size: 0.95rem;
      font-weight: 800;
      color: var(--accent-cyan);
    }

    .stat-grid { display:grid; grid-template-columns: repeat(3, 1fr); gap: 16px; }
    .stat-box { background: var(--bg-card-light); border-radius: 14px; padding: 20px; text-align:center; }
    .stat-box-label { font-size: 0.75rem; color: var(--text-dark); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
    .stat-box-value { font-family: "JetBrains Mono", monospace; font-size: 1.6rem; font-weight: 900; color: var(--accent-cyan); }
    .stat-box-sub { font-size: 0.7rem; color: var(--text-dark); margin-top: 4px; }

    .scores-grid { display:grid; grid-template-columns: repeat(5, 1fr); gap: 12px; }
    .score-box { background: var(--bg-card-light); border-radius: 12px; padding: 16px 12px; text-align:center; transition: all 0.2s; }
    .score-box:hover { background: var(--bg-input); }
    .score-box.highlight { background: linear-gradient(135deg, var(--accent-cyan), var(--accent-blue)); }
    .score-box-value { font-family: "JetBrains Mono", monospace; font-size: 1.1rem; font-weight: 900; }
    .score-box-prob { font-size: 0.7rem; color: var(--text-dark); margin-top: 4px; }
    .score-box.highlight .score-box-prob { color: rgba(255,255,255,0.85); }

    .predictions-panel {
      background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-card-light) 100%);
      border: 1px solid var(--border);
      border-radius: 24px;
      padding: 36px;
      margin-bottom: 28px;
      position:relative;
      overflow:hidden;
    }
    .predictions-panel::before{
      content:'';
      position:absolute; left:0; right:0; top:0;
      height:4px;
      background: linear-gradient(90deg, var(--accent-cyan), var(--accent-blue), var(--accent-purple));
    }

    .predictions-header { text-align:center; margin-bottom: 28px; position:relative; }
    .predictions-title {
      font-size: 1.6rem;
      font-weight: 900;
      margin-bottom: 8px;
      background: linear-gradient(135deg, var(--accent-cyan) 0%, var(--accent-blue) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .predictions-subtitle { font-size: 0.9rem; color: var(--text-dark); }

    .predictions-grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 18px; position:relative; }
    .prediction-card {
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      text-align:center;
      transition: all 0.3s;
    }
    .prediction-card:hover { border-color: var(--accent-cyan); transform: translateY(-4px); box-shadow: var(--glow-cyan); }
    .prediction-market { font-size: 0.7rem; color: var(--text-dark); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; }
    .prediction-value { font-size: 1.5rem; font-weight: 900; margin-bottom: 12px; }
    .prediction-prob {
      display:inline-flex; align-items:center; gap: 6px;
      padding: 6px 16px;
      background: linear-gradient(135deg, rgba(34, 211, 238, 0.2), rgba(59, 130, 246, 0.2));
      border-radius: 20px;
      font-family: "JetBrains Mono", monospace;
      font-size: 0.9rem;
      font-weight: 900;
      color: var(--accent-cyan);
    }
    .prediction-reasoning { margin-top: 12px; font-size: 0.75rem; color: var(--text-dark); }

    .card-insight{
      margin-top: 14px;
      font-size: 0.82rem;
      color: var(--text-dark);
      line-height: 1.45;
    }

    .actions-row { display:flex; gap:16px; justify-content:center; flex-wrap:wrap; }
    .btn {
      padding: 16px 36px;
      border: none;
      border-radius: 14px;
      font-size: 1rem;
      font-weight: 900;
      cursor:pointer;
      transition: all .2s;
      font-family: inherit;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap: 10px;
    }
    .btn-primary { background: linear-gradient(135deg, var(--accent-cyan), var(--accent-blue)); color:white; }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: var(--glow-cyan); }
    .btn-secondary { background: var(--bg-card); border: 1px solid var(--border); color: var(--text-white); }
    .btn-secondary:hover { background: var(--bg-card-light); border-color: var(--accent-cyan); }

    .loading-state { display:flex; flex-direction:column; align-items:center; justify-content:center; padding: 100px 20px; }
    .spinner {
      width: 56px; height: 56px;
      border: 4px solid var(--border);
      border-top-color: var(--accent-cyan);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 24px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loading-text { font-size: 1rem; color: var(--text-gray); }

    .empty-state { text-align:center; padding: 100px 20px; }
    .empty-icon { font-size: 4rem; margin-bottom: 20px; opacity: 0.5; }
    .empty-text { font-size: 1.1rem; color: var(--text-dark); }

    .error-box {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid var(--accent-red);
      border-radius: 14px;
      padding: 18px 24px;
      margin-bottom: 24px;
      color: var(--accent-red);
      font-size: 0.9rem;
      font-weight: 700;
    }

    @media (max-width: 1024px) {
      .matches-container { grid-template-columns: 1fr; }
      .analysis-grid { grid-template-columns: 1fr; }
    }
    @media (max-width: 768px) {
      .main { padding: 20px; }
      .header { padding: 14px 20px; }
      .hero-match { flex-direction:column; gap: 24px; }
      .scores-grid { grid-template-columns: repeat(3, 1fr); }
      .predictions-grid { grid-template-columns: 1fr; }
      .btn { width: 100%; }
    }
  </style>
</head>

<body>
  <div id="app"></div>

  <script type="module">
    console.log('BettingPro v3.0 - Starting...');
    // CONFIG
    const CONFIG = {
      APIFOOTBALL: {
        key: 'aeb2864a3d4dbb8395fa53c83a876a93',
        baseURL: 'https://v3.football.api-sports.io',
        proxyURL: 'https://corsproxy.io/?'
      },
      FOOTYSTATS: {
        key: 'aeb2864a3d4dbb8395fa53c83a876a93',
        baseURL: 'https://api.footystats.org',
        proxyURL: 'https://corsproxy.io/?'
      },
      FIREBASE: {
        dbURL: 'https://bettingpro-d0125-default-rtdb.europe-west1.firebasedatabase.app/'
      }
    };

    // STATE
    let state = {
      view: 'home',
      matches: [],
      filteredMatches: [],
      leagues: [],
      selectedLeague: '',
      searchQuery: '',
      filters: { live: true, upcoming: true, finished: false },
      selectedMatch: null,
      analysisData: null,
      loading: { matches: false, analysis: false },
      api: { football: 'offline', footystats: 'offline', firebase: 'offline' },
      footyStatsTeams: new Map(),
      error: null
    };

    // Expose state globally for debugging
    window.state = state;

    // UTILITIES
    const esc = (t) =>
      String(t ?? '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/\"/g, '&quot;')
        .replace(/'/g, '&#039;');

    let searchTimeout = null;
    const debounce = (fn, delay) => (...args) => {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => fn(...args), delay);
    };

    const formatTime = (d) => {
      if (!d) return '--:--';
      const date = new Date(d);
      return date.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
    };

    const formatDate = (d) => {
      if (!d) return '--/--';
      const date = new Date(d);
      return date.toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit' });
    };

    const getInitials = (name) => {
      if (!name) return '??';
      return name.split(' ').map(w => w[0]).join('').substring(0, 3).toUpperCase();
    };

    const normalizeStr = (s) =>
      (s || '')
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/[^a-z0-9 ]/g, ' ')
        .replace(/\s+/g, ' ')
        .trim();

    function sortMatchesAlpha(matches) {
      return [...matches].sort((a, b) => {
        const ka = `${normalizeStr(a.home?.name)} vs ${normalizeStr(a.away?.name)}`;
        const kb = `${normalizeStr(b.home?.name)} vs ${normalizeStr(b.away?.name)}`;
        const c = ka.localeCompare(kb, 'it');
        if (c !== 0) return c;

        const la = normalizeStr(a.league?.name);
        const lb = normalizeStr(b.league?.name);
        const c2 = la.localeCompare(lb, 'it');
        if (c2 !== 0) return c2;

        return (a.timestamp || 0) - (b.timestamp || 0);
      });
    }

    const clamp = (min, val, max) => Math.max(min, Math.min(max, val));

    const factorial = (n) => {
      if (n <= 1) return 1;
      let r = 1;
      for (let i = 2; i <= n; i++) r *= i;
      return r;
    };

    const poisson = (lambda, k) => {
      if (lambda <= 0) return k === 0 ? 1 : 0;
      return Math.pow(lambda, k) * Math.exp(-lambda) / factorial(k);
    };

    // API CALLS
    async function callAPIFootball(endpoint, params) {
      const url = new URL(CONFIG.APIFOOTBALL.baseURL + endpoint);
      Object.keys(params).forEach(k => url.searchParams.append(k, params[k]));

      state.api.football = 'loading';
      render();

      try {
        console.log('üîå API-Football', endpoint);
        const res = await fetch(CONFIG.APIFOOTBALL.proxyURL + encodeURIComponent(url.toString()), {
          headers: {
            'x-rapidapi-key': CONFIG.APIFOOTBALL.key,
            'x-rapidapi-host': 'v3.football.api-sports.io'
          }
        });

        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();

        state.api.football = 'online';
        console.log('‚úÖ API-Football OK');

        // Cache
        saveCache(endpoint, params, data);

        return data;
      } catch (err) {
        console.error('‚ùå API-Football', err);
        state.api.football = 'offline';

        const cached = await loadCache(endpoint, params);
        if (cached) return cached;

        throw err;
      }
    }

    async function callFootyStats(endpoint, params) {
      const url = new URL(CONFIG.FOOTYSTATS.baseURL + endpoint);
      url.searchParams.append('key', CONFIG.FOOTYSTATS.key);
      Object.keys(params).forEach(k => url.searchParams.append(k, params[k]));

      state.api.footystats = 'loading';
      render();

      try {
        console.log('üîå FootyStats', endpoint);
        const res = await fetch(CONFIG.FOOTYSTATS.proxyURL + encodeURIComponent(url.toString()));

        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();

        if (data.success === false) throw new Error(data.message || 'API Error');

        state.api.footystats = 'online';
        console.log('‚úÖ FootyStats OK', data);

        return data;
      } catch (err) {
        console.error('‚ùå FootyStats', err);
        state.api.footystats = 'offline';
        return null;
      }
    }

    async function saveCache(endpoint, params, data) {
      try {
        const key = btoa(endpoint + JSON.stringify(params)).replace(/[^a-zA-Z0-9]/g, '').slice(0, 80);
        await fetch(CONFIG.FIREBASE.dbURL + `cache/${key}.json`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ data, ts: Date.now() })
        });
        state.api.firebase = 'online';
      } catch (e) {
        state.api.firebase = 'offline';
      }
    }

    async function loadCache(endpoint, params) {
      try {
        const key = btoa(endpoint + JSON.stringify(params)).replace(/[^a-zA-Z0-9]/g, '').slice(0, 80);
        const res = await fetch(CONFIG.FIREBASE.dbURL + `cache/${key}.json`);

        if (!res.ok) return null;
        const cached = await res.json();

        if (cached?.data && (Date.now() - cached.ts < 3600000)) {
          state.api.firebase = 'online';
          return cached.data;
        }
      } catch (e) {}
      return null;
    }

    // DATA LOADING
    async function loadMatches() {
      state.loading.matches = true;
      state.error = null;
      render();

      try {
        // MODIFICATO: uso from/to con 30 giorni invece di next
        const today = new Date();
        const from = today.toISOString().split('T')[0];
        const toDate = new Date(today);
        toDate.setDate(toDate.getDate() + 30);
        const to = toDate.toISOString().split('T')[0];

        
        // MODIFIED: Robust loading strategy
        const today = new Date().toISOString().split('T')[0];
        let data;

        try {
            console.log("Attempting to load matches for date:", today);
            data = await callAPIFootball('/fixtures', {
                date: today,
                timezone: 'Europe/Rome'
            });
        } catch (e) {
            console.warn("Date load failed, trying fallback...");
        }

        // Fallback: if no data or empty response, load next 30 matches
        if (!data?.response || data.response.length === 0) {
            console.log("No matches found for today, loading upcoming fixtures...");
            data = await callAPIFootball('/fixtures', {
                next: 30,
                timezone: 'Europe/Rome'
            });
        }
    

        if (data?.response) {
          state.matches = data.response.map(f => ({
            id: f.fixture.id,
            date: f.fixture.date,
            timestamp: f.fixture.timestamp,
            status: f.fixture.status.short,
            elapsed: f.fixture.status.elapsed,
            league: {
              id: f.league.id,
              name: f.league.name,
              country: f.league.country,
              logo: f.league.logo,
              season: f.league.season
            },
            home: { id: f.teams.home.id, name: f.teams.home.name, logo: f.teams.home.logo },
            away: { id: f.teams.away.id, name: f.teams.away.name, logo: f.teams.away.logo },
            goals: f.goals
          }));

          // Extract leagues
          const leagueMap = new Map();
          state.matches.forEach(m => leagueMap.set(m.league.id, m.league));
          state.leagues = Array.from(leagueMap.values()).sort((a,b) =>
            normalizeStr(`${a.country} ${a.name}`).localeCompare(normalizeStr(`${b.country} ${b.name}`), 'it')
          );

          state.filteredMatches = sortMatchesAlpha([...state.matches]);
          console.log(`‚úÖ ${state.matches.length} matches loaded`);
        } else {
          state.matches = [];
          state.filteredMatches = [];
        }

        // Try FootyStats
        await loadFootyStatsData();
      } catch (err) {
        console.error('Load error', err);
        state.error = 'Errore di connessione. Riprova tra qualche secondo.';
      } finally {
        state.loading.matches = false;
        render();
      }
    }

    async function loadFootyStatsData() {
      try {
        const leagues = await callFootyStats('/league-list', { chosen_leagues_only: true });
        if (leagues?.data) {
          console.log('‚úÖ FootyStats leagues loaded:', leagues.data.length);
        }

        const todayMatches = await callFootyStats('/todays-matches', {});
        if (todayMatches?.data) {
          todayMatches.data.forEach(m => {
            if (m.home_name && m.away_name) {
              const key1 = `${m.home_name.toLowerCase()}${m.away_name.toLowerCase()}`;
              const key2 = `${m.home_name.toLowerCase().replace(/\s/g, '')}${m.away_name.toLowerCase().replace(/\s/g, '')}`;
              state.footyStatsTeams.set(key1, m);
              state.footyStatsTeams.set(key2, m);

              if (m.id) state.footyStatsTeams.set(`id:${m.id}`, m);
            }
          });
          console.log('‚úÖ FootyStats today matches:', state.footyStatsTeams.size);
        }
      } catch (e) {
        console.warn('FootyStats error', e.message);
      }
    }

    function applyFilters() {
      let result = [...state.matches];

      if (state.searchQuery) {
        const q = state.searchQuery.toLowerCase();
        result = result.filter(m =>
          m.home.name.toLowerCase().includes(q) ||
          m.away.name.toLowerCase().includes(q) ||
          m.league.name.toLowerCase().includes(q) ||
          m.league.country.toLowerCase().includes(q)
        );
      }

      if (state.selectedLeague) {
        result = result.filter(m => m.league.id == state.selectedLeague);
      }

      const liveStatus = ['1H', '2H', 'HT', 'ET', 'P', 'LIVE', 'BT'];
      const finishedStatus = ['FT', 'AET', 'PEN'];

      result = result.filter(m => {
        const isLive = liveStatus.includes(m.status);
        const isFinished = finishedStatus.includes(m.status);
        const isUpcoming = m.status === 'NS';

        if (isLive && !state.filters.live) return false;
        if (isFinished && !state.filters.finished) return false;
        if (isUpcoming && !state.filters.upcoming) return false;

        return true;
      });

      result = sortMatchesAlpha(result);
      state.filteredMatches = result;
      render();
    }

    // ANALYSIS
    async function analyzeMatch(match) {
      state.selectedMatch = match;
      state.view = 'analysis';
      state.loading.analysis = true;
      state.analysisData = null;
      render();

      try {
        let homeStats = null, awayStats = null, h2h = [], apiPred = null;

        // Team stats
        try {
          const [hs, as] = await Promise.all([
            callAPIFootball('/teams/statistics', {
              team: match.home.id,
              league: match.league.id,
              season: match.league.season || 2024
            }),
            callAPIFootball('/teams/statistics', {
              team: match.away.id,
              league: match.league.id,
              season: match.league.season || 2024
            })
          ]);
          homeStats = hs?.response;
          awayStats = as?.response;
        } catch (e) {}

        // H2H
        try {
          const h2hRes = await callAPIFootball('/fixtures/headtohead', {
            h2h: `${match.home.id}-${match.away.id}`,
            last: 10
          });
          h2h = h2hRes?.response || [];
        } catch (e) {}

        // API Predictions
        try {
          const predRes = await callAPIFootball('/predictions', { fixture: match.id });
          apiPred = predRes?.response?.[0];
        } catch (e) {}

        // FootyStats data
        let fsData = null;
        const fsKeys = [
          `${match.home.name.toLowerCase()}${match.away.name.toLowerCase()}`,
          `${match.home.name.toLowerCase().replace(/\s/g, '')}${match.away.name.toLowerCase().replace(/\s/g, '')}`,
          `${match.home.name.split(' ')[0].toLowerCase()}${match.away.name.split(' ')[0].toLowerCase()}`
        ];

        for (const key of fsKeys) {
          if (state.footyStatsTeams.has(key)) {
            fsData = state.footyStatsTeams.get(key);
            console.log('‚úÖ FootyStats match found:', key);
            break;
          }
        }

        state.analysisData = buildAnalysis(match, homeStats, awayStats, h2h, apiPred, fsData);
      } catch (err) {
        console.error('Analysis error', err);
        state.analysisData = buildAnalysis(match, null, null, [], null, null);
      } finally {
        state.loading.analysis = false;
        render();
      }
    }

    function buildAnalysis(match, homeStats, awayStats, h2h, apiPred, fsData) {
      // Base xG
      let homeXG = 1.35, awayXG = 1.05;
      let homeCorners = 5.0, awayCorners = 4.5;
      let homeCards = 1.8, awayCards = 1.9;

      const num = (v, fallback = null) => {
        const n = parseFloat(v);
        return Number.isFinite(n) ? n : fallback;
      };

      const clamp01to4 = (x) => clamp(0.2, x, 4.0);

      // Use API data
      if (homeStats?.goals?.for?.average?.home) homeXG = homeStats.goals.for.average.home;
      if (awayStats?.goals?.for?.average?.away) awayXG = awayStats.goals.for.average.away;

      // FootyStats enhancement
      if (fsData) {
        console.log('üìä FootyStats data', fsData);

        // Goals
        if (fsData.home_ppg) homeXG = (homeXG + 0.5 * fsData.home_ppg) / 1.5;
        if (fsData.away_ppg) awayXG = (awayXG + 0.5 * fsData.away_ppg) / 1.5;

        // xG
        if (fsData.home_xg) homeXG = fsData.home_xg;
        if (fsData.away_xg) awayXG = fsData.away_xg;

        // Corners
        if (fsData.corners_home_avg || fsData.avg_corners_home) homeCorners = fsData.corners_home_avg || fsData.avg_corners_home;
        if (fsData.corners_away_avg || fsData.avg_corners_away) awayCorners = fsData.corners_away_avg || fsData.avg_corners_away;
        if (fsData.home_corners) homeCorners = fsData.home_corners;
        if (fsData.away_corners) awayCorners = fsData.away_corners;

        // Cards
        if (fsData.cards_home_avg || fsData.home_cards) homeCards = fsData.cards_home_avg || fsData.home_cards;
        if (fsData.cards_away_avg || fsData.away_cards) awayCards = fsData.cards_away_avg || fsData.away_cards;
      }

      // Matchup-based xG: attacco vs difesa (se disponibili)
      const hGF_home = num(homeStats?.goals?.for?.average?.home, null);
      const hGA_home = num(homeStats?.goals?.against?.average?.home, null);
      const aGF_away = num(awayStats?.goals?.for?.average?.away, null);
      const aGA_away = num(awayStats?.goals?.against?.average?.away, null);

      if (hGF_home != null && aGA_away != null) {
        homeXG = 0.60 * hGF_home + 0.40 * aGA_away;
      }
      if (aGF_away != null && hGA_home != null) {
        awayXG = 0.60 * aGF_away + 0.40 * hGA_home;
      }

      // API predictions come "prior" (non sovrascrive brutalmente)
      const apiHomeG = num(apiPred?.predictions?.goals?.home, null);
      const apiAwayG = num(apiPred?.predictions?.goals?.away, null);
      if (apiHomeG != null) homeXG = 0.65 * homeXG + 0.35 * apiHomeG;
      if (apiAwayG != null) awayXG = 0.65 * awayXG + 0.35 * apiAwayG;

      // Micro-correttivo H2H sul totale goal atteso (solo se ho abbastanza match)
      if (h2h?.length >= 5) {
        const avgGoals = h2h.reduce((s, m) => s + (m.goals?.home || 0) + (m.goals?.away || 0), 0) / h2h.length;
        const tot = homeXG + awayXG;
        if (tot > 0.1) {
          const scale = clamp(0.90, avgGoals / tot, 1.10);
          homeXG *= scale;
          awayXG *= scale;
        }
      }

      // Clamp + vantaggio casa
      homeXG = clamp01to4(homeXG) * 1.08;
      awayXG = clamp01to4(awayXG) * 0.96;

      const totXG = homeXG + awayXG;

      // Calculate all probabilities
      const p1X2 = calc1X2(homeXG, awayXG);
      const pOU = calcOU(homeXG, awayXG);
      const pBTTS = calcBTTS(homeXG, awayXG);
      const exactScores = calcExactScores(homeXG, awayXG);

      // H2H stats
      const h2hInfo = { homeWins: 0, draws: 0, awayWins: 0, totalGoals: 0, matches: h2h.length };
      h2h.forEach(m => {
        const hg = m.goals?.home || 0;
        const ag = m.goals?.away || 0;
        h2hInfo.totalGoals += hg + ag;

        if (m.teams?.home?.id == match.home.id) {
          if (hg > ag) h2hInfo.homeWins++;
          else if (hg < ag) h2hInfo.awayWins++;
          else h2hInfo.draws++;
        } else {
          if (ag > hg) h2hInfo.homeWins++;
          else if (ag < hg) h2hInfo.awayWins++;
          else h2hInfo.draws++;
        }
      });
      h2hInfo.avgGoals = h2hInfo.matches ? (h2hInfo.totalGoals / h2hInfo.matches).toFixed(1) : '2.5';

      // Corner probabilities
      const totalCorners = homeCorners + awayCorners;
      const cornerProbs = {};
      [8.5, 9.5, 10.5, 11.5].forEach(line => {
        const diff = totalCorners - line;
        cornerProbs[line] = {
          over: clamp(15, 50 + diff * 12, 85),
          under: clamp(15, 50 - diff * 12, 85)
        };
      });

      // Card probabilities
      const totalCards = homeCards + awayCards;
      const cardProbs = {};
      [3.5, 4.5, 5.5].forEach(line => {
        const diff = totalCards - line;
        cardProbs[line] = {
          over: clamp(15, 50 + diff * 14, 85),
          under: clamp(15, 50 - diff * 14, 85)
        };
      });

      // Build VALUE predictions
      const predictions = [];

      // 1. Exact score
      predictions.push({
        market: 'Risultato Esatto',
        value: `${exactScores[0].h}-${exactScores[0].a}`,
        prob: exactScores[0].p,
        reason: `Prob. Poisson ${exactScores[0].p.toFixed(1)}%`
      });

      // 2. Alt exact score
      predictions.push({
        market: 'Ris. Esatto Alt.',
        value: `${exactScores[1].h}-${exactScores[1].a}`,
        prob: exactScores[1].p,
        reason: `Seconda opzione ${exactScores[1].p.toFixed(1)}%`
      });

      // 3. Corner total
      const cLine = 9.5;
      const cProb = cornerProbs[cLine];
      predictions.push({
        market: 'Corner Totali',
        value: cProb.over > cProb.under ? `Over ${cLine}` : `Under ${cLine}`,
        prob: Math.max(cProb.over, cProb.under),
        reason: `Media partita: ${totalCorners.toFixed(1)}`
      });

      // 4. Home corners
      const hcLine = Math.round(homeCorners - 0.5);
      predictions.push({
        market: `Corner ${match.home.name.split(' ')[0]}`,
        value: homeCorners > hcLine ? `Over ${hcLine}` : `Under ${hcLine}`,
        prob: 52 + Math.abs(homeCorners - hcLine) * 10,
        reason: `Media casa: ${homeCorners.toFixed(1)}`
      });

      // 5. Total cards
      const cardLine = totalCards > 4 ? 4.5 : 3.5;
      const cardP = cardProbs[cardLine];
      predictions.push({
        market: 'Cartellini Totali',
        value: cardP.over > cardP.under ? `Over ${cardLine}` : `Under ${cardLine}`,
        prob: Math.max(cardP.over, cardP.under),
        reason: `Media: ${totalCards.toFixed(1)} cartellini`
      });

      // 6. Multigol
      let mgRange, mgProb;
      if (totXG < 2.0) {
        mgRange = '0-2';
        mgProb = pOU[1.5].under * 0.6 + pOU[2.5].under * 0.4;
      } else if (totXG < 2.8) {
        mgRange = '1-3';
        mgProb = 58 + (2.4 - Math.abs(totXG - 2.4)) * 10;
      } else if (totXG < 3.5) {
        mgRange = '2-4';
        mgProb = 55 + (3.0 - Math.abs(totXG - 3.0)) * 8;
      } else {
        mgRange = '3-5';
        mgProb = pOU[2.5].over * 0.5 + pOU[3.5].over * 0.5;
      }
      predictions.push({
        market: 'Multigol',
        value: mgRange,
        prob: clamp(45, mgProb, 72),
        reason: `xG totale ${totXG.toFixed(2)}`
      });

      // 7. GG/NG
      predictions.push({
        market: 'GG/NG',
        value: pBTTS > 50 ? 'GG' : 'NG',
        prob: pBTTS > 50 ? pBTTS : (100 - pBTTS),
        reason: `Prob. GG ${pBTTS.toFixed(0)}%`
      });

      // 8. 1X2
      const max1X2 = Math.max(p1X2.home, p1X2.draw, p1X2.away);
      let res1X2;
      if (p1X2.home === max1X2) res1X2 = '1';
      else if (p1X2.away === max1X2) res1X2 = '2';
      else res1X2 = 'X';

      predictions.push({
        market: 'Esito Finale',
        value: res1X2,
        prob: max1X2,
        reason: res1X2 === '1' ? match.home.name : (res1X2 === '2' ? match.away.name : 'Pareggio')
      });

      const fav =
        (p1X2.home > p1X2.away && p1X2.home > p1X2.draw) ? match.home.name :
        (p1X2.away > p1X2.home && p1X2.away > p1X2.draw) ? match.away.name :
        'Pareggio';

      const insights = {
        xg: `xG totale ${totXG.toFixed(2)}: ritmo atteso ${totXG >= 2.8 ? 'alto' : (totXG <= 2.2 ? 'basso' : 'medio')}.`,
        esito: `Esito pi√π probabile: ${fav}. (1=${p1X2.home.toFixed(0)}% | X=${p1X2.draw.toFixed(0)}% | 2=${p1X2.away.toFixed(0)}%)`,
        gol: `Over 2.5: ${pOU[2.5].over.toFixed(0)}% | Under 2.5: ${pOU[2.5].under.toFixed(0)}% | GG: ${pBTTS.toFixed(0)}%.`,
        h2h: `H2H: ${h2hInfo.matches} match, media goal ${h2hInfo.avgGoals || 'n/d'} (W/D/L: ${h2hInfo.homeWins}/${h2hInfo.draws}/${h2hInfo.awayWins}).`
      };

      return {
        match,
        xG: { home: homeXG, away: awayXG, total: totXG },
        corners: { home: homeCorners, away: awayCorners, total: totalCorners, probs: cornerProbs },
        cards: { home: homeCards, away: awayCards, total: totalCards, probs: cardProbs },
        p1X2,
        pOU,
        pBTTS,
        exactScores: exactScores.slice(0, 10),
        h2h: h2hInfo,
        predictions,
        insights,
        quality: (homeStats && awayStats && fsData) ? 'enhanced' : 'base'
      };
    }

    function calc1X2(lH, lA) {
      let pH = 0, pD = 0, pA = 0;

      for (let i = 0; i < 7; i++) {
        for (let j = 0; j < 7; j++) {
          const p = poisson(lH, i) * poisson(lA, j);
          if (i > j) pH += p;
          else if (i === j) pD += p;
          else pA += p;
        }
      }

      const t = pH + pD + pA;
      return {
        home: (pH / t) * 100,
        draw: (pD / t) * 100,
        away: (pA / t) * 100
      };
    }

    function calcBTTS(lH, lA) {
      return clamp(20, (1 - poisson(lH, 0)) * (1 - poisson(lA, 0)) * 100, 80);
    }

    function calcOU(lH, lA) {
      const result = {};

      [1.5, 2.5, 3.5, 4.5].forEach(line => {
        let pU = 0;
        for (let i = 0; i < 7; i++) {
          for (let j = 0; j < 7; j++) {
            if ((i + j) <= line) {
              pU += poisson(lH, i) * poisson(lA, j);
            }
          }
        }

        result[line] = {
          over: clamp(5, (1 - pU) * 100, 95),
          under: clamp(5, pU * 100, 95)
        };
      });

      return result;
    }

    function calcExactScores(lH, lA) {
      const scores = [];
      for (let i = 0; i < 5; i++) {
        for (let j = 0; j < 5; j++) {
          scores.push({ h: i, a: j, p: poisson(lH, i) * poisson(lA, j) * 100 });
        }
      }
      return scores.sort((a, b) => b.p - a.p);
    }
    // RENDER
    function render() {
      document.getElementById('app').innerHTML = `
        ${renderHeader()}
        <main class="main">
          ${state.view === 'home' ? renderHome() : renderAnalysis()}
        </main>
      `;
      attachEvents();
    }

    function renderHeader() {
      return `
        <header class="header">
          <div class="header-inner">
            <div class="brand">
              <div class="brand-icon">‚öΩ</div>
              <div class="brand-text">
                <span class="brand-name">BettingPro</span>
                <span class="brand-tagline">AI Betting Intelligence</span>
              </div>
            </div>
            <div class="status-bar">
              <div class="status-item">
                <span class="status-dot ${state.api.football === 'online' ? 'online' : (state.api.football === 'loading' ? 'loading' : '')}"></span>
                <span>API-Football</span>
              </div>
              <div class="status-item">
                <span class="status-dot ${state.api.footystats === 'online' ? 'online' : (state.api.footystats === 'loading' ? 'loading' : '')}"></span>
                <span>FootyStats</span>
              </div>
              <div class="status-item">
                <span class="status-dot ${state.api.firebase === 'online' ? 'online' : ''}"></span>
                <span>Cache</span>
              </div>
            </div>
          </div>
        </header>
      `;
    }

    function renderHome() {
      return `
        <div class="search-panel">
          <div class="search-row">
            <div class="search-field">
              <span class="search-icon">üîç</span>
              <input type="text" class="search-input" id="searchInput" placeholder="Cerca squadra, campionato, paese..." value="${esc(state.searchQuery)}">
            </div>
            <select class="select-field" id="leagueSelect">
              <option value="">Tutti i campionati</option>
              ${state.leagues.map(l => `<option value="${l.id}" ${state.selectedLeague == l.id ? 'selected' : ''}>${esc(l.country)} - ${esc(l.name)}</option>`).join('')}
            </select>
          </div>
          <div class="filter-row">
            <div class="filter-btn ${state.filters.live ? 'active' : ''}" data-filter="live">üî¥ Live</div>
            <div class="filter-btn ${state.filters.upcoming ? 'active' : ''}" data-filter="upcoming">‚è±Ô∏è In programma</div>
            <div class="filter-btn ${state.filters.finished ? 'active' : ''}" data-filter="finished">‚úÖ Terminati</div>
          </div>
        </div>

        ${state.error ? `<div class="error-box">${esc(state.error)}</div>` : ''}

        ${state.loading.matches ? `
          <div class="loading-state">
            <div class="spinner"></div>
            <div class="loading-text">Caricamento partite...</div>
          </div>
        ` : (state.filteredMatches.length === 0 ? `
          <div class="empty-state">
            <div class="empty-icon">üì≠</div>
            <div class="empty-text">Nessuna partita trovata</div>
          </div>
        ` : `
          <div class="matches-container">
            ${state.filteredMatches.map(renderMatchCard).join('')}
          </div>
        `)}
      `;
    }

    function renderMatchCard(m) {
      const isLive = ['1H', '2H', 'HT', 'ET', 'P', 'LIVE', 'BT'].includes(m.status);
      const isFinished = ['FT', 'AET', 'PEN'].includes(m.status);
      const badge = isLive ? (m.elapsed ? `${m.elapsed}'` : 'LIVE') : formatTime(m.date);

      return `
        <div class="match-card" data-id="${m.id}">
          <div class="match-card-header">
            <div class="match-league-info">
              <span class="match-country">${esc(m.league.country)}</span>
              <span class="match-league">${esc(m.league.name)}</span>
            </div>
            <span class="match-badge ${isLive ? 'live' : 'scheduled'}">${badge}</span>
          </div>
          <div class="match-card-body">
            <div class="match-teams">
              <div class="match-team">
                ${m.home.logo ? `<img src="${m.home.logo}" class="team-logo" onerror="this.outerHTML='<div class=\'team-logo-fallback\'>${getInitials(m.home.name)}</div>'">` : `<div class="team-logo-fallback">${getInitials(m.home.name)}</div>`}
                <span class="team-name">${esc(m.home.name)}</span>
              </div>
              <div class="match-center">
                ${(isLive || isFinished) && m.goals ? `<span class="match-score">${m.goals.home} - ${m.goals.away}</span>` : `<span class="match-vs">VS</span>`}
              </div>
              <div class="match-team">
                ${m.away.logo ? `<img src="${m.away.logo}" class="team-logo" onerror="this.outerHTML='<div class=\'team-logo-fallback\'>${getInitials(m.away.name)}</div>'">` : `<div class="team-logo-fallback">${getInitials(m.away.name)}</div>`}
                <span class="team-name">${esc(m.away.name)}</span>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function renderAnalysis() {
      const m = state.selectedMatch;
      const d = state.analysisData;

      if (state.loading.analysis) {
        return `
          <div class="analysis-view">
            <div class="back-link" id="backBtn">‚Üê Torna alla lista</div>
            <div class="loading-state">
              <div class="spinner"></div>
              <div class="loading-text">Analisi AI in corso...</div>
            </div>
          </div>
        `;
      }

      if (!d) {
        return `
          <div class="analysis-view">
            <div class="back-link" id="backBtn">‚Üê Torna alla lista</div>
            <div class="empty-state">
              <div class="empty-icon">‚ö†Ô∏è</div>
              <div class="empty-text">Errore nell'analisi</div>
            </div>
          </div>
        `;
      }

      return `
        <div class="analysis-view">
          <div class="back-link" id="backBtn">‚Üê Torna alla lista</div>

          <div class="analysis-hero">
            <div class="hero-league">${esc(m.league.country)} ¬∑ ${esc(m.league.name)}</div>
            <div class="hero-match">
              <div class="hero-team">
                ${m.home.logo ? `<img src="${m.home.logo}" class="hero-team-logo">` : `<div class="hero-team-logo-fallback">${getInitials(m.home.name)}</div>`}
                <span class="hero-team-name">${esc(m.home.name)}</span>
              </div>
              <div class="hero-prediction">
                <div class="hero-score-box">${d.exactScores[0].h}</div>
                <div class="hero-time-badge">90'</div>
                <div class="hero-score-box">${d.exactScores[0].a}</div>
              </div>
              <div class="hero-team">
                ${m.away.logo ? `<img src="${m.away.logo}" class="hero-team-logo">` : `<div class="hero-team-logo-fallback">${getInitials(m.away.name)}</div>`}
                <span class="hero-team-name">${esc(m.away.name)}</span>
              </div>
            </div>
            <div class="hero-footer">Previsione AI basata su <span>${d.quality === 'enhanced' ? 'dati reali' : 'modello statistico'}</span></div>
          </div>

          <div class="analysis-grid">
            <div class="analysis-card">
              <div class="card-title">
                <div class="card-title-icon">üìä</div>
                <span class="card-title-text">Expected Goals (xG)</span>
                <span class="card-title-badge">${d.xG.total.toFixed(2)}</span>
              </div>
              <div class="card-insight">${esc(d.insights?.xg || '')}</div>
              <div class="prob-row">
                <span class="prob-label">${m.home.name.split(' ')[0]}</span>
                <div class="prob-bar-track"><div class="prob-bar-fill cyan" style="width: ${(d.xG.home / 3) * 100}%"></div></div>
                <span class="prob-value">${d.xG.home.toFixed(2)}</span>
              </div>
              <div class="prob-row">
                <span class="prob-label">${m.away.name.split(' ')[0]}</span>
                <div class="prob-bar-track"><div class="prob-bar-fill green" style="width: ${(d.xG.away / 3) * 100}%"></div></div>
                <span class="prob-value">${d.xG.away.toFixed(2)}</span>
              </div>
            </div>

            <div class="analysis-card">
              <div class="card-title">
                <div class="card-title-icon">üéØ</div>
                <span class="card-title-text">Probabilit√† 1X2</span>
              </div>
              <div class="card-insight">${esc(d.insights?.esito || '')}</div>
              <div class="prob-row">
                <span class="prob-label">1 (Casa)</span>
                <div class="prob-bar-track"><div class="prob-bar-fill cyan" style="width: ${d.p1X2.home}%"></div></div>
                <span class="prob-value">${d.p1X2.home.toFixed(1)}%</span>
              </div>
              <div class="prob-row">
                <span class="prob-label">X (Pareggio)</span>
                <div class="prob-bar-track"><div class="prob-bar-fill yellow" style="width: ${d.p1X2.draw}%"></div></div>
                <span class="prob-value">${d.p1X2.draw.toFixed(1)}%</span>
              </div>
              <div class="prob-row">
                <span class="prob-label">2 (Trasferta)</span>
                <div class="prob-bar-track"><div class="prob-bar-fill purple" style="width: ${d.p1X2.away}%"></div></div>
                <span class="prob-value">${d.p1X2.away.toFixed(1)}%</span>
              </div>
            </div>

            <div class="analysis-card">
              <div class="card-title">
                <div class="card-title-icon">‚öΩ</div>
                <span class="card-title-text">Over/Under & BTTS</span>
              </div>
              <div class="card-insight">${esc(d.insights?.gol || '')}</div>
              ${[1.5, 2.5, 3.5].map(l => `
                <div class="prob-row">
                  <span class="prob-label">O/U ${l}</span>
                  <div class="prob-bar-track"><div class="prob-bar-fill cyan" style="width: ${d.pOU[l].over}%"></div></div>
                  <span class="prob-value">${d.pOU[l].over.toFixed(0)}%</span>
                </div>
              `).join('')}
              <div class="prob-row">
                <span class="prob-label">GG</span>
                <div class="prob-bar-track"><div class="prob-bar-fill green" style="width: ${d.pBTTS}%"></div></div>
                <span class="prob-value">${d.pBTTS.toFixed(0)}%</span>
              </div>
            </div>

            <div class="analysis-card">
              <div class="card-title">
                <div class="card-title-icon">üö©</div>
                <span class="card-title-text">Corner & Cartellini</span>
              </div>
              <div class="card-insight">${esc(d.insights?.h2h || '')}</div>
              <div class="stat-grid">
                <div class="stat-box">
                  <div class="stat-box-label">${m.home.name.split(' ')[0]}</div>
                  <div class="stat-box-value">${d.corners.home.toFixed(1)}</div>
                  <div class="stat-box-sub">corner</div>
                </div>
                <div class="stat-box">
                  <div class="stat-box-label">Totale</div>
                  <div class="stat-box-value">${d.corners.total.toFixed(1)}</div>
                  <div class="stat-box-sub">corner</div>
                </div>
                <div class="stat-box">
                  <div class="stat-box-label">${m.away.name.split(' ')[0]}</div>
                  <div class="stat-box-value">${d.corners.away.toFixed(1)}</div>
                  <div class="stat-box-sub">corner</div>
                </div>
              </div>
              <div class="stat-grid" style="margin-top: 16px;">
                <div class="stat-box">
                  <div class="stat-box-label">${m.home.name.split(' ')[0]}</div>
                  <div class="stat-box-value">${d.cards.home.toFixed(1)}</div>
                  <div class="stat-box-sub">cartellini</div>
                </div>
                <div class="stat-box">
                  <div class="stat-box-label">Totale</div>
                  <div class="stat-box-value">${d.cards.total.toFixed(1)}</div>
                  <div class="stat-box-sub">cartellini</div>
                </div>
                <div class="stat-box">
                  <div class="stat-box-label">${m.away.name.split(' ')[0]}</div>
                  <div class="stat-box-value">${d.cards.away.toFixed(1)}</div>
                  <div class="stat-box-sub">cartellini</div>
                </div>
              </div>
            </div>

            <div class="analysis-card wide">
              <div class="card-title">
                <div class="card-title-icon">üé≤</div>
                <span class="card-title-text">Risultati Esatti pi√π Probabili</span>
              </div>
              <div class="card-insight">${esc(d.insights?.h2h || '')}</div>
              <div class="scores-grid">
                ${d.exactScores.map((s, i) => `
                  <div class="score-box ${i === 0 ? 'highlight' : ''}">
                    <div class="score-box-value">${s.h}-${s.a}</div>
                    <div class="score-box-prob">${s.p.toFixed(1)}%</div>
                  </div>
                `).join('')}
              </div>
            </div>
          </div>

          <div class="predictions-panel">
            <div class="predictions-header">
              <div class="predictions-title">üéØ PRONOSTICI VALUE</div>
              <div class="predictions-subtitle">Selezioni con probabilit√† calcolate ‚Ä¢ Non le scommesse ovvie</div>
            </div>
            <div class="predictions-grid">
              ${d.predictions.map(p => `
                <div class="prediction-card">
                  <div class="prediction-market">${esc(p.market)}</div>
                  <div class="prediction-value">${esc(p.value)}</div>
                  <div class="prediction-prob">üìä ${p.prob.toFixed(0)}%</div>
                  <div class="prediction-reasoning">${esc(p.reason)}</div>
                </div>
              `).join('')}
            </div>
          </div>

          <div class="actions-row">
            <button class="btn btn-primary" id="refreshBtn">üîÑ Ricalcola</button>
            <button class="btn btn-secondary" id="backBtn2">‚Üê Lista Partite</button>
          </div>
        </div>
      `;
    }

    function attachEvents() {
      // Debounced search
      const debouncedFilter = debounce(() => applyFilters(), 300);

      document.getElementById('searchInput')?.addEventListener('input', (e) => {
        state.searchQuery = e.target.value;
        debouncedFilter();
      });

      document.getElementById('leagueSelect')?.addEventListener('change', (e) => {
        state.selectedLeague = e.target.value;
        applyFilters();
      });

      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const f = btn.dataset.filter;
          state.filters[f] = !state.filters[f];
          applyFilters();
        });
      });

      document.querySelectorAll('.match-card').forEach(card => {
        card.addEventListener('click', () => {
          const id = parseInt(card.dataset.id);
          const match = state.matches.find(m => m.id === id);
          if (match) analyzeMatch(match);
        });
      });

      document.querySelectorAll('#backBtn, #backBtn2').forEach(btn => {
        btn?.addEventListener('click', () => {
          state.view = 'home';
          state.selectedMatch = null;
          state.analysisData = null;
          render();
        });
      });

      document.getElementById('refreshBtn')?.addEventListener('click', () => {
        if (state.selectedMatch) analyzeMatch(state.selectedMatch);
      });
    }

    // INIT
    async function init() {
      console.log('üöÄ BettingPro starting...');
      render();
      await loadMatches();
      console.log('‚úÖ BettingPro ready!');
    }

    init();
  </script>
</body>
</html>
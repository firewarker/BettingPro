<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PROPHECY HUNTER v3 PRO</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: system-ui, -apple-system, sans-serif; }
    .loader { animation: spin 1s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    .pulse { animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .55; } }
    .tab-active { border-bottom: 3px solid #10b981; color: #10b981; background: #ecfdf5; }
    .hot { animation: glow 2s infinite; }
    @keyframes glow { 0%,100%{ box-shadow:0 0 6px rgba(16,185,129,.55);} 50%{ box-shadow:0 0 18px rgba(16,185,129,.85);} }
    .mono { font-family: ui-monospace, monospace; }
    .csv-zone { border: 2px dashed #d1d5db; transition: all 0.3s; }
    .csv-zone.dragover { border-color: #10b981; background: #ecfdf5; }
    .csv-active { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
  </style>
</head>
<body class="bg-gray-100">
  <div id="root"></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script>
const AF_BASE = "https://v3.football.api-sports.io";
const AF_KEY = "aeb2864a3d4dbb8395fa53c83a876a93";
const TZ = "Europe/Rome";
const STORAGE = { 
  leaguesCache: "ph_leagues_v3", 
  history: "ph_history_v3", 
  ui: "ph_ui_v3",
  csvData: "ph_csv_data_v3"
};

// TOP COUNTRIES (filtra solo leghe principali per evitare localStorage pieno)
const TOP_COUNTRIES = ["England", "Spain", "Italy", "Germany", "France", "Portugal", "Netherlands", "Belgium", "Turkey", "Greece", "Scotland", "Austria", "Switzerland", "Russia", "Brazil", "Argentina", "USA", "Mexico", "World", "Europe"];

let state = {
  leagues: [], leaguesLoading: false, leaguesError: null,
  leagueQuery: "", _leagueQueryTemp: "",
  selectedLeagueId: null, selectedSeason: null,
  from: new Date().toISOString().slice(0,10),
  to: (() => { const d = new Date(); d.setDate(d.getDate() + 7); return d.toISOString().slice(0,10); })(),
  matches: [], loading: false, error: null,
  activeTab: "matches", selectedMatch: null,
  isAnalyzing: false, analysisStep: "", analysisData: null,
  minConfidence: 60,
  history: JSON.parse(localStorage.getItem(STORAGE.history) || "[]"),
  historyFilter: "all",
  // NUOVO: CSV FootyStats Premium
  csvData: JSON.parse(localStorage.getItem(STORAGE.csvData) || "null"),
  csvStats: null,
  csvEnhanced: false
};

try {
  const ui = JSON.parse(localStorage.getItem(STORAGE.ui) || "{}");
  if (ui.from) state.from = ui.from;
  if (ui.to) state.to = ui.to;
  if (typeof ui.minConfidence === "number") state.minConfidence = ui.minConfidence;
} catch(e) {}

function clamp(min, v, max) { return Math.max(min, Math.min(max, v)); }
function escapeHtml(s) { return String(s ?? "").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll("\"","&quot;").replaceAll("'","&#039;"); }

function formatDate(iso) {
  const d = new Date(iso);
  return { date: d.toLocaleDateString("it-IT", { weekday:"short", day:"2-digit", month:"2-digit" }), time: d.toLocaleTimeString("it-IT", { hour:"2-digit", minute:"2-digit" }) };
}

function badge(value, size="sm") {
  const v = parseFloat(value);
  let cls = "bg-red-100 text-red-700";
  if (v >= 70) cls = "bg-green-100 text-green-700";
  else if (v >= 55) cls = "bg-amber-100 text-amber-700";
  const sizeClass = (size==="lg") ? "px-3 py-1.5 text-sm" : "px-2 py-0.5 text-xs";
  return `<span class="rounded-xl font-black ${cls} ${sizeClass}">${Math.round(v)}</span>`;
}

function categoryIcon(cat) {
  return ({ esito: "ğŸ", goal: "âš½", corner: "ğŸš©", cards: "ğŸŸ¨", odds: "ğŸ’¹", h2h: "ğŸ”", form: "ğŸ“ˆ" }[cat] || "ğŸ“Œ");
}

function saveUI() {
  try {
    localStorage.setItem(STORAGE.ui, JSON.stringify({ from: state.from, to: state.to, minConfidence: state.minConfidence }));
  } catch(e) { console.warn("localStorage pieno (UI):", e); }
}

// ==================== CSV FOOTYSTATS FUNCTIONS ====================
function parseCSV(text) {
  return new Promise((resolve) => {
    Papa.parse(text, {
      header: true,
      skipEmptyLines: true,
      complete: (results) => resolve(results.data),
      error: () => resolve([])
    });
  });
}

function normalizeTeamName(name) {
  return name.toLowerCase()
    .replace(/\s+/g, '')
    .replace(/[^a-z0-9]/g, '')
    .substring(0, 10);
}

function findCSVMatch(homeTeam, awayTeam, csvData) {
  if (!csvData || !csvData.matches) return null;
  
  const normHome = normalizeTeamName(homeTeam);
  const normAway = normalizeTeamName(awayTeam);
  
  return csvData.matches.find(m => {
    const mHome = normalizeTeamName(m.home_team || m.Home || m.HomeTeam || '');
    const mAway = normalizeTeamName(m.away_team || m.Away || m.AwayTeam || '');
    return (mHome === normHome && mAway === normAway);
  });
}

function extractCSVStats(csvMatch) {
  if (!csvMatch) return null;
  
  // Cerca campi comuni nei CSV di FootyStats Premium
  return {
    // Expected Goals
    xg_home: parseFloat(csvMatch.home_xg || csvMatch.xG_home || csvMatch.expected_goals_home || 0),
    xg_away: parseFloat(csvMatch.away_xg || csvMatch.xG_away || csvMatch.expected_goals_away || 0),
    
    // Goals previsti
    btts_prob: parseFloat(csvMatch.btts_percentage || csvMatch.btts_prob || csvMatch.BTTS || 0),
    over25_prob: parseFloat(csvMatch.over_25_percentage || csvMatch.over25 || csvMatch['Over 2.5'] || 0),
    over35_prob: parseFloat(csvMatch.over_35_percentage || csvMatch.over35 || csvMatch['Over 3.5'] || 0),
    
    // Corner
    corners_home: parseFloat(csvMatch.home_corners_avg || csvMatch.corners_home || csvMatch.home_corners || 0),
    corners_away: parseFloat(csvMatch.away_corners_avg || csvMatch.corners_away || csvMatch.away_corners || 0),
    corners_total: parseFloat(csvMatch.total_corners_avg || csvMatch.corners_total || 0),
    
    // Cards
    cards_home: parseFloat(csvMatch.home_cards_avg || csvMatch.cards_home || csvMatch.home_yellow_cards || 0),
    cards_away: parseFloat(csvMatch.away_cards_avg || csvMatch.cards_away || csvMatch.away_yellow_cards || 0),
    cards_total: parseFloat(csvMatch.total_cards_avg || csvMatch.cards_total || 0),
    
    // Form e risultati
    home_form: csvMatch.home_form || csvMatch.form_home || null,
    away_form: csvMatch.away_form || csvMatch.form_away || null,
    home_win_prob: parseFloat(csvMatch.home_win_prob || csvMatch.win_home || csvMatch.home_percentage || 0),
    draw_prob: parseFloat(csvMatch.draw_prob || csvMatch.draw || csvMatch.draw_percentage || 0),
    away_win_prob: parseFloat(csvMatch.away_win_prob || csvMatch.win_away || csvMatch.away_percentage || 0),
    
    // Stats aggiuntive
    home_goals_avg: parseFloat(csvMatch.home_goals_avg || csvMatch.avg_goals_home || 0),
    away_goals_avg: parseFloat(csvMatch.away_goals_avg || csvMatch.avg_goals_away || 0),
    home_conceded_avg: parseFloat(csvMatch.home_conceded_avg || csvMatch.avg_conceded_home || 0),
    away_conceded_avg: parseFloat(csvMatch.away_conceded_avg || csvMatch.avg_conceded_away || 0)
  };
}

function enhanceWithCSV(predictions, homeTeam, awayTeam) {
  if (!state.csvData) return predictions;
  
  const csvMatch = findCSVMatch(homeTeam, awayTeam, state.csvData);
  if (!csvMatch) return predictions;
  
  const csvStats = extractCSVStats(csvMatch);
  state.csvStats = csvStats;
  
  // Confronta e aggiusta le predictions
  const enhanced = predictions.map(pred => {
    const newPred = { ...pred };
    let csvBoost = 0;
    
    // ESITO: confronta con probabilitÃ  CSV
    if (pred.market.includes('Match Winner') || pred.market.includes('Esito')) {
      if (pred.selection.includes('Casa') || pred.selection.includes('Home')) {
        const diff = Math.abs(pred.probability - csvStats.home_win_prob);
        if (diff < 15) csvBoost = 5; // Concordanza
        else if (diff > 30) csvBoost = -8; // Discordanza
      } else if (pred.selection.includes('Away') || pred.selection.includes('Ospite')) {
        const diff = Math.abs(pred.probability - csvStats.away_win_prob);
        if (diff < 15) csvBoost = 5;
        else if (diff > 30) csvBoost = -8;
      }
    }
    
    // OVER/UNDER GOALS: confronta con dati CSV
    if (pred.market.includes('Over/Under') && pred.market.includes('2.5')) {
      const csvOver25 = csvStats.over25_prob;
      if (csvOver25 > 0) {
        if (pred.selection.includes('Over')) {
          const diff = Math.abs(pred.probability - csvOver25);
          if (diff < 10) csvBoost = 7;
          else if (diff > 25) csvBoost = -10;
        }
      }
    }
    
    // BTTS
    if (pred.market.includes('BTTS') || pred.market.includes('Both Teams')) {
      const csvBtts = csvStats.btts_prob;
      if (csvBtts > 0) {
        if (pred.selection.includes('Yes')) {
          const diff = Math.abs(pred.probability - csvBtts);
          if (diff < 10) csvBoost = 7;
          else if (diff > 25) csvBoost = -10;
        }
      }
    }
    
    // CORNER: confronta totali
    if (pred.category === 'corner' && csvStats.corners_total > 0) {
      const predTotal = pred.market.match(/\d+\.?\d*/);
      if (predTotal) {
        const predNum = parseFloat(predTotal[0]);
        const diff = Math.abs(predNum - csvStats.corners_total);
        if (diff < 2) csvBoost = 6;
        else if (diff > 4) csvBoost = -7;
      }
    }
    
    // CARDS: confronta totali
    if (pred.category === 'cards' && csvStats.cards_total > 0) {
      const predTotal = pred.market.match(/\d+\.?\d*/);
      if (predTotal) {
        const predNum = parseFloat(predTotal[0]);
        const diff = Math.abs(predNum - csvStats.cards_total);
        if (diff < 2) csvBoost = 6;
        else if (diff > 3) csvBoost = -7;
      }
    }
    
    // Applica boost
    newPred.confidence = clamp(0, pred.confidence + csvBoost, 100);
    newPred.csvEnhanced = csvBoost !== 0;
    newPred.csvBoost = csvBoost;
    
    return newPred;
  });
  
  return enhanced;
}

async function loadCSVFile(file) {
  try {
    state.loading = true;
    render();
    
    const text = await file.text();
    const data = await parseCSV(text);
    
    if (!data || data.length === 0) {
      alert('âŒ CSV vuoto o non valido');
      state.loading = false;
      render();
      return;
    }
    
    state.csvData = {
      filename: file.name,
      loaded: new Date().toISOString(),
      matches: data,
      count: data.length
    };
    
    localStorage.setItem(STORAGE.csvData, JSON.stringify(state.csvData));
    
    alert(`âœ… Caricato: ${file.name}\nğŸ“Š ${data.length} partite`);
    state.loading = false;
    state.csvEnhanced = true;
    render();
  } catch(e) {
    alert('âŒ Errore lettura CSV: ' + e.message);
    state.loading = false;
    render();
  }
}

function clearCSV() {
  if (!confirm('ğŸ—‘ï¸ Eliminare dati CSV?')) return;
  state.csvData = null;
  state.csvStats = null;
  state.csvEnhanced = false;
  localStorage.removeItem(STORAGE.csvData);
  render();
}

// ==================== END CSV FUNCTIONS ====================

async function apiCall(path, params = {}) {
  const url = new URL(AF_BASE + path);
  Object.entries(params).forEach(([k, v]) => { if (v !== undefined && v !== null && v !== "") url.searchParams.set(k, v); });
  const res = await fetch(url.toString(), { method: "GET", headers: { "x-rapidapi-key": AF_KEY, "x-rapidapi-host": "v3.football.api-sports.io" } });
  const data = await res.json().catch(() => ({}));
  if (!res.ok) throw new Error(`HTTP ${res.status}`);
  if (data?.errors && Object.keys(data.errors).length) throw new Error(JSON.stringify(data.errors));
  return data;
}

function factorial(n) { let r = 1; for (let i=2; i<=n; i++) r *= i; return r; }
function poisson(k, lambda) { return (Math.pow(lambda, k) * Math.exp(-lambda)) / factorial(k); }

async function loadLeagues(force = false) {
  try {
    if (!force) {
      const cached = localStorage.getItem(STORAGE.leaguesCache);
      if (cached) { const {leagues, ts} = JSON.parse(cached); if (Date.now() - ts < 86400000) { state.leagues = leagues; return; } }
    }
    state.leaguesLoading = true; render();
    const data = await apiCall("/leagues");
    if (data?.response) {
      const all = data.response.filter(lg => lg.league && lg.seasons && lg.seasons.length && TOP_COUNTRIES.includes(lg.country?.name));
      state.leagues = all.map(lg => ({ id: lg.league.id, name: lg.league.name, country: lg.country.name, season: lg.seasons[lg.seasons.length - 1].year }));
      try { localStorage.setItem(STORAGE.leaguesCache, JSON.stringify({ leagues: state.leagues, ts: Date.now() })); } catch(e) { console.warn("localStorage pieno (leagues):", e); }
    }
    state.leaguesLoading = false;
  } catch (err) { state.leaguesLoading = false; state.leaguesError = err.message; }
  render();
}

async function loadMatches() {
  if (!state.selectedLeagueId || !state.selectedSeason) return;
  try {
    state.loading = true; state.error = null; render();
    const data = await apiCall("/fixtures", { league: state.selectedLeagueId, season: state.selectedSeason, from: state.from, to: state.to, timezone: TZ });
    if (!data?.response) throw new Error("Dati non validi");
    const fixtures = data.response.map(f => ({ fixtureId: f.fixture.id, utcDate: f.fixture.date, homeTeam: { id: f.teams.home.id, name: f.teams.home.name, logo: f.teams.home.logo }, awayTeam: { id: f.teams.away.id, name: f.teams.away.name, logo: f.teams.away.logo } }));
    state.matches = fixtures; state.loading = false;
  } catch (err) { state.loading = false; state.error = err.message; }
  render();
}

async function analyzeMatch(match) {
  state.selectedMatch = match; state.isAnalyzing = true; state.analysisStep = ""; state.analysisData = null; state.activeTab = "analysis"; render();
  try {
    state.analysisStep = "Caricamento statistiche..."; render(); await new Promise(r => setTimeout(r, 300));
    const [stats, h2h] = await Promise.all([ apiCall("/fixtures/statistics", { fixture: match.fixtureId }), apiCall("/fixtures/headtohead", { h2h: `${match.homeTeam.id}-${match.awayTeam.id}`, last: 5 }) ]);
    state.analysisStep = "Calcolo metriche avanzate..."; render(); await new Promise(r => setTimeout(r, 300));
    const homeStats = stats?.response?.[0]?.statistics || []; const awayStats = stats?.response?.[1]?.statistics || [];
    function getStat(arr, key, def = 0) { const val = arr.find(s => s.type === key)?.value; if (typeof val === "string") { const n = parseFloat(val.replace('%', '')); return isNaN(n) ? def : n; } return typeof val === "number" ? val : def; }
    const homePoss = getStat(homeStats, "Ball Possession", 50); const awayPoss = getStat(awayStats, "Ball Possession", 50);
    const homeShots = getStat(homeStats, "Total Shots", 12); const awayShots = getStat(awayStats, "Total Shots", 12);
    const homeSoT = getStat(homeStats, "Shots on Goal", 5); const awaySoT = getStat(awayStats, "Shots on Goal", 5);
    const homeAtt = getStat(homeStats, "Total attacks", 80); const awayAtt = getStat(awayStats, "Total attacks", 80);
    const homeDang = getStat(homeStats, "Dangerous Attacks", 40); const awayDang = getStat(awayStats, "Dangerous Attacks", 40);
    const homeFouls = getStat(homeStats, "Fouls", 12); const awayFouls = getStat(awayStats, "Fouls", 12);
    const homeYellow = getStat(homeStats, "Yellow Cards", 2); const awayYellow = getStat(awayStats, "Yellow Cards", 2);
    const homeCorners = getStat(homeStats, "Corner Kicks", 5); const awayCorners = getStat(awayStats, "Corner Kicks", 5);
    const xG_home = (homeSoT * 0.12) + (homeAtt * 0.01); const xG_away = (awaySoT * 0.12) + (awayAtt * 0.01);
    const h2hData = h2h?.response || []; let homeWins = 0, draws = 0, awayWins = 0;
    h2hData.forEach(g => { const hg = g.goals.home; const ag = g.goals.away; if (hg > ag) homeWins++; else if (hg < ag) awayWins++; else draws++; });
    const homeFormArr = h2hData.slice(0, 3).map(g => (g.teams.home.id === match.homeTeam.id ? (g.goals.home > g.goals.away ? 3 : g.goals.home === g.goals.away ? 1 : 0) : (g.goals.away > g.goals.home ? 3 : g.goals.away === g.goals.home ? 1 : 0)));
    const awayFormArr = h2hData.slice(0, 3).map(g => (g.teams.away.id === match.awayTeam.id ? (g.goals.away > g.goals.home ? 3 : g.goals.away === g.goals.home ? 1 : 0) : (g.goals.home > g.goals.away ? 3 : g.goals.home === g.goals.away ? 1 : 0)));
    const homeFormScore = homeFormArr.length ? (homeFormArr.reduce((a, b) => a + b, 0) / (homeFormArr.length * 3)) * 100 : 50;
    const awayFormScore = awayFormArr.length ? (awayFormArr.reduce((a, b) => a + b, 0) / (awayFormArr.length * 3)) * 100 : 50;
    const injuries_home = 0; const injuries_away = 0;
    const markets = { xG: { home: xG_home, away: xG_away, total: xG_home + xG_away }, h2h: { homeWins, draws, awayWins, total: h2hData.length }, homeForm: { formScore: homeFormScore, recentResults: homeFormArr }, awayForm: { formScore: awayFormScore, recentResults: awayFormArr }, injuries: { home: injuries_home, away: injuries_away }, possession: { home: homePoss, away: awayPoss }, corners: { home: homeCorners, away: awayCorners, total: homeCorners + awayCorners }, cards: { home: homeYellow, away: awayYellow, total: homeYellow + awayYellow } };
    state.analysisStep = "Generazione pronostici..."; render(); await new Promise(r => setTimeout(r, 300));
    const predictions = []; const xGTotal = xG_home + xG_away;
    const p_home = (xG_home > xG_away) ? 40 + ((xG_home - xG_away) * 8) : 30; const p_draw = 100 - p_home - (100 - p_home - 30);
    const p_away = 100 - p_home - p_draw; const esito_home_conf = p_home + (homeFormScore - 50) * 0.3; const esito_draw_conf = p_draw; const esito_away_conf = p_away + (awayFormScore - 50) * 0.3;
    predictions.push({ category: "esito", market: "Match Winner", selection: "Casa", label: `Vittoria ${match.homeTeam.name}`, probability: p_home, confidence: clamp(0, esito_home_conf, 100) });
    predictions.push({ category: "esito", market: "Match Winner", selection: "X", label: "Pareggio", probability: p_draw, confidence: clamp(0, esito_draw_conf, 100) });
    predictions.push({ category: "esito", market: "Match Winner", selection: "Ospite", label: `Vittoria ${match.awayTeam.name}`, probability: p_away, confidence: clamp(0, esito_away_conf, 100) });
    const over05 = (1 - poisson(0, xGTotal)) * 100; const over15 = (1 - poisson(0, xGTotal) - poisson(1, xGTotal)) * 100;
    const over25 = (1 - poisson(0, xGTotal) - poisson(1, xGTotal) - poisson(2, xGTotal)) * 100;
    const over35 = (1 - poisson(0, xGTotal) - poisson(1, xGTotal) - poisson(2, xGTotal) - poisson(3, xGTotal)) * 100;
    predictions.push({ category: "goal", market: "Over/Under 0.5", selection: "Over 0.5", label: "Almeno 1 gol", probability: over05, confidence: clamp(0, over05 * 0.95, 100) });
    predictions.push({ category: "goal", market: "Over/Under 1.5", selection: "Over 1.5", label: "Over 1.5 gol", probability: over15, confidence: clamp(0, over15 * 0.93, 100) });
    predictions.push({ category: "goal", market: "Over/Under 2.5", selection: "Over 2.5", label: "Over 2.5 gol", probability: over25, confidence: clamp(0, over25 * 0.9, 100) });
    predictions.push({ category: "goal", market: "Over/Under 3.5", selection: "Over 3.5", label: "Over 3.5 gol", probability: over35, confidence: clamp(0, over35 * 0.88, 100) });
    const btts_prob_base = ((1 - poisson(0, xG_home)) * (1 - poisson(0, xG_away))) * 100; const btts_conf = clamp(0, btts_prob_base * 0.92, 100);
    predictions.push({ category: "goal", market: "BTTS", selection: "Yes", label: "Entrambe segnano", probability: btts_prob_base, confidence: btts_conf });
    const corner_total_pred = (homeCorners + awayCorners); const corner_over_85_prob = corner_total_pred > 8.5 ? 60 + ((corner_total_pred - 8.5) * 5) : 40; const corner_over_105_prob = corner_total_pred > 10.5 ? 55 + ((corner_total_pred - 10.5) * 5) : 35;
    predictions.push({ category: "corner", market: "Corners Over 8.5", selection: "Over 8.5", label: "Corner Over 8.5", probability: corner_over_85_prob, confidence: clamp(0, corner_over_85_prob * 0.9, 100) });
    predictions.push({ category: "corner", market: "Corners Over 10.5", selection: "Over 10.5", label: "Corner Over 10.5", probability: corner_over_105_prob, confidence: clamp(0, corner_over_105_prob * 0.88, 100) });
    const cards_total_pred = (homeYellow + awayYellow); const cards_over_35_prob = cards_total_pred > 3.5 ? 55 + ((cards_total_pred - 3.5) * 6) : 40; const cards_over_45_prob = cards_total_pred > 4.5 ? 50 + ((cards_total_pred - 4.5) * 6) : 35;
    predictions.push({ category: "cards", market: "Cards Over 3.5", selection: "Over 3.5", label: "Cards Over 3.5", probability: cards_over_35_prob, confidence: clamp(0, cards_over_35_prob * 0.88, 100) });
    predictions.push({ category: "cards", market: "Cards Over 4.5", selection: "Over 4.5", label: "Cards Over 4.5", probability: cards_over_45_prob, confidence: clamp(0, cards_over_45_prob * 0.85, 100) });
    
    // ğŸ”¥ ENHANCE WITH CSV
    const enhancedPreds = enhanceWithCSV(predictions, match.homeTeam.name, match.awayTeam.name);
    
    enhancedPreds.sort((a, b) => b.confidence - a.confidence);
    const topPick = enhancedPreds[0];
    state.analysisData = { match, markets, predictions: enhancedPreds, topPick, selectedPredictions: [] };
    state.isAnalyzing = false;
  } catch (err) { state.isAnalyzing = false; state.error = err.message; }
  render();
}

function togglePrediction(idx) {
  if (!state.analysisData) return;
  const pred = state.analysisData.predictions[idx];
  const existing = state.analysisData.selectedPredictions.findIndex(p => p.market === pred.market && p.selection === pred.selection);
  if (existing >= 0) state.analysisData.selectedPredictions.splice(existing, 1);
  else state.analysisData.selectedPredictions.push(pred);
  render();
}

function savePredictions() {
  if (!state.analysisData || state.analysisData.selectedPredictions.length === 0) { alert("Seleziona almeno un pronostico!"); return; }
  const entry = { id: Date.now(), date: state.analysisData.match.utcDate, homeTeam: state.analysisData.match.homeTeam.name, awayTeam: state.analysisData.match.awayTeam.name, predictions: state.analysisData.selectedPredictions.map(p => ({ market: p.market, selection: p.selection, label: p.label, confidence: p.confidence, probability: p.probability, result: null, csvEnhanced: p.csvEnhanced || false, csvBoost: p.csvBoost || 0 })), status: "pending" };
  state.history.unshift(entry);
  try { localStorage.setItem(STORAGE.history, JSON.stringify(state.history)); } catch(e) { console.warn("localStorage pieno (history):", e); state.history = state.history.slice(0, 50); localStorage.setItem(STORAGE.history, JSON.stringify(state.history)); }
  state.activeTab = "history"; render();
}

function updateHistoryResult(entryId, predIdx, won) {
  const entry = state.history.find(e => e.id === entryId); if (!entry) return;
  entry.predictions[predIdx].result = won ? "won" : "lost";
  const wonCount = entry.predictions.filter(p => p.result === "won").length; const lostCount = entry.predictions.filter(p => p.result === "lost").length;
  if (wonCount === entry.predictions.length) entry.status = "won";
  else if (lostCount === entry.predictions.length) entry.status = "lost";
  else if (wonCount > 0 || lostCount > 0) entry.status = "partial";
  try { localStorage.setItem(STORAGE.history, JSON.stringify(state.history)); } catch(e) { console.warn("localStorage pieno (history):", e); }
  render();
}

function getHistoryStats() {
  const total = state.history.length; const won = state.history.filter(e => e.status === "won").length;
  const partial = state.history.filter(e => e.status === "partial").length; const lost = state.history.filter(e => e.status === "lost").length;
  const winRate = total > 0 ? Math.round((won / total) * 100) : 0;
  const allPreds = state.history.flatMap(e => e.predictions); const predTotal = allPreds.length;
  const predWon = allPreds.filter(p => p.result === "won").length; const predHitRate = predTotal > 0 ? Math.round((predWon / predTotal) * 100) : 0;
  return { total, won, partial, lost, winRate, predTotal, predWon, predHitRate };
}

async function refreshResults() {
  alert("â™»ï¸ Aggiornamento automatico non implementato. Aggiorna manualmente ogni risultato.");
}

function clearHistory() {
  if (!confirm("ğŸ—‘ï¸ Eliminare tutta la cronologia?")) return;
  state.history = []; localStorage.removeItem(STORAGE.history); render();
}

function setMinConfidence(v) { state.minConfidence = parseInt(v); saveUI(); render(); }
function setHistoryFilter(f) { state.historyFilter = f; render(); }

function render() {
  const root = document.getElementById("root");
  const tabs = [
    { id: "matches", label: "âš½ Partite", icon: "âš½" },
    { id: "analysis", label: "ğŸ§  Analisi", icon: "ğŸ§ " },
    { id: "history", label: "ğŸ“Š Tracker", icon: "ğŸ“Š" },
    { id: "csv", label: state.csvData ? "ğŸ“Š CSV âœ“" : "ğŸ“Š CSV", icon: "ğŸ“Š" }
  ];
  
  const header = `
    <header class="sticky top-0 z-50 bg-gradient-to-r from-gray-900 to-gray-800 text-white shadow-xl">
      <div class="max-w-lg mx-auto p-4"><h1 class="text-2xl font-black text-center mb-1">ğŸ”® PROPHECY HUNTER <span class="text-emerald-400">PRO</span></h1>
      ${state.csvData ? `<p class="text-center text-xs text-emerald-400 font-bold">ğŸ“Š ${state.csvData.filename} (${state.csvData.count} partite)</p>` : ''}
      </div>
      <nav class="flex border-t border-white/20">${tabs.map(t => `<button onclick="state.activeTab='${t.id}'; render();" class="flex-1 py-3 text-sm font-black ${state.activeTab === t.id ? 'tab-active' : 'text-white/70'}">${t.label}</button>`).join("")}</nav>
    </header>
  `;

  let content = "";

  if (state.activeTab === "matches") {
    const filteredLeagues = state.leagues.filter(lg => lg.name.toLowerCase().includes(state.leagueQuery.toLowerCase()) || lg.country.toLowerCase().includes(state.leagueQuery.toLowerCase()));
    const selectedLeague = state.leagues.find(lg => lg.id === state.selectedLeagueId);
    content = `
      <div class="bg-white rounded-2xl shadow-lg p-4 mb-3">
        <div class="flex gap-2 mb-3"><input type="text" placeholder="ğŸ” Cerca lega..." value="${escapeHtml(state._leagueQueryTemp)}" oninput="state._leagueQueryTemp=this.value;" onkeyup="if(event.key==='Enter'){state.leagueQuery=state._leagueQueryTemp; render();}" class="flex-1 px-3 py-2 border rounded-xl text-sm font-semibold" /><button onclick="state.leagueQuery=state._leagueQueryTemp; render();" class="px-4 py-2 bg-emerald-600 text-white rounded-xl font-black text-sm">ğŸ”</button></div>
        ${state.leaguesLoading ? `<p class="text-center text-sm font-semibold text-gray-500 pulse">Caricamento leghe...</p>` : filteredLeagues.length === 0 ? `<p class="text-center text-sm font-semibold text-gray-500">Nessuna lega trovata.</p>` : `<select onchange="state.selectedLeagueId=parseInt(this.value); const lg=state.leagues.find(l=>l.id===state.selectedLeagueId); state.selectedSeason=lg?lg.season:null; loadMatches();" class="w-full p-3 border rounded-xl font-black text-sm bg-gray-50">${filteredLeagues.map(lg => `<option value="${lg.id}" ${lg.id === state.selectedLeagueId ? "selected" : ""}>${lg.country} - ${lg.name} (${lg.season})</option>`).join("")}</select>`}
      </div>
      <div class="bg-white rounded-2xl shadow-lg p-4 mb-3">
        <div class="grid grid-cols-2 gap-2 mb-2"><input type="date" value="${state.from}" onchange="state.from=this.value; saveUI();" class="px-3 py-2 border rounded-xl text-sm font-semibold" /><input type="date" value="${state.to}" onchange="state.to=this.value; saveUI();" class="px-3 py-2 border rounded-xl text-sm font-semibold" /></div>
        <button onclick="loadMatches()" class="w-full py-2.5 bg-emerald-600 text-white rounded-xl font-black text-sm">ğŸ“… CARICA</button>
      </div>
      ${state.loading ? `<div class="bg-white rounded-2xl p-10 text-center shadow-lg"><div class="w-12 h-12 border-4 border-emerald-500 border-t-transparent rounded-full loader mx-auto mb-3"></div><p class="font-black pulse">Caricamento...</p></div>` : state.error ? `<div class="bg-red-50 rounded-2xl p-6 text-center shadow"><p class="text-red-600 font-black">âŒ ${escapeHtml(state.error)}</p></div>` : state.matches.length === 0 ? `<div class="bg-white rounded-2xl p-8 text-center shadow"><p class="text-gray-500 font-semibold">Nessuna partita</p></div>` : `<div class="space-y-3">${state.matches.map(m => { const {date, time} = formatDate(m.utcDate); return `<div class="bg-white rounded-2xl shadow-md overflow-hidden"><div class="p-4"><div class="flex justify-between items-center mb-3"><div class="flex-1"><p class="font-black text-gray-900 text-sm">${escapeHtml(m.homeTeam.name)} vs ${escapeHtml(m.awayTeam.name)}</p><p class="text-xs text-gray-500 font-semibold">${date} ${time}</p></div></div><button onclick="analyzeMatch(state.matches.find(x=>x.fixtureId===${m.fixtureId}))" class="w-full py-2.5 bg-gray-900 text-white rounded-xl font-black text-sm">ğŸ§  ANALIZZA</button></div></div>`; }).join("")}</div>`}
    `;
  }

  if (state.activeTab === "analysis") {
    if (state.isAnalyzing) content = `<div class="bg-white rounded-2xl p-10 text-center shadow-lg"><div class="w-12 h-12 border-4 border-emerald-500 border-t-transparent rounded-full loader mx-auto mb-4"></div><p class="font-black mb-2">Analisi...</p><p class="text-emerald-600 font-extrabold pulse text-sm">${escapeHtml(state.analysisStep || "")}</p></div>`;
    else if (!state.analysisData) content = `<div class="bg-white rounded-2xl p-12 text-center shadow-lg"><p class="text-5xl mb-3">ğŸ§ </p><p class="font-black">Seleziona una partita</p></div>`;
    else {
      const a = state.analysisData; const m = a.match; const {date, time} = formatDate(m.utcDate);
      const filteredPreds = a.predictions.filter(p => p.confidence >= state.minConfidence); const top = a.topPick;
      const h2h = a.markets.h2h || {}; const homeForm = a.markets.homeForm || {}; const awayForm = a.markets.awayForm || {};
      
      // CSV MATCH INFO
      let csvMatchInfo = '';
      if (state.csvStats) {
        csvMatchInfo = `
          <div class="bg-emerald-50 border-2 border-emerald-500 rounded-xl p-3 mb-3">
            <p class="font-black text-emerald-800 text-center text-xs mb-2">ğŸ“Š DATI CSV FOOTYSTATS</p>
            <div class="grid grid-cols-3 gap-2 text-center text-xs">
              <div class="bg-white rounded p-1.5"><p class="text-gray-600 font-bold">xG CSV</p><p class="font-black">${state.csvStats.xg_home.toFixed(2)} - ${state.csvStats.xg_away.toFixed(2)}</p></div>
              <div class="bg-white rounded p-1.5"><p class="text-gray-600 font-bold">Over 2.5</p><p class="font-black">${state.csvStats.over25_prob.toFixed(0)}%</p></div>
              <div class="bg-white rounded p-1.5"><p class="text-gray-600 font-bold">BTTS</p><p class="font-black">${state.csvStats.btts_prob.toFixed(0)}%</p></div>
            </div>
            <div class="grid grid-cols-2 gap-2 mt-2 text-center text-xs">
              <div class="bg-white rounded p-1.5"><p class="text-gray-600 font-bold">Corner Tot</p><p class="font-black">${state.csvStats.corners_total.toFixed(1)}</p></div>
              <div class="bg-white rounded p-1.5"><p class="text-gray-600 font-bold">Cards Tot</p><p class="font-black">${state.csvStats.cards_total.toFixed(1)}</p></div>
            </div>
          </div>
        `;
      }
      
      content = `
        <div class="bg-gradient-to-r from-gray-900 to-gray-800 rounded-2xl p-4 text-white mb-3 shadow-lg">
          <div class="text-center"><p class="font-black">${escapeHtml(m.homeTeam.name)} vs ${escapeHtml(m.awayTeam.name)}</p><p class="text-white/70 text-xs font-semibold">${date} ${time}</p></div>
          <div class="grid grid-cols-3 gap-2 mt-3 text-center text-sm">
            <div class="bg-white/10 rounded-lg p-2"><p class="text-white/70 text-xs font-bold">xG Casa</p><p class="font-black text-lg">${a.markets.xG.home.toFixed(2)}</p></div>
            <div class="bg-white/10 rounded-lg p-2"><p class="text-white/70 text-xs font-bold">xG Tot</p><p class="font-black text-lg text-emerald-300">${a.markets.xG.total.toFixed(2)}</p></div>
            <div class="bg-white/10 rounded-lg p-2"><p class="text-white/70 text-xs font-bold">xG Away</p><p class="font-black text-lg">${a.markets.xG.away.toFixed(2)}</p></div>
          </div>
          <div class="grid grid-cols-3 gap-2 mt-2">
            <div class="bg-white/10 rounded-lg p-2 text-center"><p class="text-white/70 text-xs font-bold">ğŸ” H2H</p><p class="font-black text-sm">${h2h.homeWins||0}-${h2h.draws||0}-${h2h.awayWins||0}</p></div>
            <div class="bg-white/10 rounded-lg p-2 text-center"><p class="text-white/70 text-xs font-bold">ğŸ“ˆ Forma</p><p class="font-black text-sm">${homeForm.formScore?homeForm.formScore.toFixed(0):50} - ${awayForm.formScore?awayForm.formScore.toFixed(0):50}</p></div>
            <div class="bg-white/10 rounded-lg p-2 text-center"><p class="text-white/70 text-xs font-bold">ğŸ©º Inj</p><p class="font-black text-sm">${a.markets.injuries.home} - ${a.markets.injuries.away}</p></div>
          </div>
          <div class="grid grid-cols-2 gap-2 mt-2">
            <div class="bg-white/10 rounded-lg p-2 text-center"><p class="text-white/70 text-xs font-bold">ğŸš© Corner</p><p class="font-black text-sm">${a.markets.corners.total.toFixed(1)}</p></div>
            <div class="bg-white/10 rounded-lg p-2 text-center"><p class="text-white/70 text-xs font-bold">ğŸŸ¨ Cards</p><p class="font-black text-sm">${a.markets.cards.total.toFixed(1)}</p></div>
          </div>
        </div>
        ${csvMatchInfo}
        <div class="bg-white rounded-xl p-3 mb-3 flex items-center justify-between shadow">
          <span class="text-sm font-black">Min Conf</span>
          <div class="flex items-center gap-2"><input type="range" min="40" max="85" value="${state.minConfidence}" onchange="setMinConfidence(this.value)" class="w-28" /><span class="font-black text-emerald-600 w-10 text-right">${state.minConfidence}</span></div>
        </div>
        <div class="bg-white rounded-2xl shadow-lg overflow-hidden mb-3">
          <div class="px-4 py-3 ${top.csvEnhanced ? 'csv-active' : 'bg-gradient-to-r from-emerald-600 to-green-600'} flex justify-between items-center">
            <span class="font-black text-white text-sm">ğŸ† TOP PICK ${top.csvEnhanced ? '+ CSV ğŸ“Š' : ''}</span>
            <span class="text-white/90 text-xs font-black">${badge(top.confidence, "lg")}</span>
          </div>
          <div class="p-4">
            <div class="flex items-center justify-between gap-2">
              <div class="min-w-0">
                <p class="font-black text-gray-900 text-sm truncate">${categoryIcon(top.category)} ${escapeHtml(top.label)}</p>
                <p class="text-xs text-gray-500 font-semibold truncate">${escapeHtml(top.market)} â€¢ ${escapeHtml(top.selection)} â€¢ ${top.probability.toFixed(1)}%</p>
                ${top.csvEnhanced ? `<p class="text-xs text-emerald-600 font-black mt-1">CSV Boost: ${top.csvBoost > 0 ? '+' : ''}${top.csvBoost.toFixed(1)}</p>` : ''}
              </div>
            </div>
            <button class="w-full mt-3 py-2.5 bg-gray-900 text-white rounded-xl font-black text-sm" onclick="state.analysisData.selectedPredictions=[state.analysisData.topPick]; savePredictions();">ğŸ’¾ SALVA TOP</button>
          </div>
        </div>
        <div class="bg-white rounded-2xl shadow-lg overflow-hidden mb-3">
          <div class="px-4 py-3 bg-gradient-to-r from-gray-800 to-gray-900 flex justify-between items-center"><span class="font-black text-white text-sm">PRONOSTICI</span><span class="text-white/80 text-xs font-black">${filteredPreds.length} / ${a.predictions.length}</span></div>
          <div class="divide-y max-h-[42vh] overflow-y-auto">${filteredPreds.length === 0 ? `<p class="p-4 text-center text-gray-500 text-sm font-semibold">Nessuno sopra soglia.</p>` : filteredPreds.map((p) => { const idx = a.predictions.indexOf(p); const selected = a.selectedPredictions.some(x => x.market === p.market && x.selection === p.selection); const isHot = p.confidence >= 75; return `<div class="px-3 py-2.5 flex items-center gap-2 cursor-pointer hover:bg-gray-50 ${selected ? "bg-emerald-50" : ""} ${isHot ? "hot" : ""} ${p.csvEnhanced ? 'border-l-4 border-emerald-500' : ''}" onclick="togglePrediction(${idx})"><div class="w-8 h-8 rounded-lg ${selected ? "bg-emerald-600 text-white" : "bg-gray-100"} flex items-center justify-center text-sm font-black">${selected ? "âœ“" : categoryIcon(p.category)}</div><div class="flex-1 min-w-0"><p class="font-black text-gray-900 text-sm truncate">${escapeHtml(p.label)} ${p.csvEnhanced ? 'ğŸ“Š' : ''}</p><p class="text-xs text-gray-500 font-semibold truncate">${escapeHtml(p.market)} â€¢ ${p.probability.toFixed(1)}%${p.csvEnhanced ? ` â€¢ Boost ${p.csvBoost > 0 ? '+' : ''}${p.csvBoost.toFixed(0)}` : ''}</p></div><div class="text-right">${badge(p.confidence, "lg")}</div></div>`; }).join("")}</div>
          <div class="p-3"><button onclick="savePredictions()" class="w-full py-3 bg-gradient-to-r from-emerald-500 to-green-600 text-white rounded-2xl font-black shadow-lg">ğŸ’¾ SALVA ${a.selectedPredictions.length}</button></div>
        </div>
      `;
    }
  }

  if (state.activeTab === "history") {
    const stats = getHistoryStats();
    const filtered = (state.historyFilter === "all") ? state.history : state.history.filter(e => e.status === state.historyFilter);
    content = `
      <div class="bg-gradient-to-r from-gray-800 to-gray-900 rounded-2xl p-4 text-white mb-3 shadow-lg">
        <h3 class="font-black mb-3 text-center text-sm">ğŸ“Š Tracker</h3>
        <div class="grid grid-cols-4 gap-2 text-center mb-3">
          <div class="bg-white/10 rounded-lg p-2"><p class="text-xl font-black">${stats.total}</p><p class="text-xs text-white/70 font-bold">Tot</p></div>
          <div class="bg-green-500/30 rounded-lg p-2"><p class="text-xl font-black text-emerald-300">${stats.won}</p><p class="text-xs text-white/70 font-bold">âœ…</p></div>
          <div class="bg-amber-500/30 rounded-lg p-2"><p class="text-xl font-black text-amber-200">${stats.partial}</p><p class="text-xs text-white/70 font-bold">ğŸŸ¨</p></div>
          <div class="bg-red-500/30 rounded-lg p-2"><p class="text-xl font-black text-red-200">${stats.lost}</p><p class="text-xs text-white/70 font-bold">âŒ</p></div>
        </div>
        <div class="grid grid-cols-2 gap-2">
          <div class="bg-white/10 rounded-lg p-2 text-center"><p class="text-2xl font-black text-emerald-300">${stats.winRate}%</p><p class="text-xs text-white/70 font-bold">Win Rate</p></div>
          <div class="bg-white/10 rounded-lg p-2 text-center"><p class="text-2xl font-black text-sky-300">${stats.predHitRate}%</p><p class="text-xs text-white/70 font-bold">Hit (${stats.predWon}/${stats.predTotal})</p></div>
        </div>
        <div class="flex gap-2 mt-3">
          <button onclick="refreshResults()" class="flex-1 py-2.5 bg-emerald-500 rounded-xl font-black text-sm">â™»ï¸ AGGIORNA</button>
          <button onclick="clearHistory()" class="px-4 py-2.5 bg-red-500 rounded-xl font-black text-sm">ğŸ—‘ï¸</button>
        </div>
      </div>
      <div class="flex gap-2 mb-3 overflow-x-auto pb-1">${["all","pending","won","partial","lost"].map(f => `<button onclick="setHistoryFilter('${f}')" class="px-3 py-1.5 rounded-full text-xs font-black whitespace-nowrap ${state.historyFilter===f ? "bg-emerald-600 text-white" : "bg-white text-gray-700 border"}">${f==="all" ? "Tutti" : f}</button>`).join("")}</div>
      <div class="space-y-3">${filtered.length === 0 ? `<div class="bg-white rounded-2xl p-8 text-center shadow"><p class="text-gray-500 font-semibold">Nessuno</p></div>` : filtered.map(entry => { const {date, time} = formatDate(entry.date); const statusColors = { pending: "border-gray-300", won: "border-emerald-400 bg-emerald-50", partial: "border-amber-400 bg-amber-50", lost: "border-red-400 bg-red-50" }; const statusIcons = { pending:"â³", won:"âœ…", partial:"ğŸŸ¨", lost:"âŒ" }; return `<div class="bg-white rounded-2xl shadow-md overflow-hidden border-2 ${statusColors[entry.status] || "border-gray-300"}"><div class="px-4 py-2.5 border-b flex justify-between items-center"><div><p class="font-black text-gray-900 text-sm">${escapeHtml(entry.homeTeam)} vs ${escapeHtml(entry.awayTeam)}</p><p class="text-xs text-gray-500 font-semibold">${date} ${time}</p></div><span class="text-xl">${statusIcons[entry.status]||"â³"}</span></div><div class="p-3 space-y-2">${(entry.predictions || []).map((p, pIdx) => `<div class="flex items-center justify-between py-1.5 px-2.5 rounded-lg ${p.result === "won" ? "bg-emerald-100" : p.result === "lost" ? "bg-red-100" : "bg-gray-50"}"><div class="flex-1 min-w-0"><p class="font-black text-gray-900 text-sm truncate">${escapeHtml(p.label)} ${p.csvEnhanced ? 'ğŸ“Š' : ''}</p><p class="text-xs text-gray-600 font-semibold truncate">${escapeHtml(p.market)} â€¢ Conf ${p.confidence.toFixed(0)}${p.csvEnhanced ? ` â€¢ CSV ${p.csvBoost > 0 ? '+' : ''}${p.csvBoost}` : ''}</p></div><div class="flex gap-1 items-center">${p.result == null ? `<button onclick="updateHistoryResult(${entry.id}, ${pIdx}, true)" class="px-2.5 py-1 bg-emerald-600 text-white rounded text-xs font-black">W</button><button onclick="updateHistoryResult(${entry.id}, ${pIdx}, false)" class="px-2.5 py-1 bg-red-600 text-white rounded text-xs font-black">L</button>` : `<span class="text-lg font-black">${p.result === "won" ? "âœ…" : "âŒ"}</span>`}</div></div>`).join("")}</div></div>`; }).join("")}</div>
    `;
  }

  // TAB CSV
  if (state.activeTab === "csv") {
    content = `
      <div class="bg-white rounded-2xl shadow-lg p-6 mb-3">
        <h3 class="font-black text-gray-900 mb-4 text-center text-lg">ğŸ“Š INTEGRAZIONE CSV FOOTYSTATS</h3>
        
        ${state.csvData ? `
          <div class="bg-emerald-50 border-2 border-emerald-500 rounded-xl p-4 mb-4">
            <div class="flex items-center justify-between mb-3">
              <div>
                <p class="font-black text-emerald-800 text-sm">âœ… CSV Caricato</p>
                <p class="text-xs text-emerald-600 font-semibold">${escapeHtml(state.csvData.filename)}</p>
              </div>
              <button onclick="clearCSV()" class="px-3 py-2 bg-red-500 text-white rounded-lg font-black text-xs">ğŸ—‘ï¸ RIMUOVI</button>
            </div>
            <div class="grid grid-cols-2 gap-3">
              <div class="bg-white rounded-lg p-3 text-center">
                <p class="text-2xl font-black text-emerald-600">${state.csvData.count}</p>
                <p class="text-xs text-gray-600 font-bold">Partite</p>
              </div>
              <div class="bg-white rounded-lg p-3 text-center">
                <p class="text-sm font-black text-emerald-600">${new Date(state.csvData.loaded).toLocaleString('it-IT', {day:'2-digit', month:'2-digit', hour:'2-digit', minute:'2-digit'})}</p>
                <p class="text-xs text-gray-600 font-bold">Caricato</p>
              </div>
            </div>
          </div>
          
          <div class="bg-blue-50 border border-blue-200 rounded-xl p-4">
            <p class="font-black text-blue-800 text-sm mb-2">â„¹ï¸ Come Funziona</p>
            <ul class="text-xs text-blue-700 space-y-1.5">
              <li><strong>1.</strong> Il CSV viene confrontato automaticamente con ogni partita analizzata</li>
              <li><strong>2.</strong> I pronostici vengono potenziati se concordano con i dati CSV</li>
              <li><strong>3.</strong> Vedrai il simbolo <strong>ğŸ“Š</strong> e il <strong>boost CSV</strong> su ogni pronostico migliorato</li>
              <li><strong>4.</strong> Il TOP PICK diventa verde con <strong>"+ CSV"</strong> se potenziato</li>
            </ul>
          </div>
        ` : `
          <div 
            id="csvDropZone" 
            class="csv-zone rounded-xl p-10 text-center cursor-pointer"
            onclick="document.getElementById('csvFileInput').click()"
          >
            <input 
              type="file" 
              id="csvFileInput" 
              accept=".csv" 
              style="display:none" 
              onchange="if(this.files[0]) loadCSVFile(this.files[0])"
            />
            <p class="text-5xl mb-4">ğŸ“Š</p>
            <p class="font-black text-gray-900 mb-2">Carica CSV FootyStats Premium</p>
            <p class="text-sm text-gray-600 font-semibold mb-4">Clicca o trascina qui il file CSV</p>
            <div class="bg-gray-50 rounded-lg p-4 text-left">
              <p class="text-xs font-black text-gray-700 mb-2">ğŸ“‹ Campi supportati:</p>
              <p class="text-xs text-gray-600">â€¢ xG home/away â€¢ Over/Under probabilities â€¢ BTTS</p>
              <p class="text-xs text-gray-600">â€¢ Corner statistics â€¢ Cards statistics â€¢ Form & H2H</p>
            </div>
          </div>
          
          <div class="mt-4 bg-amber-50 border border-amber-200 rounded-xl p-4">
            <p class="font-black text-amber-800 text-sm mb-2">ğŸ’¡ Consiglio</p>
            <p class="text-xs text-amber-700">Esporta i dati delle partite dal tuo account <strong>FootyStats Premium</strong> in formato CSV e caricali qui per potenziare le analisi!</p>
          </div>
        `}
      </div>
    `;
  }

  root.innerHTML = `${header}<main class="max-w-lg mx-auto p-4 pb-16">${content}</main><footer class="fixed bottom-0 left-0 right-0 bg-white border-t p-2 text-xs text-gray-500 max-w-lg mx-auto flex justify-between items-center"><span class="font-black">ğŸ”® Prophecy Hunter v3 PRO${state.csvData ? ' <span class="text-emerald-600">+ CSV</span>' : ''}</span><span class="mono">${state.selectedLeagueId??"-"}</span></footer>`;
  
  // Drag & Drop per CSV
  if (state.activeTab === "csv" && !state.csvData) {
    const dropZone = document.getElementById('csvDropZone');
    if (dropZone) {
      dropZone.ondragover = (e) => { e.preventDefault(); dropZone.classList.add('dragover'); };
      dropZone.ondragleave = () => { dropZone.classList.remove('dragover'); };
      dropZone.ondrop = (e) => { 
        e.preventDefault(); 
        dropZone.classList.remove('dragover'); 
        if (e.dataTransfer.files[0]) loadCSVFile(e.dataTransfer.files[0]);
      };
    }
  }
  
  window.state = state;
}

(async function init() {
  await loadLeagues(false);
  if (!state.selectedLeagueId && state.leagues.length) { state.selectedLeagueId = state.leagues[0].id; state.selectedSeason = state.leagues[0].season; }
  if (state.selectedLeagueId && state.selectedSeason) await loadMatches();
  render();
})();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BettingPro - AI Betting Intelligence</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-dark: #0c1222;
      --bg-card: #141d2f;
      --bg-card-light: #1a2642;
      --bg-input: #0f172a;
      --accent-cyan: #22d3ee;
      --accent-blue: #3b82f6;
      --accent-green: #10b981;
      --accent-yellow: #fbbf24;
      --accent-red: #ef4444;
      --accent-purple: #a855f7;
      --text-white: #ffffff;
      --text-gray: #94a3b8;
      --text-dark: #64748b;
      --border: rgba(255,255,255,0.08);
      --glow-cyan: 0 0 20px rgba(34, 211, 238, 0.3);
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: Inter, -apple-system, system-ui, sans-serif;
      background: var(--bg-dark);
      color: var(--text-white);
      min-height: 100vh;
    }
    .header {
      background: rgba(12, 18, 34, 0.95);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--border);
      padding: 16px 32px;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .header-inner {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .brand { display:flex; align-items:center; gap:14px; }
    .brand-icon {
      width: 40px; height: 40px;
      background: linear-gradient(135deg, var(--accent-cyan), var(--accent-blue));
      border-radius: 10px;
      display:flex; align-items:center; justify-content:center;
      font-size: 1.4rem;
    }
    .brand-name {
      font-size: 1.4rem;
      font-weight: 800;
      background: linear-gradient(to right, var(--accent-cyan), var(--accent-blue));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .status-bar { display:flex; gap:15px; }
    .status-item { display:flex; align-items:center; gap:6px; font-size:0.75rem; color:var(--text-dark); }
    .status-dot { width:8px; height:8px; border-radius:50%; background:var(--text-dark); }
    .status-dot.online { background:var(--accent-green); box-shadow:0 0 8px var(--accent-green); }

    .main { max-width: 1400px; margin: 0 auto; padding: 32px; }

    .search-panel {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 24px;
      margin-bottom: 32px;
    }
    .search-row { display:flex; gap:16px; margin-bottom: 20px; flex-wrap:wrap; }
    .search-input, .select-field {
      padding: 14px 20px;
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: 12px;
      color: white;
      font-size: 1rem;
      flex: 1;
    }
    .filter-row { display:flex; gap:10px; }
    .filter-btn {
      padding: 10px 20px;
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.9rem;
      color: var(--text-gray);
    }
    .filter-btn.active {
      background: rgba(34, 211, 238, 0.15);
      border-color: var(--accent-cyan);
      color: var(--accent-cyan);
    }

    .matches-container { display:grid; grid-template-columns: repeat(auto-fill, minmax(380px, 1fr)); gap:20px; }
    .match-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 20px;
      cursor: pointer;
      transition: transform 0.2s, border-color 0.2s;
    }
    .match-card:hover { transform: translateY(-4px); border-color: var(--accent-cyan); }
    .match-header { display:flex; justify-content:space-between; margin-bottom:16px; font-size:0.85rem; color:var(--text-gray); }
    .match-teams { display:flex; justify-content:space-between; align-items:center; }
    .team { display:flex; flex-direction:column; align-items:center; gap:8px; text-align:center; width: 40%; }
    .team-logo { width:48px; height:48px; object-fit:contain; }
    .team-name { font-weight:700; font-size:0.95rem; }
    .match-meta { display:flex; flex-direction:column; align-items:center; font-weight:700; }
    .match-time { font-family:'JetBrains Mono'; font-size:1.2rem; }

    /* Analysis View */
    .analysis-view { animation: fadeIn 0.3s; }
    @keyframes fadeIn { from{opacity:0} to{opacity:1} }
    .back-btn { padding:10px 20px; background:var(--bg-card); border-radius:8px; cursor:pointer; display:inline-block; margin-bottom:20px; font-weight:600; }

    .analysis-hero {
      background: linear-gradient(145deg, var(--bg-card), var(--bg-card-light));
      border-radius: 24px;
      padding: 40px;
      text-align: center;
      margin-bottom: 30px;
      border: 1px solid var(--border);
    }
    .hero-score { font-size: 3rem; font-weight: 900; font-family: 'JetBrains Mono'; margin: 20px 0; color: var(--accent-cyan); }

    .analysis-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap:24px; }
    .card { background:var(--bg-card); border-radius:20px; padding:24px; border:1px solid var(--border); }
    .card-title { font-size:1.1rem; font-weight:700; margin-bottom:16px; display:flex; align-items:center; gap:10px; }
    .card-insight { background:rgba(255,255,255,0.03); padding:12px; border-radius:10px; margin-bottom:20px; font-size:0.9rem; color:var(--text-gray); border-left: 3px solid var(--accent-cyan); }

    .stat-row { display:flex; justify-content:space-between; margin-bottom:12px; align-items:center; }
    .progress-bar { flex:1; height:8px; background:var(--bg-input); margin:0 12px; border-radius:4px; overflow:hidden; }
    .progress-fill { height:100%; border-radius:4px; }
    .fill-cyan { background:var(--accent-cyan); }
    .fill-green { background:var(--accent-green); }

    .predictions-list { display:grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap:15px; }
    .pred-box { background:var(--bg-input); padding:16px; border-radius:12px; text-align:center; border:1px solid var(--border); }
    .pred-label { font-size:0.8rem; color:var(--text-gray); text-transform:uppercase; letter-spacing:1px; }
    .pred-val { font-size:1.4rem; font-weight:800; margin:8px 0; }
    .pred-prob { color:var(--accent-cyan); font-weight:700; font-size:0.9rem; }

    .loading { text-align:center; padding:50px; color:var(--text-gray); }
    .spinner { border:3px solid rgba(255,255,255,0.1); border-top:3px solid var(--accent-cyan); border-radius:50%; width:40px; height:40px; animation:spin 1s linear infinite; margin:0 auto 20px; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div id="app"></div>

  <script type="module">
    // CONFIG
    const CONFIG = {
      KEY_FOOTBALL: 'aeb2864a3d4dbb8395fa53c83a876a93',
      KEY_FOOTY: 'bec59b6f83404b0bd79c40076be71f6f3abec62afdacf5eeba296f2357993f3e',
      URL_FOOTBALL: 'https://v3.football.api-sports.io',
      URL_FOOTY: 'https://api.footystats.org',
      PROXY: 'https://corsproxy.io/?'
    };

    // STATE
    const state = {
      view: 'home',
      matches: [],
      filtered: [],
      leagues: [],
      selectedLeague: '',
      search: '',
      filters: { live: true, upcoming: true, finished: true },
      selectedMatch: null,
      analysis: null,
      loading: false,
      error: null
    };

    window.state = state; // Debug

    // UTILS
    const esc = t => String(t || '').replace(/</g,'&lt;');
    const normalize = s => (s||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').trim();

    // API
    async function apiCall(url, params, headers = {}) {
      const u = new URL(url);
      Object.keys(params).forEach(k => u.searchParams.append(k, params[k]));
      console.log('Fetching:', u.toString());
      const res = await fetch(CONFIG.PROXY + encodeURIComponent(u.toString()), { headers });
      if (!res.ok) throw new Error(res.statusText);
      return res.json();
    }

    // LOAD MATCHES
    async function loadMatches() {
      state.loading = true;
      state.error = null;
      render();

      try {
        const today = new Date().toISOString().split('T')[0];

        // Chiamata principale: partite di OGGI
        const data = await apiCall(`${CONFIG.URL_FOOTBALL}/fixtures`, {
          date: today,
          timezone: 'Europe/Rome'
        }, {
          'x-rapidapi-key': CONFIG.KEY_FOOTBALL,
          'x-rapidapi-host': 'v3.football.api-sports.io'
        });

        if (data.response && data.response.length > 0) {
          state.matches = data.response.map(processMatch);
        } else {
          // Fallback se oggi non ci sono partite: prendi le prossime 30
          console.log('Nessuna partita oggi, provo le prossime...');
          const nextData = await apiCall(`${CONFIG.URL_FOOTBALL}/fixtures`, {
            next: 30,
            timezone: 'Europe/Rome'
          }, {
            'x-rapidapi-key': CONFIG.KEY_FOOTBALL,
            'x-rapidapi-host': 'v3.football.api-sports.io'
          });
          state.matches = (nextData.response || []).map(processMatch);
        }

        // Estrai leghe
        const leaguesMap = new Map();
        state.matches.forEach(m => leaguesMap.set(m.league.id, m.league));
        state.leagues = Array.from(leaguesMap.values()).sort((a,b) => a.country.localeCompare(b.country));

        applyFilters();

      } catch (e) {
        state.error = "Errore caricamento: " + e.message;
        console.error(e);
      } finally {
        state.loading = false;
        render();
      }
    }

    function processMatch(f) {
      return {
        id: f.fixture.id,
        date: f.fixture.date,
        ts: f.fixture.timestamp,
        status: f.fixture.status.short,
        elapsed: f.fixture.status.elapsed,
        league: f.league,
        home: f.teams.home,
        away: f.teams.away,
        goals: f.goals
      };
    }

    function applyFilters() {
      let res = state.matches;

      if (state.search) {
        const q = normalize(state.search);
        res = res.filter(m => normalize(m.home.name).includes(q) || normalize(m.away.name).includes(q) || normalize(m.league.name).includes(q));
      }

      if (state.selectedLeague) {
        res = res.filter(m => m.league.id == state.selectedLeague);
      }

      // Filtri stato
      res = res.filter(m => {
        const isLive = ['1H','2H','HT','ET','P','LIVE'].includes(m.status);
        const isFin = ['FT','AET','PEN'].includes(m.status);
        const isUp = ['NS','TBD'].includes(m.status);

        if (isLive && !state.filters.live) return false;
        if (isFin && !state.filters.finished) return false;
        if (isUp && !state.filters.upcoming) return false;
        return true;
      });

      // Ordinamento alfabetico
      res.sort((a,b) => {
        const nameA = normalize(a.home.name);
        const nameB = normalize(b.home.name);
        return nameA.localeCompare(nameB);
      });

      state.filtered = res;
    }

    // ANALYSIS
    async function analyze(match) {
      state.selectedMatch = match;
      state.view = 'analysis';
      state.loading = true;
      render();

      try {
        // Simulazione caricamento dati per demo (o chiamate reali se necessario)
        // Qui facciamo un'analisi basata sui dati che abbiamo + logica
        // Per implementazione reale servirebbe chiamata /predictions

        const res = await apiCall(`${CONFIG.URL_FOOTBALL}/predictions`, { fixture: match.id }, {
            'x-rapidapi-key': CONFIG.KEY_FOOTBALL,
            'x-rapidapi-host': 'v3.football.api-sports.io'
        });

        const pred = res.response?.[0];

        state.analysis = buildAnalysis(match, pred);
      } catch (e) {
        console.error(e);
        state.analysis = buildAnalysis(match, null); // Fallback
      } finally {
        state.loading = false;
        render();
      }
    }

    function buildAnalysis(m, apiData) {
      // Logica semplificata per generare insight
      const homeStrength = apiData?.predictions?.percent?.home || "45%";
      const awayStrength = apiData?.predictions?.percent?.away || "30%";
      const drawStrength = apiData?.predictions?.percent?.draw || "25%";

      const advice = apiData?.predictions?.advice || "Partita equilibrata";
      const goalsHome = apiData?.predictions?.goals?.home || "-1.5";
      const goalsAway = apiData?.predictions?.goals?.away || "-1.5";

      return {
        advice: advice,
        winProb: { home: parseInt(homeStrength), draw: parseInt(drawStrength), away: parseInt(awayStrength) },
        xg: { home: Math.abs(parseFloat(goalsHome)), away: Math.abs(parseFloat(goalsAway)) },
        insights: {
            general: `Il sistema suggerisce: ${advice}.`,
            goals: `Previsti circa ${Math.abs(parseFloat(goalsHome)) + Math.abs(parseFloat(goalsAway))} gol totali.`
        },
        predictions: [
            { label: "Esito", val: parseInt(homeStrength) > parseInt(awayStrength) ? "1" : "2", prob: Math.max(parseInt(homeStrength), parseInt(awayStrength)) + "%" },
            { label: "Goal", val: (parseFloat(goalsHome)+parseFloat(goalsAway) > 2.5) ? "Over 2.5" : "Under 2.5", prob: "65%" },
            { label: "BTTS", val: "Sì", prob: "55%" }
        ]
      };
    }

    // RENDER
    function render() {
      const app = document.getElementById('app');

      if (state.view === 'home') {
        app.innerHTML = `
          <header class="header">
            <div class="header-inner">
              <div class="brand">
                <div class="brand-icon">⚽</div>
                <div class="brand-name">BettingPro</div>
              </div>
              <div class="status-bar">
                 <div class="status-item"><div class="status-dot online"></div>API Connected</div>
              </div>
            </div>
          </header>

          <main class="main">
            <div class="search-panel">
              <div class="search-row">
                <input type="text" class="search-input" id="search" placeholder="Cerca squadra..." value="${esc(state.search)}">
                <select class="select-field" id="league">
                  <option value="">Tutti i campionati</option>
                  ${state.leagues.map(l => `<option value="${l.id}" ${state.selectedLeague==l.id?'selected':''}>${l.country} - ${l.name}</option>`).join('')}
                </select>
              </div>
              <div class="filter-row">
                <button class="filter-btn ${state.filters.live?'active':''}" onclick="toggle('live')">Live</button>
                <button class="filter-btn ${state.filters.upcoming?'active':''}" onclick="toggle('upcoming')">In Arrivo</button>
                <button class="filter-btn ${state.filters.finished?'active':''}" onclick="toggle('finished')">Finiti</button>
              </div>
            </div>

            ${state.loading ? `<div class="loading"><div class="spinner"></div>Caricamento partite...</div>` : ''}

            ${state.error ? `<div style="color:var(--accent-red);text-align:center;margin:20px;">${state.error}</div>` : ''}

            <div class="matches-container">
              ${state.filtered.map(m => `
                <div class="match-card" onclick="openMatch(${m.id})">
                  <div class="match-header">
                    <span>${m.league.country} - ${m.league.name}</span>
                    <span style="color:${['1H','2H','LIVE'].includes(m.status)?'var(--accent-red)':'inherit'}">${m.status} ${m.elapsed?m.elapsed+"'":''}</span>
                  </div>
                  <div class="match-teams">
                    <div class="team">
                      <img src="${m.home.logo}" class="team-logo">
                      <div class="team-name">${m.home.name}</div>
                    </div>
                    <div class="match-meta">
                      <div class="match-time">${['NS','TBD'].includes(m.status) ? new Date(m.date).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}) : (m.goals.home ?? 0) + ' - ' + (m.goals.away ?? 0)}</div>
                    </div>
                    <div class="team">
                      <img src="${m.away.logo}" class="team-logo">
                      <div class="team-name">${m.away.name}</div>
                    </div>
                  </div>
                </div>
              `).join('')}
            </div>
            ${!state.loading && state.filtered.length === 0 ? '<div style="text-align:center;color:var(--text-gray)">Nessuna partita trovata.</div>' : ''}
          </main>
        `;

        // Bind events
        document.getElementById('search').oninput = e => { state.search = e.target.value; applyFilters(); render(); };
        document.getElementById('league').onchange = e => { state.selectedLeague = e.target.value; applyFilters(); render(); };

      } else if (state.view === 'analysis') {
        const m = state.selectedMatch;
        const a = state.analysis || {};

        app.innerHTML = `
           <header class="header">
            <div class="header-inner">
               <div class="brand"><div class="brand-name">Analisi Match</div></div>
               <button class="back-btn" onclick="goHome()">Chiudi</button>
            </div>
          </header>
          <main class="main">
            <div class="analysis-hero">
               <h2>${m.home.name} vs ${m.away.name}</h2>
               <div class="hero-score">${a.xg?.home?.toFixed(2) || 0} - ${a.xg?.away?.toFixed(2) || 0} <span style="font-size:1rem;color:gray">(xG)</span></div>
               <p>${a.advice || 'Analisi in corso...'}</p>
            </div>

            <div class="analysis-grid">
               <div class="card">
                  <div class="card-title">Probabilità Vittoria</div>
                  <div class="stat-row">
                    <span>1</span>
                    <div class="progress-bar"><div class="progress-fill fill-cyan" style="width:${a.winProb?.home}%"></div></div>
                    <span>${a.winProb?.home}%</span>
                  </div>
                  <div class="stat-row">
                    <span>X</span>
                    <div class="progress-bar"><div class="progress-fill fill-green" style="width:${a.winProb?.draw}%"></div></div>
                    <span>${a.winProb?.draw}%</span>
                  </div>
                  <div class="stat-row">
                    <span>2</span>
                    <div class="progress-bar"><div class="progress-fill fill-cyan" style="width:${a.winProb?.away}%"></div></div>
                    <span>${a.winProb?.away}%</span>
                  </div>
                  <div class="card-insight">${a.insights?.general}</div>
               </div>

               <div class="card">
                 <div class="card-title">Pronostici AI</div>
                 <div class="predictions-list">
                    ${(a.predictions||[]).map(p => `
                        <div class="pred-box">
                            <div class="pred-label">${p.label}</div>
                            <div class="pred-val">${p.val}</div>
                            <div class="pred-prob">${p.prob}</div>
                        </div>
                    `).join('')}
                 </div>
                 <div class="card-insight">${a.insights?.goals}</div>
               </div>
            </div>
          </main>
        `;
      }
    }

    // ACTIONS
    window.toggle = (f) => { state.filters[f] = !state.filters[f]; applyFilters(); render(); };
    window.openMatch = (id) => { 
        const m = state.matches.find(x => x.id === id);
        analyze(m);
    };
    window.goHome = () => { state.view = 'home'; render(); };

    // INIT
    loadMatches();

  </script>
</body>
</html>

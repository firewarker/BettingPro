<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BettingPro - AI Betting Intelligence</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-dark: #0c1222;
      --bg-card: #141d2f;
      --bg-card-light: #1a2642;
      --bg-input: #0f172a;
      --accent-cyan: #22d3ee;
      --accent-blue: #3b82f6;
      --accent-green: #10b981;
      --accent-yellow: #fbbf24;
      --accent-red: #ef4444;
      --accent-purple: #a855f7;
      --text-white: #ffffff;
      --text-gray: #94a3b8;
      --text-dark: #64748b;
      --border: rgba(255,255,255,0.08);
      --glow-cyan: 0 0 20px rgba(34, 211, 238, 0.3);
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: Inter, -apple-system, system-ui, sans-serif;
      background: var(--bg-dark);
      background-image: radial-gradient(ellipse at top, rgba(34, 211, 238, 0.05) 0%, transparent 50%), radial-gradient(ellipse at bottom right, rgba(59, 130, 246, 0.05) 0%, transparent 50%);
      color: var(--text-white);
      min-height: 100vh;
    }
    .header {
      background: rgba(12, 18, 34, 0.95);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--border);
      padding: 16px 32px;
      position: sticky; top: 0; z-index: 100;
    }
    .header-inner { max-width: 1400px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; }
    .brand { font-size: 1.4rem; font-weight: 800; background: linear-gradient(135deg, var(--accent-cyan), var(--accent-blue)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

    .main { max-width: 1400px; margin: 0 auto; padding: 32px; }

    /* Search & Filter Panel */
    .control-panel {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 24px;
      margin-bottom: 32px;
      display: flex; gap: 20px; flex-wrap: wrap; align-items: center;
    }
    .select-league {
      flex: 2;
      min-width: 250px;
      padding: 14px 20px;
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: 12px;
      color: white;
      font-size: 1rem;
      cursor: pointer;
    }
    .search-input {
      flex: 1;
      min-width: 200px;
      padding: 14px 20px;
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: 12px;
      color: white;
    }

    /* Matches List */
    .matches-list { display: flex; flex-direction: column; gap: 12px; }
    .match-row {
      display: flex; align-items: center; justify-content: space-between;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px 24px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .match-row:hover { border-color: var(--accent-cyan); transform: translateX(4px); }
    .match-time { font-family: 'JetBrains Mono'; color: var(--text-gray); font-size: 0.9rem; min-width: 60px; }
    .match-teams { flex: 1; display: flex; align-items: center; gap: 20px; margin: 0 24px; font-weight: 600; font-size: 1.05rem; }
    .match-vs { color: var(--text-dark); font-size: 0.8rem; text-transform: uppercase; }
    .match-league-tag { font-size: 0.75rem; color: var(--accent-cyan); background: rgba(34, 211, 238, 0.1); padding: 4px 10px; border-radius: 6px; white-space: nowrap; }

    /* Analysis View */
    .analysis-view { animation: fadeIn 0.3s; }
    @keyframes fadeIn { from{opacity:0} to{opacity:1} }
    .back-btn { margin-bottom: 20px; padding: 10px 20px; background: var(--bg-card); border: 1px solid var(--border); color: var(--text-gray); border-radius: 8px; cursor: pointer; }

    .analysis-hero {
      text-align: center; padding: 40px;
      background: linear-gradient(145deg, var(--bg-card), var(--bg-card-light));
      border-radius: 20px; margin-bottom: 30px; border: 1px solid var(--border);
    }
    .hero-teams { font-size: 1.8rem; font-weight: 800; margin-bottom: 10px; }
    .hero-meta { color: var(--text-gray); font-size: 0.9rem; }

    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 24px; }
    .stat-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; padding: 24px; }
    .card-head { font-size: 1.1rem; font-weight: 700; margin-bottom: 20px; color: var(--accent-cyan); display: flex; align-items: center; gap: 10px; }

    .prob-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .prob-bar { flex: 1; height: 8px; background: var(--bg-input); margin: 0 15px; border-radius: 4px; overflow: hidden; }
    .prob-fill { height: 100%; border-radius: 4px; }

    .prediction-box {
      background: var(--bg-input); border: 1px solid var(--border);
      border-radius: 12px; padding: 16px; margin-bottom: 12px;
      display: flex; justify-content: space-between; align-items: center;
    }
    .pred-val { font-size: 1.2rem; font-weight: 800; }
    .pred-prob { color: var(--accent-green); font-family: 'JetBrains Mono'; font-weight: 700; }

    .stat-mini-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; text-align: center; margin-top: 15px; }
    .mini-stat { background: var(--bg-card-light); padding: 10px; border-radius: 8px; }
    .mini-val { font-size: 1.2rem; font-weight: 800; color: var(--text-white); }
    .mini-label { font-size: 0.7rem; color: var(--text-gray); text-transform: uppercase; margin-top: 4px; }

    .loading { text-align: center; padding: 60px; color: var(--text-gray); }

    /* Fallback logo */
    .logo-fallback { width: 40px; height: 40px; background: #333; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: bold; }
  </style>
</head>
<body>
  <div id="app"></div>

  <script type="module">
    console.log("BettingPro v6 FULL - Starting...");

    const CONFIG = {
      KEY_FOOTBALL: 'aeb2864a3d4dbb8395fa53c83a876a93',
      KEY_FOOTY: 'bec59b6f83404b0bd79c40076be71f6f3abec62afdacf5eeba296f2357993f3e',
      URL_FOOTBALL: 'https://v3.football.api-sports.io',
      URL_FOOTY: 'https://api.footystats.org',
      PROXY: 'https://corsproxy.io/?'
    };

    let state = {
      view: 'list',
      matches: [],
      filtered: [],
      leagues: [],
      selectedLeague: 'ALL',
      search: '',
      match: null,
      analysis: null,
      loading: false,
      footyStatsTeams: new Map()
    };

    // --- UTILS & MATH ---
    const esc = t => String(t||'').replace(/</g,'&lt;');
    const poisson = (lambda, k) => {
        if (lambda <= 0) return k === 0 ? 1 : 0;
        let r = Math.exp(-lambda);
        for(let i=0; i<k; i++) r *= lambda / (i+1);
        return r;
    };
    const clamp = (min, val, max) => Math.max(min, Math.min(max, val));

    // --- API ---
    async function apiCall(url, params, headers={}) {
        const u = new URL(url);
        Object.keys(params).forEach(k => u.searchParams.append(k, params[k]));
        try {
            const res = await fetch(CONFIG.PROXY + encodeURIComponent(u.toString()), { headers });
            if(!res.ok) throw new Error(res.statusText);
            return res.json();
        } catch(e) {
            console.error("API Error", e);
            throw e;
        }
    }

    async function callFooty(endpoint, params) {
        const u = new URL(CONFIG.URL_FOOTY + endpoint);
        u.searchParams.append('key', CONFIG.KEY_FOOTY);
        Object.keys(params).forEach(k => u.searchParams.append(k, params[k]));
        try {
            const res = await fetch(CONFIG.PROXY + encodeURIComponent(u.toString()));
            return res.json();
        } catch(e) { return null; }
    }

    // --- LOGIC ---
    async function loadData() {
        state.loading = true; render();

        try {
            // 1. Load Matches (Today -> Next 30 fallback)
            let data = null;
            try {
                data = await apiCall(`${CONFIG.URL_FOOTBALL}/fixtures`, {
                    date: new Date().toISOString().split('T')[0], timezone: 'Europe/Rome'
                }, { 'x-rapidapi-key': CONFIG.KEY_FOOTBALL, 'x-rapidapi-host': 'v3.football.api-sports.io' });
            } catch(e) {}

            if(!data?.response?.length) {
                 console.log("No matches today, loading next 30...");
                 data = await apiCall(`${CONFIG.URL_FOOTBALL}/fixtures`, {
                    next: 30, timezone: 'Europe/Rome'
                }, { 'x-rapidapi-key': CONFIG.KEY_FOOTBALL, 'x-rapidapi-host': 'v3.football.api-sports.io' });
            }

            // 2. Process Matches
            state.matches = (data.response || []).map(m => ({
                id: m.fixture.id,
                time: new Date(m.fixture.date),
                status: m.fixture.status.short,
                league: m.league,
                home: m.teams.home,
                away: m.teams.away
            }));

            // 3. Extract & Sort Leagues
            const lMap = new Map();
            state.matches.forEach(m => lMap.set(m.league.id, m.league));
            state.leagues = Array.from(lMap.values()).sort((a,b) => 
                (a.country + a.name).localeCompare(b.country + b.name)
            );

            // 4. Load FootyStats (Background)
            loadFootyData();

            filterMatches();
        } catch(e) { console.error(e); }

        state.loading = false; render();
    }

    async function loadFootyData() {
        const res = await callFooty('/todays-matches', {});
        if(res?.data) {
            res.data.forEach(m => {
                if(m.home_name && m.away_name) {
                    const k = m.home_name.toLowerCase().replace(/\s/g,'') + m.away_name.toLowerCase().replace(/\s/g,'');
                    state.footyStatsTeams.set(k, m);
                }
            });
        }
    }

    function filterMatches() {
        let res = state.matches;

        // Filter by League
        if(state.selectedLeague !== 'ALL') {
            res = res.filter(m => m.league.id == state.selectedLeague);
        }

        // Search
        if(state.search) {
            const q = state.search.toLowerCase();
            res = res.filter(m => 
                m.home.name.toLowerCase().includes(q) || 
                m.away.name.toLowerCase().includes(q)
            );
        }

        // Sort Chronologically
        res.sort((a,b) => a.time - b.time);

        state.filtered = res;
        render();
    }

    async function analyze(match) {
        state.match = match;
        state.view = 'analysis';
        state.loading = true; render();

        try {
            // Fetch Stats
            let hStats, aStats, h2h = [];
            try {
                const [hs, as, h2hRes] = await Promise.all([
                    apiCall(`${CONFIG.URL_FOOTBALL}/teams/statistics`, { team: match.home.id, league: match.league.id, season: match.league.season || 2024 }, { 'x-rapidapi-key': CONFIG.KEY_FOOTBALL, 'x-rapidapi-host': 'v3.football.api-sports.io' }),
                    apiCall(`${CONFIG.URL_FOOTBALL}/teams/statistics`, { team: match.away.id, league: match.league.id, season: match.league.season || 2024 }, { 'x-rapidapi-key': CONFIG.KEY_FOOTBALL, 'x-rapidapi-host': 'v3.football.api-sports.io' }),
                    apiCall(`${CONFIG.URL_FOOTBALL}/fixtures/headtohead`, { h2h: `${match.home.id}-${match.away.id}`, last: 5 }, { 'x-rapidapi-key': CONFIG.KEY_FOOTBALL, 'x-rapidapi-host': 'v3.football.api-sports.io' })
                ]);
                hStats = hs.response;
                aStats = as.response;
                h2h = h2hRes.response;
            } catch(e) { console.warn("Stats error", e); }

            // Check FootyStats
            let fs = null;
            const k = match.home.name.toLowerCase().replace(/\s/g,'') + match.away.name.toLowerCase().replace(/\s/g,'');
            if(state.footyStatsTeams.has(k)) fs = state.footyStatsTeams.get(k);

            // --- ALGO V6 ---
            let xG_h = 1.35, xG_a = 1.10; // Default

            // 1. Base Stats
            if(hStats && aStats) {
                const attH = parseFloat(hStats.goals?.for?.average?.home || 1.3);
                const defA = parseFloat(aStats.goals?.against?.average?.away || 1.4);
                xG_h = (attH + defA) / 2;

                const attA = parseFloat(aStats.goals?.for?.average?.away || 1.1);
                const defH = parseFloat(hStats.goals?.against?.average?.home || 1.2);
                xG_a = (attA + defH) / 2;
            }

            // 2. FootyStats Integration
            if(fs) {
                if(fs.home_xg) xG_h = (xG_h + fs.home_xg) / 2;
                if(fs.away_xg) xG_a = (xG_a + fs.away_xg) / 2;
            }

            // 3. Poisson Distribution
            let p1=0, pX=0, p2=0, pO25=0, pBTTS=0;
            const p0_h = poisson(xG_h, 0);
            const p0_a = poisson(xG_a, 0);
            pBTTS = (1 - p0_h) * (1 - p0_a) * 100;

            for(let i=0; i<7; i++) for(let j=0; j<7; j++) {
                const p = poisson(xG_h, i) * poisson(xG_a, j);
                if(i>j) p1+=p; else if(i==j) pX+=p; else p2+=p;
                if(i+j > 2.5) pO25+=p;
            }

            // 4. Corners & Cards (Estimated)
            const cornH = (parseFloat(hStats?.cards?.yellow?.['0-15']?.total || 5) * 1.2) + 2; 
            const cornA = (parseFloat(aStats?.cards?.yellow?.['0-15']?.total || 4) * 1.2) + 1;
            const cardH = parseFloat(hStats?.cards?.yellow?.['0-15']?.total || 1.5);
            const cardA = parseFloat(aStats?.cards?.yellow?.['0-15']?.total || 1.8);

            state.analysis = {
                xg: { h: xG_h, a: xG_a },
                probs: { 1: p1*100, X: pX*100, 2: p2*100, O25: pO25*100, U25: (1-pO25)*100 },
                corners: { h: cornH, a: cornA, tot: cornH+cornA },
                cards: { h: cardH, a: cardA, tot: cardH+cardA },
                predictions: [
                    { m: 'Esito Finale', v: p1>p2 ? (p1>pX?'1':'X') : (p2>pX?'2':'X'), p: Math.max(p1,p2,pX)*100 },
                    { m: 'Under/Over 2.5', v: pO25>0.5 ? 'Over' : 'Under', p: Math.max(pO25, 1-pO25)*100 },
                    { m: 'Gol/NoGol', v: pBTTS>50 ? 'Gol' : 'NoGol', p: Math.max(pBTTS, 100-pBTTS) },
                    { m: 'Corner Totali', v: `Over ${Math.floor(cornH+cornA - 1.5)}`, p: 65 }
                ]
            };

        } catch(e) { console.error(e); }
        state.loading = false; render();
    }

    // --- RENDER ---
    function render() {
        const app = document.getElementById('app');

        if(state.view === 'list') {
            app.innerHTML = `
                <header class="header"><div class="header-inner"><div class="brand">BettingPro v6 FULL</div></div></header>
                <main class="main">
                    <div class="control-panel">
                        <select class="select-league" id="leagueSelect">
                            <option value="ALL">üåç Tutti i campionati</option>
                            ${state.leagues.map(l => `<option value="${l.id}" ${state.selectedLeague==l.id?'selected':''}>${l.country} - ${l.name}</option>`).join('')}
                        </select>
                        <input class="search-input" id="search" placeholder="Cerca squadra..." value="${esc(state.search)}">
                    </div>

                    ${state.loading ? '<div class="loading">Caricamento partite...</div>' : ''}

                    <div class="matches-list">
                        ${state.filtered.map(m => `
                            <div class="match-row" onclick="openMatch(${m.id})">
                                <div class="match-time">${m.time.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>
                                <div class="match-teams">
                                    <span style="text-align:right; flex:1">${m.home.name}</span>
                                    <span class="match-vs">vs</span>
                                    <span style="text-align:left; flex:1">${m.away.name}</span>
                                </div>
                                <div class="match-league-tag">${m.league.name}</div>
                            </div>
                        `).join('')}
                    </div>
                </main>
            `;

            document.getElementById('leagueSelect').onchange = e => { state.selectedLeague = e.target.value; filterMatches(); };
            document.getElementById('search').oninput = e => { state.search = e.target.value; filterMatches(); };

        } else {
            const d = state.analysis;
            const m = state.match;
            if(!d) return;

            app.innerHTML = `
                <header class="header"><div class="header-inner"><div class="brand">Analisi Match</div></div></header>
                <main class="main">
                    <button class="back-btn" onclick="goBack()">‚Üê Torna alla lista</button>

                    <div class="analysis-hero">
                        <div class="hero-meta">${m.league.country} - ${m.league.name}</div>
                        <div class="hero-teams">${m.home.name} vs ${m.away.name}</div>
                        <div style="font-size:1.2rem; margin-top:10px">
                            xG: <span style="color:var(--accent-cyan)">${d.xg.h.toFixed(2)}</span> - 
                            <span style="color:var(--accent-cyan)">${d.xg.a.toFixed(2)}</span>
                        </div>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="card-head">üìä Probabilit√† 1X2</div>
                            <div class="prob-row"><span>1 (Casa)</span><div class="prob-bar"><div class="prob-fill" style="width:${d.probs[1]}%; background:var(--accent-cyan)"></div></div><span>${d.probs[1].toFixed(1)}%</span></div>
                            <div class="prob-row"><span>X (Pareggio)</span><div class="prob-bar"><div class="prob-fill" style="width:${d.probs.X}%; background:var(--accent-yellow)"></div></div><span>${d.probs.X.toFixed(1)}%</span></div>
                            <div class="prob-row"><span>2 (Ospite)</span><div class="prob-bar"><div class="prob-fill" style="width:${d.probs[2]}%; background:var(--accent-purple)"></div></div><span>${d.probs[2].toFixed(1)}%</span></div>
                        </div>

                        <div class="stat-card">
                            <div class="card-head">üéØ Pronostici Value</div>
                            ${d.predictions.map(p => `
                                <div class="prediction-box">
                                    <div>
                                        <div style="font-size:0.8rem; color:var(--text-gray)">${p.m}</div>
                                        <div class="pred-val">${p.v}</div>
                                    </div>
                                    <div class="pred-prob">${p.p.toFixed(0)}%</div>
                                </div>
                            `).join('')}
                        </div>

                        <div class="stat-card">
                            <div class="card-head">üö© Corner & Cartellini</div>
                            <div class="stat-mini-grid">
                                <div class="mini-stat"><div class="mini-val">${d.corners.h.toFixed(1)}</div><div class="mini-label">Corner Casa</div></div>
                                <div class="mini-stat"><div class="mini-val">${d.corners.tot.toFixed(1)}</div><div class="mini-label">Corner Tot</div></div>
                                <div class="mini-stat"><div class="mini-val">${d.corners.a.toFixed(1)}</div><div class="mini-label">Corner Osp</div></div>

                                <div class="mini-stat"><div class="mini-val">${d.cards.h.toFixed(1)}</div><div class="mini-label">Cart. Casa</div></div>
                                <div class="mini-stat"><div class="mini-val">${d.cards.tot.toFixed(1)}</div><div class="mini-label">Cart. Tot</div></div>
                                <div class="mini-stat"><div class="mini-val">${d.cards.a.toFixed(1)}</div><div class="mini-label">Cart. Osp</div></div>
                            </div>
                        </div>
                    </div>
                </main>
            `;
        }
    }

    window.openMatch = (id) => analyze(state.matches.find(m => m.id === id));
    window.goBack = () => { state.view = 'list'; render(); };

    loadData();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BettingPro - Betting Intelligence</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;800&display=swap');

    body { 
      font-family: 'Poppins', -apple-system, BlinkMacSystemFont, sans-serif;
      background: #f8f9fa;
    }

    .logo-bettingpro {
      font-family: 'Poppins', sans-serif;
      font-size: 2.5rem;
      font-weight: 300;
      letter-spacing: 0.1em;
      color: #5b4b8a;
      text-shadow: 2px 2px 4px rgba(91, 75, 138, 0.1);
    }

    .loader { animation: spin 1s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

    .pulse { animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }

    .fade-in { animation: fadeIn 0.4s ease-in; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

    .match-card {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      border-left: 4px solid transparent;
    }
    .match-card:hover {
      transform: translateX(4px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.08);
      border-left-color: #5b4b8a;
    }

    .search-input {
      border: 2px solid #e0e0e0;
      transition: all 0.3s;
    }
    .search-input:focus {
      outline: none;
      border-color: #5b4b8a;
      box-shadow: 0 0 0 3px rgba(91, 75, 138, 0.1);
    }

    .dropdown-select {
      border: 2px solid #5b4b8a;
      border-radius: 25px;
      padding: 10px 20px;
      font-weight: 600;
      background: white;
      cursor: pointer;
    }

    .prono-card {
      background: #5b4b8a;
      color: white;
      border-radius: 12px;
      padding: 20px;
      font-weight: 600;
      text-align: center;
      transition: all 0.3s;
      cursor: pointer;
    }
    .prono-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 25px rgba(91, 75, 138, 0.4);
    }

    input[type="range"] {
      -webkit-appearance: none;
      width: 100%;
      height: 8px;
      border-radius: 5px;
      background: #ddd;
      outline: none;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: #4ade80;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }

    .api-status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 6px;
    }
    .api-status-dot.active { background: #4ade80; animation: pulse 2s infinite; }
    .api-status-dot.inactive { background: #ef4444; }
  </style>
</head>
<body class="bg-gray-50">
  <div id="root"></div>

<script type="module">
// ============================================
// üî• BETTINGPRO - SISTEMA COMPLETO
// ============================================

console.log('üöÄ BettingPro inizializzato');

// === CONFIGURAZIONE API ===
const API_CONFIG = {
  API_FOOTBALL: {
    key: 'aeb2864a3d4dbb8395fa53c83a876a93',
    host: 'v3.football.api-sports.io',
    baseURL: 'https://v3.football.api-sports.io',
    enabled: true
  },
  FOOTYSTATS: {
    key: 'bec59b6f83404b0bd79c40076be71f6f3abec62afdacf5eeba296f2357993f3e',
    baseURL: 'https://api.footystats.org',
    enabled: true
  },
  FIREBASE: {
    dbURL: 'https://bettingpro-d0125-default-rtdb.europe-west1.firebasedatabase.app',
    enabled: true
  }
};

// === STORAGE ===
const STORAGE = {
  leagues: 'bettingpro_leagues',
  favorites: 'bettingpro_favorites',
  cache: 'bettingpro_cache'
};

// === CSV DATA ===
const csvData = {
  teamStats: new Map(),
  loaded: false,
  sources: []
};

// === STATE ===
let state = {
  view: 'home',
  leagues: [],
  leaguesLoading: false,
  selectedLeague: null,
  matches: [],
  matchesLoading: false,
  selectedMatch: null,
  analysisData: null,
  analysisLoading: false,
  searchQuery: '',
  favorites: JSON.parse(localStorage.getItem(STORAGE.favorites) || '["39","135","140","78","61"]'), // IDs API-Football
  apiStatus: {
    apiFootball: false,
    footyStats: false,
    firebase: false
  },
  error: null,
  apiMethod: 'hybrid' // hybrid, api-only, firebase-only
};

// === UTILITIES ===
function escapeHtml(text) {
  const map = {'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;'};
  return String(text || '').replace(/[&<>"']/g, m => map[m]);
}

function formatDate(dateString) {
  if (!dateString) return { date: '-', time: '-' };
  const d = new Date(dateString);
  const date = d.toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit' });
  const time = d.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
  return { date, time };
}

function clamp(min, val, max) {
  return Math.max(min, Math.min(max, val));
}

function factorial(n) {
  if (n <= 1) return 1;
  return n * factorial(n - 1);
}

function poisson(lambda, k) {
  return (Math.pow(lambda, k) * Math.exp(-lambda)) / factorial(k);
}

// === FIREBASE FUNCTIONS ===
async function firebaseGet(path) {
  try {
    const url = `${API_CONFIG.FIREBASE.dbURL}${path}.json`;
    const response = await fetch(url);
    if (!response.ok) throw new Error('Firebase error');
    const data = await response.json();
    console.log('‚úÖ Firebase GET:', path, data);
    state.apiStatus.firebase = true;
    return data;
  } catch (error) {
    console.error('‚ùå Firebase error:', error);
    state.apiStatus.firebase = false;
    return null;
  }
}

async function firebaseSet(path, data) {
  try {
    const url = `${API_CONFIG.FIREBASE.dbURL}${path}.json`;
    const response = await fetch(url, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });
    if (!response.ok) throw new Error('Firebase error');
    console.log('‚úÖ Firebase SET:', path);
    return true;
  } catch (error) {
    console.error('‚ùå Firebase set error:', error);
    return false;
  }
}

// === API-FOOTBALL FUNCTIONS ===
async function apiFootballCall(endpoint, params = {}) {
  const url = new URL(API_CONFIG.API_FOOTBALL.baseURL + endpoint);
  Object.keys(params).forEach(key => url.searchParams.append(key, params[key]));

  try {
    console.log('üì° API-Football call:', endpoint, params);
    const response = await fetch(url.toString(), {
      method: 'GET',
      headers: {
        'x-rapidapi-key': API_CONFIG.API_FOOTBALL.key,
        'x-rapidapi-host': API_CONFIG.API_FOOTBALL.host
      }
    });

    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`);
    }

    const data = await response.json();
    console.log('‚úÖ API-Football success:', data);
    state.apiStatus.apiFootball = true;

    // Salva in Firebase per cache
    const cacheKey = endpoint.replace(/\//g, '_') + '_' + JSON.stringify(params);
    await firebaseSet(`/cache/${cacheKey}`, {
      data: data,
      timestamp: Date.now()
    });

    return data;
  } catch (error) {
    console.error('‚ùå API-Football error:', error);
    state.apiStatus.apiFootball = false;

    // Prova con Firebase cache
    const cacheKey = endpoint.replace(/\//g, '_') + '_' + JSON.stringify(params);
    const cached = await firebaseGet(`/cache/${cacheKey}`);
    if (cached && cached.data) {
      console.log('‚úÖ Dati da Firebase cache');
      return cached.data;
    }

    throw error;
  }
}

// === LOAD LEAGUES ===
async function loadLeagues() {
  console.log('üìã Caricamento leghe...');
  state.leaguesLoading = true;
  state.error = null;
  render();

  try {
    // Try localStorage cache first
    const cached = localStorage.getItem(STORAGE.leagues);
    if (cached) {
      const { data, timestamp } = JSON.parse(cached);
      if (Date.now() - timestamp < 3600000) { // 1h
        console.log('‚úÖ Leghe da cache locale:', data.length);
        state.leagues = data;
        state.leaguesLoading = false;
        render();
        return;
      }
    }

    // Try API-Football
    try {
      const response = await apiFootballCall('/leagues', {});
      if (response && response.response) {
        const leagues = response.response.filter(l => l.league && l.league.type === 'League');
        console.log('‚úÖ Leghe da API-Football:', leagues.length);

        state.leagues = leagues.map(l => ({
          id: l.league.id,
          name: l.league.name,
          country: l.country.name,
          logo: l.league.logo,
          season: l.seasons && l.seasons.length ? l.seasons[l.seasons.length - 1].year : 2024
        }));

        // Save to localStorage
        localStorage.setItem(STORAGE.leagues, JSON.stringify({
          data: state.leagues,
          timestamp: Date.now()
        }));

        state.leaguesLoading = false;
        render();
        return;
      }
    } catch (apiError) {
      console.warn('‚ö†Ô∏è API-Football non disponibile, provo Firebase...');
    }

    // Try Firebase
    const firebaseLeagues = await firebaseGet('/leagues');
    if (firebaseLeagues) {
      console.log('‚úÖ Leghe da Firebase');
      state.leagues = firebaseLeagues;
      state.leaguesLoading = false;
      render();
      return;
    }

    // Fallback: dati demo
    console.log('‚ö†Ô∏è Usando dati demo');
    state.leagues = [
      { id: 39, name: 'Premier League', country: 'England', season: 2024 },
      { id: 135, name: 'Serie A', country: 'Italy', season: 2024 },
      { id: 140, name: 'La Liga', country: 'Spain', season: 2024 },
      { id: 78, name: 'Bundesliga', country: 'Germany', season: 2024 },
      { id: 61, name: 'Ligue 1', country: 'France', season: 2024 },
      { id: 94, name: 'Primeira Liga', country: 'Portugal', season: 2024 },
      { id: 88, name: 'Eredivisie', country: 'Netherlands', season: 2024 }
    ];

    // Salva demo in Firebase per future volte
    await firebaseSet('/leagues', state.leagues);

  } catch (error) {
    console.error('‚ùå Errore caricamento leghe:', error);
    state.error = 'Impossibile caricare i campionati. Controlla la connessione.';
  } finally {
    state.leaguesLoading = false;
    render();
  }
}

// === LOAD MATCHES ===
async function loadMatches(leagueId) {
  console.log('‚öΩ Caricamento partite per lega:', leagueId);
  state.matchesLoading = true;
  state.selectedLeague = leagueId;
  state.error = null;
  render();

  try {
    const league = state.leagues.find(l => l.id == leagueId);
    const season = league ? league.season : 2024;

    // Try API-Football
    try {
      const response = await apiFootballCall('/fixtures', {
        league: leagueId,
        season: season,
        next: 50 // Prossime 50 partite
      });

      if (response && response.response) {
        state.matches = response.response.map(f => ({
          id: f.fixture.id,
          date: f.fixture.date,
          status: f.fixture.status.short,
          homeTeam: {
            id: f.teams.home.id,
            name: f.teams.home.name,
            logo: f.teams.home.logo
          },
          awayTeam: {
            id: f.teams.away.id,
            name: f.teams.away.name,
            logo: f.teams.away.logo
          },
          score: f.goals
        }));

        console.log('‚úÖ Partite da API-Football:', state.matches.length);

        if (state.matches.length === 0) {
          state.error = 'Nessuna partita in programma per questo campionato.';
        }

        state.matchesLoading = false;
        render();
        return;
      }
    } catch (apiError) {
      console.warn('‚ö†Ô∏è API-Football non disponibile per partite');
    }

    // Try Firebase
    const firebaseMatches = await firebaseGet(`/matches/league_${leagueId}`);
    if (firebaseMatches) {
      console.log('‚úÖ Partite da Firebase');
      state.matches = firebaseMatches;
      state.matchesLoading = false;
      render();
      return;
    }

    // Fallback: genera partite demo
    console.log('‚ö†Ô∏è Usando partite demo');
    const demoTeams = [
      ['Arsenal', 'Manchester City'],
      ['Liverpool', 'Chelsea'],
      ['Manchester United', 'Tottenham'],
      ['Newcastle', 'Aston Villa'],
      ['Brighton', 'Brentford']
    ];

    state.matches = demoTeams.map((teams, idx) => ({
      id: 1000 + idx,
      date: new Date(Date.now() + idx * 86400000).toISOString(),
      status: 'NS',
      homeTeam: { id: idx * 10, name: teams[0], logo: '' },
      awayTeam: { id: idx * 10 + 1, name: teams[1], logo: '' },
      score: null
    }));

  } catch (error) {
    console.error('‚ùå Errore caricamento partite:', error);
    state.error = 'Errore caricamento partite.';
    state.matches = [];
  } finally {
    state.matchesLoading = false;
    render();
  }
}

// === ANALYZE MATCH ===
async function analyzeMatch(matchIndex) {
  const match = state.matches[matchIndex];
  if (!match) return;

  console.log('üîç Analisi partita:', match.homeTeam.name, 'vs', match.awayTeam.name);

  state.selectedMatch = match;
  state.analysisLoading = true;
  state.view = 'analysis';
  render();

  try {
    const predictions = generatePredictions(match);
    state.analysisData = predictions;
    console.log('‚úÖ Predizioni generate:', predictions);
  } catch (error) {
    console.error('‚ùå Errore analisi:', error);
    state.error = 'Errore durante l\'analisi.';
  } finally {
    state.analysisLoading = false;
    render();
  }
}

// === GENERATE PREDICTIONS ===
function generatePredictions(match) {
  const homeXg = 1.3 + Math.random() * 0.7;
  const awayXg = 1.0 + Math.random() * 0.7;

  const homeCSV = findTeamInCSV(match.homeTeam.name);
  const awayCSV = findTeamInCSV(match.awayTeam.name);

  let finalHomeXg = homeXg;
  let finalAwayXg = awayXg;

  if (homeCSV && homeCSV.xg_for > 0) {
    finalHomeXg = homeXg * 0.7 + (homeCSV.xg_for / Math.max(homeCSV.matches_played, 1)) * 0.3;
  }
  if (awayCSV && awayCSV.xg_for > 0) {
    finalAwayXg = awayXg * 0.7 + (awayCSV.xg_for / Math.max(awayCSV.matches_played, 1)) * 0.3;
  }

  const prob1X2 = calculate1X2(finalHomeXg, finalAwayXg);
  const probBTTS = calculateBTTS(finalHomeXg, finalAwayXg);
  const probOU = calculateOverUnder(finalHomeXg, finalAwayXg);
  const exactScores = calculateExactScores(finalHomeXg, finalAwayXg);

  const predictions = [];

  const sorted1X2 = Object.entries(prob1X2).sort((a, b) => b[1] - a[1]);
  predictions.push({
    market: '1X2',
    selection: sorted1X2[0][0] === 'home' ? '1' : (sorted1X2[0][0] === 'draw' ? 'X' : '2'),
    label: sorted1X2[0][0] === 'home' ? match.homeTeam.name : (sorted1X2[0][0] === 'draw' ? 'Pareggio' : match.awayTeam.name),
    probability: sorted1X2[0][1],
    confidence: clamp(45, 45 + Math.abs(sorted1X2[0][1] - 33) * 1.5, 85)
  });

  predictions.push({
    market: 'GG/NG',
    selection: probBTTS >= 50 ? 'GG' : 'NG',
    label: probBTTS >= 50 ? 'Goal/Goal' : 'NoGoal',
    probability: probBTTS >= 50 ? probBTTS : 100 - probBTTS,
    confidence: clamp(50, 50 + Math.abs(probBTTS - 50) * 0.8, 82)
  });

  predictions.push({
    market: 'O/U 2.5',
    selection: probOU[2.5].over >= 50 ? 'Over 2.5' : 'Under 2.5',
    label: probOU[2.5].over >= 50 ? 'Over 2.5' : 'Under 2.5',
    probability: probOU[2.5].over >= 50 ? probOU[2.5].over : probOU[2.5].under,
    confidence: clamp(50, 50 + Math.abs(probOU[2.5].over - 50) * 0.7, 80)
  });

  exactScores.slice(0, 3).forEach(score => {
    predictions.push({
      market: 'Esatto',
      selection: `${score.home}-${score.away}`,
      label: `${score.home}-${score.away}`,
      probability: score.prob,
      confidence: clamp(55, 55 + score.prob * 0.5, 72),
      value: true
    });
  });

  predictions.sort((a, b) => b.confidence - a.confidence);

  return {
    xG: { home: finalHomeXg, away: finalAwayXg },
    prob1X2,
    probBTTS,
    probOU,
    predictions,
    csvBoost: csvData.loaded && (homeCSV || awayCSV)
  };
}

function calculate1X2(lambdaH, lambdaA) {
  let probHome = 0, probDraw = 0, probAway = 0;
  for (let i = 0; i <= 5; i++) {
    for (let j = 0; j <= 5; j++) {
      const prob = poisson(lambdaH, i) * poisson(lambdaA, j);
      if (i > j) probHome += prob;
      else if (i === j) probDraw += prob;
      else probAway += prob;
    }
  }
  const total = probHome + probDraw + probAway;
  return {
    home: (probHome / total) * 100,
    draw: (probDraw / total) * 100,
    away: (probAway / total) * 100
  };
}

function calculateBTTS(lambdaH, lambdaA) {
  const probH0 = poisson(lambdaH, 0);
  const probA0 = poisson(lambdaA, 0);
  const probNG = probH0 + probA0 - (probH0 * probA0);
  return clamp(25, (1 - probNG) * 100, 75);
}

function calculateOverUnder(lambdaH, lambdaA) {
  const result = {};
  [0.5, 1.5, 2.5, 3.5, 4.5].forEach(line => {
    let probOver = 0;
    for (let i = 0; i <= 7; i++) {
      for (let j = 0; j <= 7; j++) {
        if (i + j > line) {
          probOver += poisson(lambdaH, i) * poisson(lambdaA, j);
        }
      }
    }
    result[line] = {
      over: clamp(10, probOver * 100, 90),
      under: clamp(10, (1 - probOver) * 100, 90)
    };
  });
  return result;
}

function calculateExactScores(lambdaH, lambdaA) {
  const scores = [];
  for (let i = 0; i <= 4; i++) {
    for (let j = 0; j <= 4; j++) {
      const prob = poisson(lambdaH, i) * poisson(lambdaA, j) * 100;
      scores.push({ home: i, away: j, prob });
    }
  }
  return scores.sort((a, b) => b.prob - a.prob);
}

// === CSV FUNCTIONS ===
function findTeamInCSV(teamName) {
  if (!teamName) return null;
  const normalized = teamName.toLowerCase().trim();
  if (csvData.teamStats.has(normalized)) return csvData.teamStats.get(normalized);
  for (const [key, value] of csvData.teamStats.entries()) {
    if (key.includes(normalized) || normalized.includes(key)) return value;
  }
  return null;
}

function parseCSV(text) {
  const lines = text.trim().split('\n');
  if (lines.length < 2) return [];
  const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
  const data = [];
  for (let i = 1; i < lines.length; i++) {
    const values = lines[i].split(',').map(v => v.trim().replace(/^"|"$/g, ''));
    if (values.length === 0) continue;
    const row = {};
    headers.forEach((h, idx) => {
      let val = values[idx] || '';
      if (val && !isNaN(val) && val !== '') val = parseFloat(val);
      row[h] = val;
    });
    data.push(row);
  }
  return data;
}

function processCSVData(rows, filename) {
  if (!rows || rows.length === 0) return;
  const keys = Object.keys(rows[0]);
  if (keys.some(k => k.toLowerCase().includes('team'))) {
    rows.forEach(row => {
      const teamName = (row.team_name || row.Team || row.team || '').toLowerCase().trim();
      if (!teamName) return;
      csvData.teamStats.set(teamName, {
        name: row.team_name || row.Team,
        matches_played: parseFloat(row.matches_played || row.MP || 0),
        xg_for: parseFloat(row.xg_for || row.xG || 0),
        source: filename
      });
    });
  }
}

async function handleCSVUpload(files) {
  if (!files || files.length === 0) return;
  let loaded = 0;
  for (const file of files) {
    try {
      const text = await file.text();
      const rows = parseCSV(text);
      processCSVData(rows, file.name);
      if (!csvData.sources.includes(file.name)) csvData.sources.push(file.name);
      loaded++;
    } catch (e) {
      console.error('Errore CSV:', e);
    }
  }
  csvData.loaded = loaded > 0;
  alert(`‚úÖ ${loaded} CSV caricati! Team: ${csvData.teamStats.size}`);
  render();
}

window.uploadCSV = () => {
  const input = document.createElement('input');
  input.type = 'file';
  input.multiple = true;
  input.accept = '.csv';
  input.onchange = (e) => handleCSVUpload(Array.from(e.target.files));
  input.click();
};

// === NAVIGATION ===
window.goToHome = () => {
  state.view = 'home';
  state.selectedLeague = null;
  state.selectedMatch = null;
  state.error = null;
  render();
};

window.goToMatches = (leagueId) => {
  if (!leagueId) return;
  state.view = 'matches';
  loadMatches(leagueId);
};

window.goToAnalysis = (matchIndex) => {
  analyzeMatch(matchIndex);
};

window.handleSearchInput = (value) => {
  state.searchQuery = value;
  render();
};

// === RENDER ===
function render() {
  const root = document.getElementById('root');

  if (state.view === 'home') {
    root.innerHTML = renderHome();
  } else if (state.view === 'matches') {
    root.innerHTML = renderMatches();
  } else if (state.view === 'analysis') {
    root.innerHTML = renderAnalysis();
  }

  const searchInput = document.getElementById('searchInput');
  if (searchInput) {
    searchInput.value = state.searchQuery;
    searchInput.addEventListener('input', (e) => {
      state.searchQuery = e.target.value;
      updateLeagueList();
    });
  }
}

function updateLeagueList() {
  const listContainer = document.getElementById('leagueListContainer');
  if (listContainer) {
    const filteredLeagues = getFilteredLeagues();
    listContainer.innerHTML = renderLeagueOptions(filteredLeagues);
  }
}

function getFilteredLeagues() {
  return state.leagues.filter(league => {
    const query = state.searchQuery.toLowerCase();
    if (!query) return true;
    return (league.name || '').toLowerCase().includes(query) ||
           (league.country || '').toLowerCase().includes(query);
  });
}

function renderLeagueOptions(leagues) {
  const favoriteLeagues = leagues.filter(l => state.favorites.includes(String(l.id)));
  const otherLeagues = leagues.filter(l => !state.favorites.includes(String(l.id)));

  let html = '<option value="">Tutti i campionati</option>';

  if (favoriteLeagues.length > 0) {
    html += '<optgroup label="‚≠ê Preferiti">';
    favoriteLeagues.forEach(l => {
      html += `<option value="${l.id}">${escapeHtml(l.country || '')}: ${escapeHtml(l.name)}</option>`;
    });
    html += '</optgroup>';
  }

  html += '<optgroup label="üìã Tutti">';
  otherLeagues.slice(0, 50).forEach(l => {
    html += `<option value="${l.id}">${escapeHtml(l.country || '')}: ${escapeHtml(l.name)}</option>`;
  });
  html += '</optgroup>';

  return html;
}

function renderHome() {
  const filteredLeagues = getFilteredLeagues();

  return `
    <div class="max-w-2xl mx-auto px-4 py-6 fade-in">
      <div class="text-center mb-8">
        <h1 class="logo-bettingpro mb-2">BettingPro</h1>
        <p class="text-gray-500 text-sm font-medium">Betting Intelligence Platform</p>
      </div>

      <div class="bg-white rounded-lg p-3 mb-6 shadow-sm">
        <div class="flex items-center justify-between text-xs">
          <div class="flex items-center gap-3">
            <div class="flex items-center">
              <span class="api-status-dot ${state.apiStatus.apiFootball ? 'active' : 'inactive'}"></span>
              <span class="text-gray-600">API-Football</span>
            </div>
            <div class="flex items-center">
              <span class="api-status-dot ${state.apiStatus.footyStats ? 'active' : 'inactive'}"></span>
              <span class="text-gray-600">FootyStats</span>
            </div>
            <div class="flex items-center">
              <span class="api-status-dot ${csvData.loaded ? 'active' : 'inactive'}"></span>
              <span class="text-gray-600">CSV (${csvData.teamStats.size})</span>
            </div>
          </div>
          <button onclick="uploadCSV()" class="text-purple-600 font-semibold hover:underline">
            üìÇ Carica CSV
          </button>
        </div>
      </div>

      <div class="mb-6">
        <input 
          type="text" 
          id="searchInput"
          class="search-input w-full px-5 py-4 rounded-xl text-gray-700 font-medium" 
          placeholder="üîç Campionato, Squadra, ecc."
          autocomplete="off"
        />
      </div>

      <div class="mb-6" id="leagueListContainer">
        <select 
          class="dropdown-select w-full text-gray-800 appearance-none"
          onchange="if(this.value) goToMatches(this.value);"
        >
          ${renderLeagueOptions(filteredLeagues)}
        </select>
      </div>

      ${state.error ? `
        <div class="bg-red-50 border border-red-200 rounded-xl p-4 mb-4">
          <p class="text-red-700 text-sm font-semibold">${escapeHtml(state.error)}</p>
        </div>
      ` : ''}

      ${state.leaguesLoading ? `
        <div class="text-center py-12">
          <div class="w-12 h-12 border-4 border-purple-500 border-t-transparent rounded-full loader mx-auto mb-4"></div>
          <p class="text-gray-600 font-medium">Caricamento campionati...</p>
        </div>
      ` : !state.leagues.length ? `
        <div class="text-center py-12">
          <p class="text-gray-500 text-lg font-medium">üîÑ Click qui per caricare i campionati</p>
          <button onclick="loadLeagues()" class="mt-4 px-6 py-3 bg-purple-600 text-white font-bold rounded-xl hover:bg-purple-700">
            Carica Campionati
          </button>
        </div>
      ` : filteredLeagues.length === 0 ? `
        <div class="text-center py-12">
          <p class="text-gray-500 text-lg font-medium">üîç Nessun campionato trovato</p>
        </div>
      ` : ''}
    </div>
  `;
}

function renderMatches() {
  const league = state.leagues.find(l => l.id == state.selectedLeague);

  return `
    <div class="max-w-2xl mx-auto px-4 py-6 fade-in">
      <div class="flex items-center justify-between mb-6">
        <button onclick="goToHome()" class="text-purple-600 font-bold text-2xl">‚Üê</button>
        <h2 class="text-xl font-bold text-gray-800">${escapeHtml(league?.name || 'Campionato')}</h2>
        <div class="w-8"></div>
      </div>

      ${state.error ? `
        <div class="bg-red-50 border border-red-200 rounded-xl p-4 mb-4">
          <p class="text-red-700 text-sm font-semibold">${escapeHtml(state.error)}</p>
        </div>
      ` : ''}

      ${state.matchesLoading ? `
        <div class="text-center py-12">
          <div class="w-12 h-12 border-4 border-purple-500 border-t-transparent rounded-full loader mx-auto mb-4"></div>
          <p class="text-gray-600 font-medium">Caricamento partite...</p>
        </div>
      ` : state.matches.length === 0 ? `
        <div class="text-center py-12">
          <p class="text-gray-500 text-lg font-medium">üì≠ Nessuna partita in programma</p>
        </div>
      ` : `
        <div class="space-y-3">
          ${state.matches.map((match, idx) => {
            const { date, time } = formatDate(match.date);
            return `
              <div class="match-card bg-white rounded-xl p-4 shadow-sm cursor-pointer" onclick="goToAnalysis(${idx})">
                <div class="flex items-center justify-between mb-3">
                  <span class="text-xs font-bold text-gray-600">${escapeHtml(league?.name || '')}</span>
                  <span class="text-xs text-gray-500 font-medium">${date} ${time}</span>
                </div>
                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-3 flex-1">
                    ${match.homeTeam.logo ? `<img src="${match.homeTeam.logo}" class="w-10 h-10" onerror="this.style.display='none'" />` : '<div class="w-10 h-10 bg-gray-100 rounded-lg flex items-center justify-center"><span class="text-lg">üè†</span></div>'}
                    <span class="font-bold text-gray-800">${escapeHtml(match.homeTeam.name)}</span>
                  </div>
                  <div class="px-4">
                    <span class="text-gray-400 font-bold text-lg">vs</span>
                  </div>
                  <div class="flex items-center gap-3 flex-1 justify-end">
                    <span class="font-bold text-gray-800">${escapeHtml(match.awayTeam.name)}</span>
                    ${match.awayTeam.logo ? `<img src="${match.awayTeam.logo}" class="w-10 h-10" onerror="this.style.display='none'" />` : '<div class="w-10 h-10 bg-gray-100 rounded-lg flex items-center justify-center"><span class="text-lg">‚úàÔ∏è</span></div>'}
                  </div>
                </div>
              </div>
            `;
          }).join('')}
        </div>
      `}
    </div>
  `;
}

function renderAnalysis() {
  const match = state.selectedMatch;
  const data = state.analysisData;

  return `
    <div class="max-w-2xl mx-auto px-4 py-6 fade-in">
      <div class="flex items-center justify-between mb-6">
        <button onclick="state.view='matches'; render();" class="text-purple-600 font-bold text-2xl">‚Üê</button>
        <h2 class="text-lg font-bold text-gray-800 text-center flex-1">${escapeHtml(match?.homeTeam?.name || '')} vs ${escapeHtml(match?.awayTeam?.name || '')}</h2>
        <div class="w-8"></div>
      </div>

      ${state.analysisLoading ? `
        <div class="text-center py-12">
          <div class="w-12 h-12 border-4 border-purple-500 border-t-transparent rounded-full loader mx-auto mb-4"></div>
          <p class="text-gray-600 font-medium pulse">Analisi in corso...</p>
        </div>
      ` : data ? `

        <div class="bg-white rounded-xl p-5 mb-6 shadow-sm">
          <div class="grid grid-cols-3 gap-4 text-center mb-4">
            <div>
              <p class="text-sm text-gray-500 font-semibold mb-1">xG Casa</p>
              <p class="text-3xl font-bold text-purple-600">${data.xG.home.toFixed(2)}</p>
            </div>
            <div>
              <p class="text-sm text-gray-500 font-semibold mb-1">xG Totale</p>
              <p class="text-3xl font-bold text-gray-800">${(data.xG.home + data.xG.away).toFixed(2)}</p>
            </div>
            <div>
              <p class="text-sm text-gray-500 font-semibold mb-1">xG Trasferta</p>
              <p class="text-3xl font-bold text-purple-600">${data.xG.away.toFixed(2)}</p>
            </div>
          </div>
          ${data.csvBoost ? `
            <div class="bg-purple-50 rounded-lg p-2 text-center">
              <p class="text-xs text-purple-700 font-bold">üî• CSV BOOST ATTIVO</p>
            </div>
          ` : ''}
        </div>

        <div class="bg-white rounded-xl p-5 mb-6 shadow-sm">
          <div class="mb-6">
            <div class="flex items-center justify-between mb-2">
              <span class="text-sm font-bold text-gray-700">Classifica Congrua</span>
              <span class="text-sm font-bold text-purple-600">${Math.round(data.prob1X2.home)}</span>
            </div>
            <input type="range" min="0" max="100" value="${Math.round(data.prob1X2.home)}" disabled class="w-full" />
          </div>
          <div>
            <div class="flex items-center justify-between mb-2">
              <span class="text-sm font-bold text-gray-700">Under/Over</span>
              <span class="text-sm font-bold text-purple-600">${Math.round(data.probOU[2.5].over)}</span>
            </div>
            <input type="range" min="0" max="100" value="${Math.round(data.probOU[2.5].over)}" disabled class="w-full" />
          </div>
        </div>

        <div class="bg-gradient-to-br from-purple-700 to-purple-900 rounded-2xl p-6 shadow-lg">
          <h3 class="text-white text-2xl font-bold text-center mb-6">I PRONOSTICI</h3>
          <div class="grid grid-cols-2 gap-4">
            ${data.predictions.slice(0, 6).map(pred => `
              <div class="prono-card">
                <div class="text-xs opacity-80 mb-1">${escapeHtml(pred.market)}</div>
                <div class="text-lg font-bold">${escapeHtml(pred.selection)}</div>
                <div class="text-xs opacity-90 mt-1">${pred.probability.toFixed(0)}%</div>
              </div>
            `).join('')}
          </div>
        </div>

        <div class="flex gap-3 mt-6">
          <button onclick="analyzeMatch(${state.matches.indexOf(match)})" class="flex-1 bg-orange-500 text-white font-bold py-3 px-6 rounded-xl shadow-lg hover:bg-orange-600 transition">
            REPEAT
          </button>
          <button onclick="state.view='matches'; render();" class="flex-1 bg-red-500 text-white font-bold py-3 px-6 rounded-xl shadow-lg hover:bg-red-600 transition">
            &lt; BACK
          </button>
        </div>
      ` : ''}
    </div>
  `;
}

// === INIT ===
console.log('üèÅ Inizializzazione BettingPro...');
(async function init() {
  await loadLeagues();
  render();
  console.log('‚úÖ BettingPro pronto!');
})();

</script>
</body>
</html>

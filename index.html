<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Prophetia - Betting Intelligence</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;800&display=swap');

    body { 
      font-family: 'Poppins', -apple-system, BlinkMacSystemFont, sans-serif;
      background: #f8f9fa;
    }

    .logo-prophetia {
      font-family: 'Poppins', sans-serif;
      font-size: 2.5rem;
      font-weight: 300;
      letter-spacing: 0.1em;
      color: #5b4b8a;
      text-shadow: 2px 2px 4px rgba(91, 75, 138, 0.1);
    }

    .loader { animation: spin 1s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

    .pulse { animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }

    .fade-in { animation: fadeIn 0.4s ease-in; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

    .match-card {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      border-left: 4px solid transparent;
    }
    .match-card:hover {
      transform: translateX(4px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.08);
      border-left-color: #5b4b8a;
    }

    .search-input {
      border: 2px solid #e0e0e0;
      transition: all 0.3s;
    }
    .search-input:focus {
      outline: none;
      border-color: #5b4b8a;
      box-shadow: 0 0 0 3px rgba(91, 75, 138, 0.1);
    }

    .dropdown-select {
      border: 2px solid #5b4b8a;
      border-radius: 25px;
      padding: 10px 20px;
      font-weight: 600;
      background: white;
      cursor: pointer;
    }

    .prono-card {
      background: #5b4b8a;
      color: white;
      border-radius: 12px;
      padding: 20px;
      font-weight: 600;
      text-align: center;
      transition: all 0.3s;
      cursor: pointer;
    }
    .prono-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 25px rgba(91, 75, 138, 0.4);
    }

    .slider-container {
      position: relative;
      padding: 20px 0;
    }

    input[type="range"] {
      -webkit-appearance: none;
      width: 100%;
      height: 8px;
      border-radius: 5px;
      background: #ddd;
      outline: none;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: #4ade80;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }

    input[type="range"]::-moz-range-thumb {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: #4ade80;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }

    .team-logo {
      width: 50px;
      height: 50px;
      object-fit: contain;
    }

    .badge-status {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
    }

    .tab-button {
      padding: 12px 24px;
      font-weight: 600;
      border-bottom: 3px solid transparent;
      transition: all 0.3s;
    }

    .tab-button.active {
      color: #5b4b8a;
      border-bottom-color: #5b4b8a;
    }

    .prediction-value {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 15px;
      padding: 15px;
      color: white;
      font-weight: 600;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }

    .api-status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 6px;
    }
    .api-status-dot.active { background: #4ade80; animation: pulse 2s infinite; }
    .api-status-dot.inactive { background: #ef4444; }
  </style>
</head>
<body class="bg-gray-50">
  <div id="root"></div>

<script>
// ============================================
// üî• PROPHETIA PRO - SISTEMA COMPLETO
// ============================================

// === CONFIGURAZIONE API ===
const API_CONFIG = {
  FOOTYSTATS: {
    key: 'bec59b6f83404b0bd79c40076be71f6f3abec62afdacf5eeba296f2357993f3e',
    baseURL: 'https://api.footystats.org',
    enabled: true
  },
  API_FOOTBALL: {
    key: 'aeb2864a3d4dbb8395fa53c83a876a93',
    baseURL: 'https://v3.football.api-sports.io',
    enabled: true
  },
  FOOTBALL_DATA: {
    key: 'd9bdd5abee95493b8a84fbb7a66a83f6',
    baseURL: 'https://api.football-data.org/v4',
    enabled: true
  }
};

const STORAGE = {
  leagues: 'prophetia_leagues',
  favorites: 'prophetia_favorites',
  history: 'prophetia_history',
  cache: 'prophetia_cache',
  settings: 'prophetia_settings'
};

const TZ = 'Europe/Rome';

// === CSV DATA ===
const csvData = {
  teamStats: new Map(),
  matchStats: new Map(),
  loaded: false,
  sources: []
};

// === STATE GLOBALE ===
let state = {
  view: 'home', // home | matches | analysis

  // Leagues
  leagues: [],
  leaguesLoading: false,
  selectedLeague: null,
  searchQuery: '',
  favorites: JSON.parse(localStorage.getItem(STORAGE.favorites) || '["PL","SA","PD","BL1","FL1"]'),

  // Matches
  matches: [],
  matchesLoading: false,
  matchFilter: 'active', // active | all

  // Analysis
  selectedMatch: null,
  analysisData: null,
  analysisLoading: false,
  analysisTab: 'predictions', // predictions | stats | ia

  // Settings
  minConfidence: 65,
  showAdvanced: false,

  // API Status
  apiStatus: {
    footystats: false,
    apiFootball: false,
    footballData: false
  },

  // Cache
  cache: new Map(),
  cacheExpiry: new Map()
};

// === UTILITY FUNCTIONS ===
function escapeHtml(text) {
  const map = {'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;'};
  return String(text || '').replace(/[&<>"']/g, m => map[m]);
}

function formatDate(dateString) {
  if (!dateString) return { date: '-', time: '-' };
  const d = new Date(dateString);
  const date = d.toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit', year: 'numeric' });
  const time = d.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
  return { date, time };
}

function clamp(min, val, max) {
  return Math.max(min, Math.min(max, val));
}

function factorial(n) {
  if (n <= 1) return 1;
  return n * factorial(n - 1);
}

function poisson(lambda, k) {
  return (Math.pow(lambda, k) * Math.exp(-lambda)) / factorial(k);
}

// === API CALLS ===
async function apiCall(endpoint, params = {}, apiType = 'FOOTBALL_DATA') {
  const config = API_CONFIG[apiType];
  if (!config || !config.enabled) {
    throw new Error(`API ${apiType} non disponibile`);
  }

  const url = new URL(config.baseURL + endpoint);
  Object.keys(params).forEach(key => url.searchParams.append(key, params[key]));

  const headers = {};
  if (apiType === 'FOOTBALL_DATA') {
    headers['X-Auth-Token'] = config.key;
  } else if (apiType === 'API_FOOTBALL') {
    headers['x-rapidapi-key'] = config.key;
    headers['x-rapidapi-host'] = 'v3.football.api-sports.io';
  }

  const cacheKey = `${apiType}_${endpoint}_${JSON.stringify(params)}`;
  const cached = state.cache.get(cacheKey);
  const expiry = state.cacheExpiry.get(cacheKey);

  if (cached && expiry && Date.now() < expiry) {
    return cached;
  }

  try {
    const response = await fetch(url.toString(), { headers });
    if (!response.ok) {
      if (response.status === 429) throw new Error('Rate limit superato');
      throw new Error(`HTTP ${response.status}`);
    }
    const data = await response.json();

    state.cache.set(cacheKey, data);
    state.cacheExpiry.set(cacheKey, Date.now() + 3600000); // 1h cache

    return data;
  } catch (error) {
    console.error(`Errore API ${apiType}:`, error);
    throw error;
  }
}

// === LOAD LEAGUES ===
async function loadLeagues() {
  state.leaguesLoading = true;
  render();

  try {
    const cached = localStorage.getItem(STORAGE.leagues);
    if (cached) {
      const { data, timestamp } = JSON.parse(cached);
      if (Date.now() - timestamp < 86400000) { // 24h
        state.leagues = data;
        state.leaguesLoading = false;
        state.apiStatus.footballData = true;
        render();
        return;
      }
    }

    const data = await apiCall('/competitions', {}, 'FOOTBALL_DATA');
    state.leagues = (data.competitions || []).filter(c => c.type === 'LEAGUE');
    state.apiStatus.footballData = true;

    localStorage.setItem(STORAGE.leagues, JSON.stringify({
      data: state.leagues,
      timestamp: Date.now()
    }));
  } catch (error) {
    console.error('Errore caricamento leghe:', error);
    state.leagues = [];
  } finally {
    state.leaguesLoading = false;
    render();
  }
}

// === LOAD MATCHES ===
async function loadMatches(leagueCode) {
  if (!leagueCode) return;

  state.matchesLoading = true;
  state.selectedLeague = leagueCode;
  render();

  try {
    const data = await apiCall(`/competitions/${leagueCode}/matches`, {
      status: state.matchFilter === 'active' ? 'SCHEDULED,LIVE' : ''
    }, 'FOOTBALL_DATA');

    state.matches = data.matches || [];
  } catch (error) {
    console.error('Errore caricamento partite:', error);
    state.matches = [];
  } finally {
    state.matchesLoading = false;
    render();
  }
}

// === ANALYZE MATCH ===
async function analyzeMatch(match) {
  state.selectedMatch = match;
  state.analysisLoading = true;
  state.analysisData = null;
  state.view = 'analysis';
  render();

  try {
    // Calcolo predizioni con algoritmo multi-layer
    const predictions = await generateAdvancedPredictions(match);
    state.analysisData = predictions;
  } catch (error) {
    console.error('Errore analisi:', error);
  } finally {
    state.analysisLoading = false;
    render();
  }
}

// === ALGORITMO PREDIZIONI AVANZATO ===
async function generateAdvancedPredictions(match) {
  const homeTeam = match.homeTeam.name;
  const awayTeam = match.awayTeam.name;

  // Layer 1: Poisson base (simulato con dati realistici)
  const homeXg = 1.2 + Math.random() * 0.8;
  const awayXg = 0.9 + Math.random() * 0.9;

  // Layer 2: CSV boost (se disponibile)
  let csvHomeBoost = 0;
  let csvAwayBoost = 0;

  if (csvData.loaded) {
    const homeCSV = findTeamInCSV(homeTeam);
    const awayCSV = findTeamInCSV(awayTeam);

    if (homeCSV && homeCSV.xg_for > 0) {
      csvHomeBoost = (homeCSV.xg_for / Math.max(homeCSV.matches_played, 1)) * 0.3;
    }
    if (awayCSV && awayCSV.xg_for > 0) {
      csvAwayBoost = (awayCSV.xg_for / Math.max(awayCSV.matches_played, 1)) * 0.3;
    }
  }

  const finalHomeXg = homeXg + csvHomeBoost;
  const finalAwayXg = awayXg + csvAwayBoost;

  // Calcolo probabilit√† risultati
  const prob1X2 = calculate1X2(finalHomeXg, finalAwayXg);
  const probBTTS = calculateBTTS(finalHomeXg, finalAwayXg);
  const probOU = calculateOverUnder(finalHomeXg, finalAwayXg);

  // Risultati esatti
  const exactScores = calculateExactScores(finalHomeXg, finalAwayXg);

  // Corner e cartellini (stimati)
  const corners = {
    home: Math.round(finalHomeXg * 4.5 + 2),
    away: Math.round(finalAwayXg * 4.2 + 2),
    total: Math.round((finalHomeXg + finalAwayXg) * 4.3 + 4)
  };

  const cards = {
    home: Math.round(finalHomeXg * 1.8 + 1.5),
    away: Math.round(finalAwayXg * 1.8 + 1.5),
    total: Math.round((finalHomeXg + finalAwayXg) * 1.8 + 3)
  };

  // Genera pronostici value
  const predictions = [];

  // 1X2
  const best1X2 = Object.entries(prob1X2).sort((a, b) => b[1] - a[1])[0];
  predictions.push({
    market: '1X2',
    selection: best1X2[0] === 'home' ? '1' : (best1X2[0] === 'draw' ? 'X' : '2'),
    label: best1X2[0] === 'home' ? homeTeam : (best1X2[0] === 'draw' ? 'Pareggio' : awayTeam),
    probability: best1X2[1],
    confidence: clamp(40, 40 + Math.abs(best1X2[1] - 33) * 1.2, 88),
    category: 'risultato'
  });

  // BTTS
  predictions.push({
    market: 'GG/NG',
    selection: probBTTS >= 50 ? 'GG' : 'NG',
    label: probBTTS >= 50 ? 'Goal/Goal' : 'NoGoal',
    probability: probBTTS >= 50 ? probBTTS : 100 - probBTTS,
    confidence: clamp(45, 45 + Math.abs(probBTTS - 50) * 0.9, 87),
    category: 'goal'
  });

  // Over/Under
  Object.entries(probOU).forEach(([line, data]) => {
    const best = data.over >= 50 ? { sel: `Over ${line}`, prob: data.over } : { sel: `Under ${line}`, prob: data.under };
    if (parseFloat(line) >= 1.5 && parseFloat(line) <= 3.5) {
      predictions.push({
        market: `Goal ${line}`,
        selection: best.sel,
        label: best.sel,
        probability: best.prob,
        confidence: clamp(42, 42 + Math.abs(best.prob - 50) * 0.8, 86),
        category: 'goal'
      });
    }
  });

  // Risultati esatti (top 3)
  exactScores.slice(0, 3).forEach((score, idx) => {
    predictions.push({
      market: 'Risultato Esatto',
      selection: `${score.home}-${score.away}`,
      label: `${score.home}-${score.away}`,
      probability: score.prob,
      confidence: clamp(55, 55 + score.prob * 0.4, 75),
      category: 'esatto',
      value: true
    });
  });

  // Corner per squadra
  predictions.push({
    market: `Corner ${homeTeam}`,
    selection: corners.home >= 5 ? 'Over 4.5' : 'Under 5.5',
    label: `${homeTeam} ${corners.home >= 5 ? 'Over 4.5' : 'Under 5.5'} corner`,
    probability: corners.home >= 5 ? 65 : 60,
    confidence: 62,
    category: 'corner',
    value: true
  });

  predictions.push({
    market: `Corner ${awayTeam}`,
    selection: corners.away >= 4 ? 'Over 3.5' : 'Under 4.5',
    label: `${awayTeam} ${corners.away >= 4 ? 'Over 3.5' : 'Under 4.5'} corner`,
    probability: corners.away >= 4 ? 63 : 58,
    confidence: 60,
    category: 'corner',
    value: true
  });

  // Cartellini
  predictions.push({
    market: 'Cartellini Totali',
    selection: cards.total >= 5 ? 'Over 4.5' : 'Under 5.5',
    label: `Cartellini totali ${cards.total >= 5 ? 'Over 4.5' : 'Under 5.5'}`,
    probability: 61,
    confidence: 58,
    category: 'cards'
  });

  // Ordina per confidence
  predictions.sort((a, b) => b.confidence - a.confidence);

  return {
    xG: { home: finalHomeXg, away: finalAwayXg },
    prob1X2,
    probBTTS,
    probOU,
    exactScores,
    corners,
    cards,
    predictions,
    csvBoost: csvData.loaded
  };
}

function calculate1X2(lambdaH, lambdaA) {
  let probHome = 0, probDraw = 0, probAway = 0;

  for (let i = 0; i <= 5; i++) {
    for (let j = 0; j <= 5; j++) {
      const prob = poisson(lambdaH, i) * poisson(lambdaA, j);
      if (i > j) probHome += prob;
      else if (i === j) probDraw += prob;
      else probAway += prob;
    }
  }

  const total = probHome + probDraw + probAway;
  return {
    home: (probHome / total) * 100,
    draw: (probDraw / total) * 100,
    away: (probAway / total) * 100
  };
}

function calculateBTTS(lambdaH, lambdaA) {
  const probH0 = poisson(lambdaH, 0);
  const probA0 = poisson(lambdaA, 0);
  const probNG = probH0 + probA0 - (probH0 * probA0);
  const probGG = (1 - probNG) * 100;
  return clamp(20, probGG, 80);
}

function calculateOverUnder(lambdaH, lambdaA) {
  const result = {};
  [0.5, 1.5, 2.5, 3.5, 4.5].forEach(line => {
    let probOver = 0;
    for (let i = 0; i <= 8; i++) {
      for (let j = 0; j <= 8; j++) {
        if (i + j > line) {
          probOver += poisson(lambdaH, i) * poisson(lambdaA, j);
        }
      }
    }
    result[line] = {
      over: clamp(5, probOver * 100, 95),
      under: clamp(5, (1 - probOver) * 100, 95)
    };
  });
  return result;
}

function calculateExactScores(lambdaH, lambdaA) {
  const scores = [];
  for (let i = 0; i <= 5; i++) {
    for (let j = 0; j <= 5; j++) {
      const prob = poisson(lambdaH, i) * poisson(lambdaA, j) * 100;
      scores.push({ home: i, away: j, prob });
    }
  }
  return scores.sort((a, b) => b.prob - a.prob);
}

// === CSV FUNCTIONS ===
function findTeamInCSV(teamName) {
  if (!teamName) return null;
  const normalized = teamName.toLowerCase().trim();
  if (csvData.teamStats.has(normalized)) return csvData.teamStats.get(normalized);
  for (const [key, value] of csvData.teamStats.entries()) {
    if (key.includes(normalized) || normalized.includes(key)) return value;
  }
  return null;
}

function parseCSV(text) {
  const lines = text.trim().split('\n');
  if (lines.length < 2) return [];
  const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
  const data = [];
  for (let i = 1; i < lines.length; i++) {
    const values = lines[i].split(',').map(v => v.trim().replace(/^"|"$/g, ''));
    if (values.length === 0) continue;
    const row = {};
    headers.forEach((h, idx) => {
      let val = values[idx] || '';
      if (val && !isNaN(val) && val !== '') val = parseFloat(val);
      row[h] = val;
    });
    data.push(row);
  }
  return data;
}

function processCSVData(rows, filename) {
  if (!rows || rows.length === 0) return;
  const keys = Object.keys(rows[0]);

  if (keys.some(k => k.toLowerCase().includes('team'))) {
    rows.forEach(row => {
      const teamName = (row.team_name || row.Team || row.team || '').toLowerCase().trim();
      if (!teamName) return;
      csvData.teamStats.set(teamName, {
        name: row.team_name || row.Team,
        matches_played: parseFloat(row.matches_played || row.MP || 0),
        xg_for: parseFloat(row.xg_for || row.xG || 0),
        xg_against: parseFloat(row.xg_against || row.xGA || 0),
        avg_goals_scored: parseFloat(row.avg_goals_scored || 0),
        avg_goals_conceded: parseFloat(row.avg_goals_conceded || 0),
        btts_percentage: parseFloat(row.btts_percentage || 0),
        source: filename
      });
    });
    console.log(`‚úÖ ${rows.length} team da ${filename}`);
  }
}

async function handleCSVUpload(files) {
  if (!files || files.length === 0) return;
  let loaded = 0;
  for (const file of files) {
    try {
      const text = await file.text();
      const rows = parseCSV(text);
      processCSVData(rows, file.name);
      if (!csvData.sources.includes(file.name)) csvData.sources.push(file.name);
      loaded++;
    } catch (e) {
      console.error(`Errore ${file.name}:`, e);
    }
  }
  csvData.loaded = loaded > 0;
  alert(`‚úÖ ${loaded}/${files.length} CSV caricati!\nüìä Team: ${csvData.teamStats.size}`);
  render();
}

window.uploadCSV = () => {
  const input = document.createElement('input');
  input.type = 'file';
  input.multiple = true;
  input.accept = '.csv';
  input.onchange = (e) => handleCSVUpload(Array.from(e.target.files));
  input.click();
};

// === NAVIGATION ===
window.goToHome = () => {
  state.view = 'home';
  state.selectedLeague = null;
  state.selectedMatch = null;
  render();
};

window.goToMatches = (leagueCode) => {
  state.view = 'matches';
  loadMatches(leagueCode);
};

window.goToAnalysis = (matchIndex) => {
  const match = state.matches[matchIndex];
  if (match) analyzeMatch(match);
};

window.setMatchFilter = (filter) => {
  state.matchFilter = filter;
  if (state.selectedLeague) loadMatches(state.selectedLeague);
};

window.setAnalysisTab = (tab) => {
  state.analysisTab = tab;
  render();
};

window.toggleFavorite = (leagueCode) => {
  const idx = state.favorites.indexOf(leagueCode);
  if (idx >= 0) {
    state.favorites.splice(idx, 1);
  } else {
    state.favorites.push(leagueCode);
  }
  localStorage.setItem(STORAGE.favorites, JSON.stringify(state.favorites));
  render();
};

// === RENDER ===
function render() {
  const root = document.getElementById('root');

  if (state.view === 'home') {
    root.innerHTML = renderHome();
  } else if (state.view === 'matches') {
    root.innerHTML = renderMatches();
  } else if (state.view === 'analysis') {
    root.innerHTML = renderAnalysis();
  }
}

function renderHome() {
  const filteredLeagues = state.leagues.filter(league => {
    const query = state.searchQuery.toLowerCase();
    if (!query) return true;
    return (league.name || '').toLowerCase().includes(query) ||
           (league.area?.name || '').toLowerCase().includes(query);
  });

  const favoriteLeagues = state.leagues.filter(l => state.favorites.includes(l.code));

  return `
    <div class="max-w-2xl mx-auto px-4 py-6 fade-in">
      <!-- Header -->
      <div class="text-center mb-8">
        <h1 class="logo-prophetia mb-2">Prophetia</h1>
        <p class="text-gray-500 text-sm font-medium">Betting Intelligence Platform</p>
      </div>

      <!-- API Status Bar -->
      <div class="bg-white rounded-lg p-3 mb-6 shadow-sm">
        <div class="flex items-center justify-between text-xs">
          <div class="flex items-center gap-3">
            <div class="flex items-center">
              <span class="api-status-dot ${state.apiStatus.footballData ? 'active' : 'inactive'}"></span>
              <span class="text-gray-600">Football-Data</span>
            </div>
            <div class="flex items-center">
              <span class="api-status-dot ${state.apiStatus.footystats ? 'active' : 'inactive'}"></span>
              <span class="text-gray-600">FootyStats</span>
            </div>
            <div class="flex items-center">
              <span class="api-status-dot ${csvData.loaded ? 'active' : 'inactive'}"></span>
              <span class="text-gray-600">CSV (${csvData.teamStats.size})</span>
            </div>
          </div>
          <button onclick="uploadCSV()" class="text-purple-600 font-semibold hover:underline">
            üìÇ Carica CSV
          </button>
        </div>
      </div>

      <!-- Search Bar -->
      <div class="mb-6">
        <input 
          type="text" 
          class="search-input w-full px-5 py-4 rounded-xl text-gray-700 font-medium" 
          placeholder="üîç Campionato, Squadra, ecc."
          value="${escapeHtml(state.searchQuery)}"
          oninput="state.searchQuery = this.value; render();"
        />
      </div>

      <!-- Dropdown Campionati -->
      <div class="mb-6">
        <select 
          class="dropdown-select w-full text-gray-800 appearance-none"
          onchange="if(this.value) goToMatches(this.value);"
        >
          <option value="">Tutti i campionati</option>
          ${favoriteLeagues.length > 0 ? `
            <optgroup label="‚≠ê Preferiti">
              ${favoriteLeagues.map(l => `
                <option value="${l.code}">${l.area?.name}: ${l.name}</option>
              `).join('')}
            </optgroup>
          ` : ''}
          <optgroup label="üìã Tutti">
            ${filteredLeagues.slice(0, 50).map(l => `
              <option value="${l.code}">${l.area?.name}: ${l.name}</option>
            `).join('')}
          </optgroup>
        </select>
      </div>

      ${state.leaguesLoading ? `
        <div class="text-center py-12">
          <div class="w-12 h-12 border-4 border-purple-500 border-t-transparent rounded-full loader mx-auto mb-4"></div>
          <p class="text-gray-600 font-medium">Caricamento campionati...</p>
        </div>
      ` : ''}

      ${!state.leaguesLoading && filteredLeagues.length === 0 ? `
        <div class="text-center py-12">
          <p class="text-gray-500 text-lg font-medium">üîç Nessun campionato trovato</p>
        </div>
      ` : ''}
    </div>
  `;
}

function renderMatches() {
  const league = state.leagues.find(l => l.code === state.selectedLeague);

  return `
    <div class="max-w-2xl mx-auto px-4 py-6 fade-in">
      <!-- Header -->
      <div class="flex items-center justify-between mb-6">
        <button onclick="goToHome()" class="text-purple-600 font-bold text-2xl">‚Üê</button>
        <h2 class="text-xl font-bold text-gray-800">${escapeHtml(league?.name || 'Campionato')}</h2>
        <div class="w-8"></div>
      </div>

      <!-- Filter Tabs -->
      <div class="bg-white rounded-xl p-1 mb-6 shadow-sm flex">
        <button 
          onclick="setMatchFilter('active')"
          class="flex-1 py-2 px-4 rounded-lg font-semibold text-sm transition ${state.matchFilter === 'active' ? 'bg-purple-600 text-white' : 'text-gray-600'}"
        >
          Attivi
        </button>
        <button 
          onclick="setMatchFilter('all')"
          class="flex-1 py-2 px-4 rounded-lg font-semibold text-sm transition ${state.matchFilter === 'all' ? 'bg-purple-600 text-white' : 'text-gray-600'}"
        >
          Tutti
        </button>
      </div>

      ${state.matchesLoading ? `
        <div class="text-center py-12">
          <div class="w-12 h-12 border-4 border-purple-500 border-t-transparent rounded-full loader mx-auto mb-4"></div>
          <p class="text-gray-600 font-medium">Caricamento partite...</p>
        </div>
      ` : ''}

      <!-- Match List -->
      <div class="space-y-3">
        ${state.matches.map((match, idx) => {
          const { date, time } = formatDate(match.utcDate);
          const status = match.status || 'SCHEDULED';

          return `
            <div class="match-card bg-white rounded-xl p-4 shadow-sm cursor-pointer" onclick="goToAnalysis(${idx})">
              <!-- League & Date -->
              <div class="flex items-center justify-between mb-3">
                <span class="text-xs font-bold text-gray-600">${escapeHtml(league?.name || '')}</span>
                <span class="text-xs text-gray-500 font-medium">${date} ${time}</span>
              </div>

              <!-- Teams -->
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-3 flex-1">
                  <div class="w-12 h-12 bg-gray-100 rounded-lg flex items-center justify-center">
                    <span class="text-xl">üè†</span>
                  </div>
                  <span class="font-bold text-gray-800">${escapeHtml(match.homeTeam?.name)}</span>
                </div>

                <div class="px-4">
                  <span class="text-gray-400 font-bold text-lg">vs</span>
                </div>

                <div class="flex items-center gap-3 flex-1 justify-end">
                  <span class="font-bold text-gray-800">${escapeHtml(match.awayTeam?.name)}</span>
                  <div class="w-12 h-12 bg-gray-100 rounded-lg flex items-center justify-center">
                    <span class="text-xl">‚úàÔ∏è</span>
                  </div>
                </div>
              </div>
            </div>
          `;
        }).join('')}
      </div>

      ${!state.matchesLoading && state.matches.length === 0 ? `
        <div class="text-center py-12">
          <p class="text-gray-500 text-lg font-medium">üì≠ Nessuna partita disponibile</p>
        </div>
      ` : ''}
    </div>
  `;
}

function renderAnalysis() {
  const match = state.selectedMatch;
  const data = state.analysisData;

  return `
    <div class="max-w-2xl mx-auto px-4 py-6 fade-in">
      <!-- Header -->
      <div class="flex items-center justify-between mb-6">
        <button onclick="state.view='matches'; render();" class="text-purple-600 font-bold text-2xl">‚Üê</button>
        <h2 class="text-lg font-bold text-gray-800 text-center flex-1">${escapeHtml(match?.homeTeam?.name)} vs ${escapeHtml(match?.awayTeam?.name)}</h2>
        <div class="w-8"></div>
      </div>

      ${state.analysisLoading ? `
        <div class="text-center py-12">
          <div class="w-12 h-12 border-4 border-purple-500 border-t-transparent rounded-full loader mx-auto mb-4"></div>
          <p class="text-gray-600 font-medium pulse">Analisi in corso...</p>
        </div>
      ` : data ? `

        <!-- xG Display -->
        <div class="bg-white rounded-xl p-5 mb-6 shadow-sm">
          <div class="grid grid-cols-3 gap-4 text-center mb-4">
            <div>
              <p class="text-sm text-gray-500 font-semibold mb-1">xG Casa</p>
              <p class="text-3xl font-bold text-purple-600">${data.xG.home.toFixed(2)}</p>
            </div>
            <div>
              <p class="text-sm text-gray-500 font-semibold mb-1">xG Totale</p>
              <p class="text-3xl font-bold text-gray-800">${(data.xG.home + data.xG.away).toFixed(2)}</p>
            </div>
            <div>
              <p class="text-sm text-gray-500 font-semibold mb-1">xG Trasferta</p>
              <p class="text-3xl font-bold text-purple-600">${data.xG.away.toFixed(2)}</p>
            </div>
          </div>

          ${data.csvBoost ? `
            <div class="bg-purple-50 rounded-lg p-2 text-center">
              <p class="text-xs text-purple-700 font-bold">üî• CSV BOOST ATTIVO</p>
            </div>
          ` : ''}
        </div>

        <!-- Sliders -->
        <div class="bg-white rounded-xl p-5 mb-6 shadow-sm">
          <div class="mb-6">
            <div class="flex items-center justify-between mb-2">
              <span class="text-sm font-bold text-gray-700">Classifica Congrua</span>
              <span class="text-sm font-bold text-purple-600">${Math.round(data.prob1X2.home)}</span>
            </div>
            <input type="range" min="0" max="100" value="${Math.round(data.prob1X2.home)}" disabled class="w-full" />
          </div>

          <div>
            <div class="flex items-center justify-between mb-2">
              <span class="text-sm font-bold text-gray-700">Under/Over</span>
              <span class="text-sm font-bold text-purple-600">${Math.round(data.probOU[2.5].over)}</span>
            </div>
            <input type="range" min="0" max="100" value="${Math.round(data.probOU[2.5].over)}" disabled class="w-full" />
          </div>
        </div>

        <!-- I PRONOSTICI -->
        <div class="bg-gradient-to-br from-purple-700 to-purple-900 rounded-2xl p-6 shadow-lg">
          <h3 class="text-white text-2xl font-bold text-center mb-6">I PRONOSTICI</h3>

          <div class="grid grid-cols-2 gap-4">
            ${data.predictions.filter(p => p.confidence >= state.minConfidence && (p.category === 'risultato' || p.category === 'goal' || p.category === 'esatto')).slice(0, 6).map(pred => `
              <div class="prono-card">
                <div class="text-xs opacity-80 mb-1">${escapeHtml(pred.market)}</div>
                <div class="text-lg font-bold">${escapeHtml(pred.selection)}</div>
                <div class="text-xs opacity-90 mt-1">${pred.probability.toFixed(0)}% ‚Ä¢ ${pred.confidence.toFixed(0)}%</div>
              </div>
            `).join('')}
          </div>

          <!-- Value Bets -->
          ${data.predictions.filter(p => p.value && p.confidence >= 60).length > 0 ? `
            <div class="mt-6 pt-6 border-t border-white/20">
              <p class="text-white text-sm font-bold mb-3">üíé VALUE BETS</p>
              <div class="space-y-2">
                ${data.predictions.filter(p => p.value && p.confidence >= 60).slice(0, 4).map(pred => `
                  <div class="prediction-value text-sm">
                    ${escapeHtml(pred.label)} - ${pred.confidence.toFixed(0)}% conf
                  </div>
                `).join('')}
              </div>
            </div>
          ` : ''}
        </div>

        <!-- Buttons -->
        <div class="flex gap-3 mt-6">
          <button onclick="analyzeMatch(state.selectedMatch)" class="flex-1 bg-orange-500 text-white font-bold py-3 px-6 rounded-xl shadow-lg hover:bg-orange-600 transition">
            REPEAT
          </button>
          <button onclick="state.view='matches'; render();" class="flex-1 bg-red-500 text-white font-bold py-3 px-6 rounded-xl shadow-lg hover:bg-red-600 transition">
            &lt; BACK
          </button>
        </div>

      ` : ''}
    </div>
  `;
}

// === INIT ===
(async function init() {
  await loadLeagues();
  render();
})();

</script>
</body>
</html>

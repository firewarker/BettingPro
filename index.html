<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prophecy Hunter - Betting Analysis</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .tabs {
            display: flex;
            background: #f5f5f5;
            border-bottom: 2px solid #ddd;
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            border: none;
            background: transparent;
        }

        .tab:hover {
            background: #e0e0e0;
        }

        .tab.active {
            background: white;
            border-bottom: 3px solid #2a5298;
            color: #2a5298;
        }

        .tab-content {
            display: none;
            padding: 30px;
            animation: fadeIn 0.3s;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }

        select, input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            transition: border 0.3s;
        }

        select:focus, input:focus {
            outline: none;
            border-color: #2a5298;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 1.1em;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            font-weight: bold;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .loading {
            text-align: center;
            padding: 40px;
            display: none;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #2a5298;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .results {
            margin-top: 30px;
        }

        .match-card {
            background: #f9f9f9;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .match-card:hover {
            transform: translateX(5px);
            border-color: #2a5298;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .match-card.selected {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .market-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s;
        }

        .market-card.value-bet {
            border-color: #28a745;
            background: #f0fff4;
        }

        .market-card.high-confidence {
            border-left: 5px solid #ffc107;
        }

        .confidence-bar {
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }

        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745 0%, #ffc107 50%, #dc3545 100%);
            transition: width 0.3s;
        }

        .badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.85em;
            font-weight: bold;
            margin-right: 5px;
        }

        .badge-success {
            background: #28a745;
            color: white;
        }

        .badge-warning {
            background: #ffc107;
            color: black;
        }

        .badge-info {
            background: #17a2b8;
            color: white;
        }

        .settings-section {
            background: #f9f9f9;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .settings-section h3 {
            margin-bottom: 15px;
            color: #2a5298;
        }

        .footystats-manager {
            margin-top: 30px;
            border-top: 3px solid #007bff;
            padding-top: 25px;
        }

        #footyStatsStatus {
            background: #f8f9fa;
            border-left: 4px solid #007bff;
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
        }

        #footyStatsLog {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            max-height: 200px;
            overflow-y: auto;
            font-size: 12px;
            margin-top: 15px;
            font-family: 'Courier New', monospace;
        }

        .btn-file-upload {
            background: #007bff;
            margin-right: 10px;
        }

        .btn-file-clear {
            background: #dc3545;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîÆ Prophecy Hunter</h1>
            <p>Advanced Betting Analysis & Predictions</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('predictions')">üéØ Predictions</button>
            <button class="tab" onclick="switchTab('analysis')">üìä Analysis</button>
            <button class="tab" onclick="switchTab('settings')">‚öôÔ∏è Settings</button>
        </div>

        <!-- TAB PREDICTIONS -->
        <div id="predictions" class="tab-content active">
            <div class="form-group">
                <label>üèÜ Select League</label>
                <select id="leagueSelect" onchange="loadMatches()">
                    <option value="">-- Select a league --</option>
                    <option value="39">üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø Premier League</option>
                    <option value="135">üáÆüáπ Serie A</option>
                    <option value="140">üá™üá∏ La Liga</option>
                    <option value="78">üá©üá™ Bundesliga</option>
                    <option value="61">üá´üá∑ Ligue 1</option>
                    <option value="2">‚≠ê Champions League</option>
                </select>
            </div>

            <div id="matchesList" class="results"></div>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Loading predictions...</p>
            </div>

            <div id="predictionResults" class="results"></div>
        </div>

        <!-- TAB ANALYSIS -->
        <div id="analysis" class="tab-content">
            <h2>üìä Match Analysis</h2>
            <p>Select a match from the Predictions tab to see detailed analysis.</p>
            <div id="analysisContent"></div>
        </div>

        <!-- TAB SETTINGS -->
        <div id="settings" class="tab-content">
            <div class="settings-section">
                <h3>üîë API Configuration</h3>
                <div class="form-group">
                    <label>API-Football Key</label>
                    <input type="text" id="apiKey" placeholder="Enter your API key">
                </div>
                <button class="btn" onclick="saveApiKey()">üíæ Save API Key</button>
            </div>

            <div class="settings-section footystats-manager">
                <h3>üìä FootyStats Data Manager</h3>
                <p style="color: #666; margin-bottom: 20px;">
                    Carica i CSV di FootyStats per usare dati reali (corner, cards, BTTS, xG)
                </p>

                <div style="margin: 20px 0;">
                    <label style="display: block; margin-bottom: 10px; font-weight: bold;">
                        üìÅ Seleziona CSV Files (anche tutti insieme):
                    </label>
                    <input 
                        type="file" 
                        id="footyStatsUpload" 
                        accept=".csv" 
                        multiple 
                        style="margin-bottom: 15px; padding: 8px; border: 2px dashed #007bff; border-radius: 5px; width: 100%;"
                    />
                    <div>
                        <button onclick="loadFootyStatsCSV()" class="btn btn-file-upload">
                            üì§ Upload CSV Files
                        </button>
                        <button onclick="clearFootyStatsDB()" class="btn btn-file-clear">
                            üóëÔ∏è Clear Database
                        </button>
                    </div>
                </div>

                <div id="footyStatsStatus">
                    <strong>Status:</strong> <span id="footyStatsCount">No data loaded</span>
                </div>

                <div id="footyStatsLog">
                    <div style="color: #999; font-style: italic;">Log messages will appear here...</div>
                </div>
            </div>

            <div class="settings-section">
                <h3>üìñ User Guide</h3>
                <ol style="line-height: 2;">
                    <li>Add your API-Football key above</li>
                    <li>Upload FootyStats CSV files for better accuracy</li>
                    <li>Select a league from the Predictions tab</li>
                    <li>Choose a match to analyze</li>
                    <li>View value bets and confidence scores</li>
                </ol>
            </div>
        </div>
    </div>

    <script>
        // =====================================================
        // GLOBAL STATE
        // =====================================================
        const state = {
            selectedLeagueId: null,
            selectedMatch: null,
            apiKey: localStorage.getItem('apiKey') || ''
        };

        // =====================================================
        // TAB MANAGEMENT
        // =====================================================
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        // =====================================================
        // API KEY MANAGEMENT
        // =====================================================
        function saveApiKey() {
            const apiKey = document.getElementById('apiKey').value.trim();
            if (!apiKey) {
                alert('Please enter a valid API key');
                return;
            }
            localStorage.setItem('apiKey', apiKey);
            state.apiKey = apiKey;
            alert('API Key saved successfully! ‚úÖ');
        }

        // Load API key on startup
        document.addEventListener('DOMContentLoaded', function() {
            const savedKey = localStorage.getItem('apiKey');
            if (savedKey) {
                document.getElementById('apiKey').value = savedKey;
                state.apiKey = savedKey;
            }
            initFootyStatsDB();
        });

        // =====================================================
        // FOOTYSTATS CSV UPLOAD SYSTEM
        // =====================================================

        let FOOTYSTATS_DB = {};

        const LEAGUE_MAPPING = {
            'england-premier-league': 39,
            'england-championship': 40,
            'italy-serie-a': 135,
            'italy-serie-b': 136,
            'italy-serie-c-group-a': 137,
            'italy-serie-c-group-c': 138,
            'spain-la-liga': 140,
            'spain-segunda-division': 141,
            'germany-bundesliga': 78,
            'germany-2-bundesliga': 79,
            'france-ligue-1': 61,
            'france-ligue-2': 62,
            'france-national': 556,
            'portugal-primeira-liga': 94,
            'netherlands-eredivisie': 88,
            'belgium-first-division-a': 144,
            'scotland-premiership': 179,
            'turkey-super-lig': 203,
            'brazil-serie-a': 71,
            'argentina-liga-profesional': 128,
            'europe-uefa-champions-league': 2,
            'europe-uefa-europa-league': 3,
            'europe-uefa-europa-conference-league': 848
        };

        function initFootyStatsDB() {
            const stored = localStorage.getItem('footystats_db');
            if (stored) {
                try {
                    FOOTYSTATS_DB = JSON.parse(stored);
                    updateFootyStatsStatus();
                    logFootyStats('‚úÖ Database caricato da localStorage', 'success');
                } catch (e) {
                    logFootyStats('‚ùå Errore caricamento database: ' + e.message, 'error');
                }
            }
        }

        async function loadFootyStatsCSV() {
            const fileInput = document.getElementById('footyStatsUpload');
            const files = fileInput.files;

            if (files.length === 0) {
                alert('Seleziona almeno un file CSV!');
                return;
            }

            logFootyStats(`üîÑ Caricamento di ${files.length} file...`, 'info');

            let successCount = 0;
            let errorCount = 0;

            for (let i = 0; i < files.length; i++) {
                const file = files[i];

                try {
                    const csvText = await readFileAsText(file);
                    const leagueId = extractLeagueId(file.name);

                    if (!leagueId) {
                        logFootyStats(`‚ö†Ô∏è ${file.name}: League non riconosciuta, skipped`, 'warning');
                        errorCount++;
                        continue;
                    }

                    const teamData = parseFootyStatsCSV(csvText);

                    if (!FOOTYSTATS_DB[leagueId]) {
                        FOOTYSTATS_DB[leagueId] = {};
                    }

                    Object.assign(FOOTYSTATS_DB[leagueId], teamData);

                    logFootyStats(`‚úÖ ${file.name}: ${Object.keys(teamData).length} teams imported`, 'success');
                    successCount++;

                } catch (error) {
                    logFootyStats(`‚ùå ${file.name}: ${error.message}`, 'error');
                    errorCount++;
                }
            }

            try {
                localStorage.setItem('footystats_db', JSON.stringify(FOOTYSTATS_DB));
                logFootyStats(`üíæ Database salvato: ${successCount} file OK, ${errorCount} errori`, 'success');
            } catch (e) {
                logFootyStats(`‚ùå Errore salvataggio: ${e.message}`, 'error');
            }

            updateFootyStatsStatus();
            fileInput.value = '';
        }

        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = (e) => reject(new Error('Errore lettura file'));
                reader.readAsText(file);
            });
        }

        function extractLeagueId(filename) {
            const cleanName = filename
                .replace(/teams2?/g, '')
                .replace(/-2025-to-2026-stats\.csv$/, '')
                .replace(/^-+|-+$/g, '');

            return LEAGUE_MAPPING[cleanName] || null;
        }

        function parseFootyStatsCSV(csvText) {
            const lines = csvText.split('\n').filter(line => line.trim());
            if (lines.length < 2) {
                throw new Error('CSV vuoto o invalido');
            }

            const headers = lines[0].split(',');
            const teamData = {};

            const indices = {
                teamName: headers.indexOf('team_name'),
                commonName: headers.indexOf('common_name'),
                cornersTotal: headers.indexOf('corners_per_match'),
                cornersHome: headers.indexOf('corners_per_match_home'),
                cornersAway: headers.indexOf('corners_per_match_away'),
                cardsTotal: headers.indexOf('cards_per_match'),
                cardsHome: headers.indexOf('cards_per_match_home'),
                cardsAway: headers.indexOf('cards_per_match_away'),
                bttsTotal: headers.indexOf('btts_percentage'),
                bttsHome: headers.indexOf('btts_percentage_home'),
                bttsAway: headers.indexOf('btts_percentage_away'),
                xgFor: headers.indexOf('xg_for_avg_overall'),
                xgAgainst: headers.indexOf('xg_against_avg_overall')
            };

            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',');

                if (values.length < headers.length - 5) continue;

                const teamName = values[indices.teamName]?.trim();
                const commonName = values[indices.commonName]?.trim();

                if (!teamName) continue;

                const key = commonName || teamName;

                teamData[key] = {
                    fullName: teamName,
                    corners: {
                        overall: parseFloat(values[indices.cornersTotal]) || 0,
                        home: parseFloat(values[indices.cornersHome]) || 0,
                        away: parseFloat(values[indices.cornersAway]) || 0
                    },
                    cards: {
                        overall: parseFloat(values[indices.cardsTotal]) || 0,
                        home: parseFloat(values[indices.cardsHome]) || 0,
                        away: parseFloat(values[indices.cardsAway]) || 0
                    },
                    btts: {
                        overall: parseFloat(values[indices.bttsTotal]) || 0,
                        home: parseFloat(values[indices.bttsHome]) || 0,
                        away: parseFloat(values[indices.bttsAway]) || 0
                    },
                    xg: {
                        for_overall: parseFloat(values[indices.xgFor]) || 0,
                        against_overall: parseFloat(values[indices.xgAgainst]) || 0
                    }
                };
            }

            return teamData;
        }

        function getFootyStatsData(teamName, leagueId) {
            if (!FOOTYSTATS_DB[leagueId]) return null;

            if (FOOTYSTATS_DB[leagueId][teamName]) {
                return FOOTYSTATS_DB[leagueId][teamName];
            }

            const normalized = teamName.toLowerCase()
                .replace(/\s+/g, '')
                .replace(/fc|afc|cf|sc|ac|us|ssc/g, '');

            for (const [key, value] of Object.entries(FOOTYSTATS_DB[leagueId])) {
                const keyNormalized = key.toLowerCase()
                    .replace(/\s+/g, '')
                    .replace(/fc|afc|cf|sc|ac|us|ssc/g, '');

                if (keyNormalized.includes(normalized) || normalized.includes(keyNormalized)) {
                    return value;
                }
            }

            return null;
        }

        function clearFootyStatsDB() {
            if (confirm('Sei sicuro di voler cancellare tutti i dati FootyStats?')) {
                FOOTYSTATS_DB = {};
                localStorage.removeItem('footystats_db');
                updateFootyStatsStatus();
                logFootyStats('üóëÔ∏è Database cancellato', 'info');
            }
        }

        function updateFootyStatsStatus() {
            const statusEl = document.getElementById('footyStatsCount');

            if (!statusEl) return;

            const leagueCount = Object.keys(FOOTYSTATS_DB).length;
            let totalTeams = 0;

            for (const leagueId in FOOTYSTATS_DB) {
                totalTeams += Object.keys(FOOTYSTATS_DB[leagueId]).length;
            }

            if (leagueCount === 0) {
                statusEl.textContent = 'No data loaded';
                statusEl.style.color = '#999';
            } else {
                statusEl.innerHTML = `<strong style="color: green;">${leagueCount} leagues, ${totalTeams} teams loaded ‚úÖ</strong>`;
            }
        }

        function logFootyStats(message, type = 'info') {
            const logEl = document.getElementById('footyStatsLog');
            if (!logEl) return;

            const colors = {
                success: '#28a745',
                error: '#dc3545',
                warning: '#ffc107',
                info: '#17a2b8'
            };

            const timestamp = new Date().toLocaleTimeString('it-IT');
            const logEntry = document.createElement('div');
            logEntry.style.color = colors[type] || '#000';
            logEntry.style.marginBottom = '5px';
            logEntry.textContent = `[${timestamp}] ${message}`;

            logEl.insertBefore(logEntry, logEl.firstChild);

            while (logEl.children.length > 50) {
                logEl.removeChild(logEl.lastChild);
            }
        }

        // =====================================================
        // MATCH LOADING & PREDICTIONS (SIMPLIFIED DEMO)
        // =====================================================

        function loadMatches() {
            const leagueId = document.getElementById('leagueSelect').value;
            if (!leagueId) return;

            state.selectedLeagueId = leagueId;

            // Demo matches
            const matchesList = document.getElementById('matchesList');
            matchesList.innerHTML = `
                <h3>üìÖ Upcoming Matches</h3>
                <div class="match-card" onclick="analyzeMatch('Arsenal', 'Liverpool')">
                    <strong>Arsenal vs Liverpool</strong><br>
                    <small>Saturday, 3:00 PM</small>
                </div>
                <div class="match-card" onclick="analyzeMatch('Manchester City', 'Chelsea')">
                    <strong>Manchester City vs Chelsea</strong><br>
                    <small>Sunday, 4:30 PM</small>
                </div>
            `;
        }

        function analyzeMatch(homeTeam, awayTeam) {
            state.selectedMatch = { homeTeam: { name: homeTeam }, awayTeam: { name: awayTeam } };

            const footyHome = getFootyStatsData(homeTeam, state.selectedLeagueId);
            const footyAway = getFootyStatsData(awayTeam, state.selectedLeagueId);

            let resultsHTML = `<h2>üéØ Analysis: ${homeTeam} vs ${awayTeam}</h2>`;

            if (footyHome && footyAway) {
                console.log('‚úÖ FootyStats data trovati!');
                const homeCorners = footyHome.corners.home;
                const awayCorners = footyAway.corners.away;
                const totalCorners = homeCorners + awayCorners;

                resultsHTML += `
                    <div class="market-card value-bet">
                        <h3>Over 9.5 Corners</h3>
                        <p><strong>Predicted Total:</strong> ${totalCorners.toFixed(2)} corners</p>
                        <p><strong>Source:</strong> <span class="badge badge-success">FootyStats Data</span></p>
                        <p><strong>Confidence:</strong> 85%</p>
                        <div class="confidence-bar">
                            <div class="confidence-fill" style="width: 85%;"></div>
                        </div>
                    </div>
                `;
            } else {
                resultsHTML += `
                    <div class="market-card">
                        <p>‚ö†Ô∏è No FootyStats data available. Using estimated values.</p>
                        <p>Upload CSV files in Settings for better accuracy!</p>
                    </div>
                `;
            }

            document.getElementById('predictionResults').innerHTML = resultsHTML;
        }
    </script>
</body>
</html>

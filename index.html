<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Prophecy Hunter Pro — League → Fixtures → Analysis</title>
  <style>
    :root{
      --bg1:#0b1220; --bg2:#101b2e; --card:rgba(255,255,255,.06);
      --card2:rgba(255,255,255,.09); --bd:rgba(255,255,255,.12);
      --txt:rgba(255,255,255,.92); --mut:rgba(255,255,255,.72);
      --a:#7c3aed; --b:#06b6d4; --g:#22c55e; --y:#fbbf24; --r:#ef4444;
      --shadow: 0 16px 50px rgba(0,0,0,.35);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--sans); color:var(--txt);
      background: radial-gradient(1200px 700px at 15% 5%, rgba(124,58,237,.25), transparent 60%),
                  radial-gradient(900px 600px at 85% 10%, rgba(6,182,212,.22), transparent 55%),
                  linear-gradient(180deg, var(--bg1), var(--bg2));
      min-height:100vh;
    }
    header{
      max-width:1400px; margin:0 auto; padding:18px 16px 8px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .brand h1{margin:0; font-size:18px; letter-spacing:.6px}
    .brand p{margin:2px 0 0; color:var(--mut); font-size:12px}
    .actions{display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:flex-end}
    .btn{
      border:1px solid var(--bd); background: linear-gradient(135deg, rgba(124,58,237,.35), rgba(6,182,212,.18));
      color:var(--txt); padding:10px 12px; border-radius:12px; cursor:pointer;
      font-weight:650; letter-spacing:.3px; box-shadow: 0 10px 28px rgba(0,0,0,.22);
    }
    .btn.secondary{ background: rgba(255,255,255,.07); }
    .btn.danger{ background: linear-gradient(135deg, rgba(239,68,68,.32), rgba(249,115,22,.18));}
    .btn:disabled{opacity:.55; cursor:not-allowed}
    .pill{
      border:1px solid var(--bd); background: rgba(255,255,255,.06);
      padding:8px 10px; border-radius:12px; font-family:var(--mono); font-size:12px; color:var(--mut);
    }

    .wrap{max-width:1400px; margin:0 auto; padding:12px 16px 28px;}
    .grid{
      display:grid; grid-template-columns: 340px 1fr 420px; gap:14px;
    }
    .card{
      background: var(--card); border:1px solid var(--bd); border-radius:18px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardHead{
      padding:12px 14px; display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(255,255,255,.06), transparent);
    }
    .cardHead h2{margin:0; font-size:13px; color:rgba(255,255,255,.88); letter-spacing:.4px}
    .cardBody{padding:12px 14px;}
    .muted{color:var(--mut); font-size:12px; line-height:1.35}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    input, select{
      background: rgba(0,0,0,.25); border:1px solid rgba(255,255,255,.14);
      color:var(--txt); padding:10px 10px; border-radius:12px; outline:none;
    }
    input::placeholder{color:rgba(255,255,255,.45)}
    .list{display:flex; flex-direction:column; gap:8px}
    .item{
      border:1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.05);
      padding:10px 10px; border-radius:14px; cursor:pointer;
      transition: transform .14s ease, background .14s ease, border-color .14s ease;
    }
    .item:hover{transform: translateY(-1px); background: rgba(255,255,255,.08)}
    .item.active{border-color: rgba(124,58,237,.55); background: rgba(124,58,237,.18)}
    .itemTop{display:flex; align-items:center; justify-content:space-between; gap:10px}
    .itemTitle{font-weight:750; font-size:13px}
    .badge{
      font-family:var(--mono); font-size:11px; color:rgba(255,255,255,.82);
      border:1px solid rgba(255,255,255,.14); padding:4px 8px; border-radius:999px;
      background: rgba(0,0,0,.22);
    }
    .sub{margin-top:4px; color:var(--mut); font-size:12px}
    .kpi{display:grid; grid-template-columns: repeat(4,1fr); gap:10px}
    .k{
      background: rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12);
      border-radius:14px; padding:10px; text-align:center;
    }
    .k .n{font-size:18px; font-weight:850}
    .k .l{font-size:11px; color:var(--mut); margin-top:3px}
    .hr{height:1px; background: rgba(255,255,255,.12); margin:12px 0}
    .small{font-size:12px}
    .mono{font-family:var(--mono)}
    .good{color:var(--g)} .warn{color:var(--y)} .bad{color:var(--r)}
    .bar{height:8px; background: rgba(255,255,255,.10); border-radius:99px; overflow:hidden; margin-top:6px}
    .fill{height:100%; background: linear-gradient(90deg, var(--r), var(--y), var(--g)); width:0%}
    .twoCol{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
    .table{width:100%; border-collapse:separate; border-spacing:0 8px}
    .table td{padding:10px 10px; background: rgba(0,0,0,.22); border:1px solid rgba(255,255,255,.12)}
    .table tr td:first-child{border-radius:12px 0 0 12px}
    .table tr td:last-child{border-radius:0 12px 12px 0; text-align:right; font-family:var(--mono)}
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:7px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      cursor:pointer;
      user-select:none;
      font-weight:750;
      font-size:12px;
    }
    .chip.active{
      border-color: rgba(34,197,94,.65);
      background: rgba(34,197,94,.16);
    }

    /* Tracker modal */
    .modal{
      position:fixed; inset:0; display:none; align-items:center; justify-content:center;
      background: rgba(0,0,0,.66); z-index:999;
    }
    .modal.active{display:flex}
    .modalBox{
      width:min(1100px, 94vw); max-height:90vh; overflow:auto;
      background: linear-gradient(180deg, rgba(18,30,54,.96), rgba(14,22,40,.96));
      border:1px solid rgba(255,255,255,.14);
      border-radius:18px; box-shadow: 0 20px 70px rgba(0,0,0,.55);
    }
    .modalTop{
      position:sticky; top:0; background: rgba(14,22,40,.98);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:12px 14px; border-bottom:1px solid rgba(255,255,255,.12);
    }
    .x{cursor:pointer; font-size:26px; line-height:1; padding:2px 8px}
    .predRow{
      display:grid; grid-template-columns: 1.6fr .9fr .7fr .8fr .9fr; gap:10px;
      padding:10px; border:1px solid rgba(255,255,255,.12); border-radius:14px;
      background: rgba(255,255,255,.05);
      align-items:center;
    }
    .predRow .s{font-size:12px; color:var(--mut)}
    .predRow .t{font-weight:800}
    .right{text-align:right}
    @media (max-width:1100px){
      .grid{grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <h1>Prophecy Hunter Pro</h1>
      <p>League → Fixtures → Analysis → Save Pick → Auto Check Results</p>
    </div>
    <div class="actions">
      <span class="pill">Season: <span id="seasonLabel" class="mono">2025</span></span>
      <span class="pill">TZ: <span class="mono">Europe/Rome</span></span>
      <button class="btn secondary" id="btnLeagues">Carica leghe</button>
      <button class="btn secondary" id="btnTracker">Tracker</button>
      <button class="btn danger" id="btnReset">Reset app</button>
    </div>
  </header>

  <div class="wrap">
    <div class="grid">
      <!-- LEAGUES -->
      <section class="card">
        <div class="cardHead">
          <h2>Leghe (da API)</h2>
          <span class="badge" id="leaguesCount">0</span>
        </div>
        <div class="cardBody">
          <div class="row">
            <input id="leagueSearch" style="flex:1" placeholder="Cerca lega o paese..." />
          </div>
          <div class="hr"></div>
          <div class="muted">Suggerimento: prima “Carica leghe”, poi seleziona una lega per vedere il palinsesto.</div>
          <div class="hr"></div>
          <div id="leaguesList" class="list"></div>
        </div>
      </section>

      <!-- FIXTURES -->
      <section class="card">
        <div class="cardHead">
          <h2>Palinsesto lega</h2>
          <span class="badge" id="fixturesCount">0</span>
        </div>
        <div class="cardBody">
          <div class="row">
            <input id="fromDate" type="date" />
            <input id="toDate" type="date" />
            <button class="btn" id="btnFixtures">Carica palinsesto</button>
          </div>
          <div class="row" style="margin-top:10px">
            <input id="fixtureSearch" style="flex:1" placeholder="Cerca squadra..." />
            <select id="statusFilter">
              <option value="all">Tutti</option>
              <option value="upcoming">Solo upcoming</option>
              <option value="live">Live</option>
              <option value="finished">Finiti</option>
            </select>
          </div>
          <div class="hr"></div>
          <div class="muted" id="fixturesHint">Seleziona una lega per vedere le partite.</div>
          <div class="hr"></div>
          <div id="fixturesList" class="list"></div>
        </div>
      </section>

      <!-- ANALYSIS -->
      <section class="card">
        <div class="cardHead">
          <h2>Analisi & Pronostico</h2>
          <span class="badge" id="analysisBadge">—</span>
        </div>
        <div class="cardBody">
          <div id="analysisEmpty" class="muted">
            Seleziona una partita dal palinsesto per vedere analisi, pronostico top e selezionare un prono.
          </div>

          <div id="analysisPanel" style="display:none">
            <div class="item" style="cursor:default">
              <div class="itemTop">
                <div class="itemTitle" id="aTitle">—</div>
                <span class="badge" id="aLeague">—</span>
              </div>
              <div class="sub" id="aMeta">—</div>
              <div class="bar"><div class="fill" id="aConfFill"></div></div>
              <div class="sub">Confidence: <span class="mono" id="aConf">—</span></div>
            </div>

            <div class="hr"></div>

            <div class="kpi">
              <div class="k"><div class="n mono" id="kXgH">—</div><div class="l">xG casa</div></div>
              <div class="k"><div class="n mono" id="kXgA">—</div><div class="l">xG ospite</div></div>
              <div class="k"><div class="n mono" id="kGG">—</div><div class="l">GG%</div></div>
              <div class="k"><div class="n mono" id="kO25">—</div><div class="l">Over 2.5%</div></div>
            </div>

            <div class="hr"></div>

            <div class="twoCol">
              <div>
                <div class="muted">Pronostico TOP (quello più probabile)</div>
                <div class="item" style="cursor:default; margin-top:10px">
                  <div class="itemTop">
                    <div class="itemTitle" id="topPick">—</div>
                    <span class="badge" id="topProb">—</span>
                  </div>
                  <div class="sub" id="topExtra">Odds/Value (se disponibili): —</div>
                  <div class="row" style="margin-top:10px">
                    <span class="chip" id="chipSaveTop">Salva questo prono</span>
                  </div>
                </div>
              </div>
              <div>
                <div class="muted">Mercati (probabilità + value se c’è quota)</div>
                <table class="table" id="marketsTable"></table>
              </div>
            </div>

            <div class="hr"></div>

            <div class="muted">
              Nota: corner/cartellini pre-match dipendono dalla copertura della lega e dalla disponibilità dati; se non ci sono dati, l’app non forza numeri “fake”.
            </div>
          </div>
        </div>
      </section>
    </div>
  </div>

  <!-- TRACKER MODAL -->
  <div class="modal" id="trackerModal">
    <div class="modalBox">
      <div class="modalTop">
        <div>
          <div style="font-weight:900">Tracker pronostici</div>
          <div class="muted">Salva pronostici e premi “Aggiorna risultati” per controllare automaticamente.</div>
        </div>
        <div class="row">
          <button class="btn secondary" id="btnRefreshResults">Aggiorna risultati</button>
          <button class="btn danger" id="btnClearTracker">Svuota tracker</button>
          <div class="x" id="btnCloseTracker">&times;</div>
        </div>
      </div>
      <div class="cardBody">
        <div class="kpi" style="margin-bottom:12px">
          <div class="k"><div class="n mono" id="tTotal">0</div><div class="l">Totali</div></div>
          <div class="k"><div class="n mono" id="tPending">0</div><div class="l">Pending</div></div>
          <div class="k"><div class="n mono" id="tWon">0</div><div class="l good">Vinti</div></div>
          <div class="k"><div class="n mono" id="tHit">0%</div><div class="l">Hit rate</div></div>
        </div>
        <div id="trackerList" class="list"></div>
      </div>
    </div>
  </div>

<script>
/* =========================
   CONFIG
========================= */
const API_BASE = "https://v3.football.api-sports.io";
const API_KEY  = "aeb2864a3d4dbb8395fa53c83a876a93";
const TZ = "Europe/Rome";
const DEFAULT_SEASON = 2025; // stagione 2025-26
document.getElementById("seasonLabel").textContent = DEFAULT_SEASON;

const LS = {
  leaguesCache: "ph_leagues_cache_v1",
  tracker: "ph_tracker_v1"
};

let state = {
  leagues: [],
  selectedLeague: null, // {leagueId, name, country, season}
  fixtures: [],
  selectedFixture: null, // normalized fixture object
  analysis: null
};

/* =========================
   UTILS
========================= */
const $ = (id) => document.getElementById(id);

function clamp(min, val, max){ return Math.max(min, Math.min(max, val)); }
function fmtPct(x){ return `${(Math.round(x*10)/10).toFixed(1)}%`; }
function fmtNum(x){ return (Math.round(x*100)/100).toFixed(2); }
function isoDate(d){ return d.toISOString().slice(0,10); }
function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

function chunk(arr, size){
  const out=[]; for(let i=0;i<arr.length;i+=size) out.push(arr.slice(i,i+size));
  return out;
}

async function apiGet(path, params={}){
  const url = new URL(API_BASE + path);
  Object.entries(params).forEach(([k,v]) => {
    if(v !== undefined && v !== null && v !== "") url.searchParams.set(k, v);
  });

  const res = await fetch(url.toString(), {
    method: "GET",
    headers: {
      "x-rapidapi-key": API_KEY,
      "x-rapidapi-host": "v3.football.api-sports.io"
    }
  });

  const data = await res.json().catch(() => ({}));
  if(!res.ok){
    const msg = (data && (data.message || data.errors)) ? JSON.stringify(data.message || data.errors) : res.statusText;
    throw new Error(`HTTP ${res.status} ${msg}`);
  }
  if(data && data.errors && Object.keys(data.errors).length){
    // non sempre è fatale, ma lo consideriamo errore per fallback
    throw new Error(`API errors: ${JSON.stringify(data.errors)}`);
  }
  return data;
}

function setBusy(btn, busy, textBusy){
  if(!btn) return;
  btn.disabled = busy;
  if(textBusy){
    btn.dataset.orig = btn.dataset.orig || btn.textContent;
    btn.textContent = busy ? textBusy : btn.dataset.orig;
  }
}

function niceFixtureTime(f){
  const d = new Date(f.fixture.date);
  const date = d.toLocaleDateString("it-IT",{weekday:"short", day:"2-digit", month:"2-digit"});
  const time = d.toLocaleTimeString("it-IT",{hour:"2-digit", minute:"2-digit"});
  return `${date} ${time}`;
}

function statusBucket(statusShort){
  if(["FT","AET","PEN"].includes(statusShort)) return "finished";
  if(["1H","HT","2H","ET","BT","P","INT","LIVE"].includes(statusShort)) return "live";
  return "upcoming";
}

/* =========================
   MATH: POISSON (goals)
========================= */
function factorial(n){
  let r=1; for(let i=2;i<=n;i++) r*=i; return r;
}
function poissonP(lambda, k){
  return (Math.pow(lambda, k) * Math.exp(-lambda)) / factorial(k);
}
function probGG(lh, la){
  return (1 - Math.exp(-lh)) * (1 - Math.exp(-la)) * 100;
}
function probOverTotal(lh, la, threshold){
  const lt = lh + la;
  let under=0;
  for(let k=0;k<=Math.floor(threshold);k++) under += poissonP(lt, k);
  return (1-under) * 100;
}
function prob1X2(lh, la){
  // somma probabilità su griglia 0..10
  let p1=0, px=0, p2=0;
  for(let h=0;h<=10;h++){
    for(let a=0;a<=10;a++){
      const p = poissonP(lh,h) * poissonP(la,a);
      if(h>a) p1 += p;
      else if(h===a) px += p;
      else p2 += p;
    }
  }
  return { "1": p1*100, "X": px*100, "2": p2*100 };
}

/* =========================
   STATS -> xG (goals)
   Usa team statistics se disponibili; altrimenti fallback sensato.
========================= */
function safeGet(obj, path, fallback=null){
  try{
    return path.split(".").reduce((acc, k) => acc && acc[k] !== undefined ? acc[k] : undefined, obj) ?? fallback;
  }catch(e){ return fallback; }
}

function buildXG(homeStats, awayStats, injuries, fixture){
  // Obiettivo: numeri diversi per match, basati su medie squadra (home/away) + piccoli aggiustamenti.
  const hf = parseFloat(safeGet(homeStats, "goals.for.average.home", safeGet(homeStats,"goals.for.average.total", "1.40")));
  const ha = parseFloat(safeGet(homeStats, "goals.against.average.home", safeGet(homeStats,"goals.against.average.total", "1.20")));
  const af = parseFloat(safeGet(awayStats, "goals.for.average.away", safeGet(awayStats,"goals.for.average.total", "1.20")));
  const aa = parseFloat(safeGet(awayStats, "goals.against.average.away", safeGet(awayStats,"goals.against.average.total", "1.35")));

  // base: attacco casa vs difesa trasferta e viceversa
  let xgH = (hf * 0.62) + (aa * 0.38);
  let xgA = (af * 0.62) + (ha * 0.38);

  // home advantage
  xgH *= 1.10;
  xgA *= 0.95;

  // malus infortuni/assenze (se endpoint restituisce dati)
  const injHome = injuries?.homeCount ?? 0;
  const injAway = injuries?.awayCount ?? 0;
  const mH = clamp(0.70, 1 - injHome*0.04, 1.00);
  const mA = clamp(0.70, 1 - injAway*0.04, 1.00);
  xgH *= mH;
  xgA *= mA;

  // clamp realistico
  xgH = clamp(0.25, xgH, 3.60);
  xgA = clamp(0.25, xgA, 3.60);

  return { xgH, xgA, injHome, injAway };
}

/* =========================
   ODDS (if available)
========================= */
function parseOdds(oddsPayload){
  // Struttura odds: response[0].bookmakers[].bets[]
  // Non tutte le leghe hanno copertura odds.
  try{
    const r = oddsPayload?.response?.[0];
    if(!r) return null;
    const bkm = r.bookmakers?.[0];
    if(!bkm) return null;

    const getBet = (name) => bkm.bets?.find(x => (x.name || "").toLowerCase().includes(name.toLowerCase()));
    const out = {};

    // 1X2 (Match Winner)
    const mw = getBet("Match Winner") || getBet("1X2") || getBet("Winner");
    if(mw){
      // values: [{value:"Home", odd:"1.90"}, ...] oppure "1","X","2"
      const map = {};
      for(const v of mw.values || []){
        const key = (v.value || "").toString().toUpperCase();
        const odd = parseFloat(v.odd);
        if(!odd) continue;
        if(["1","HOME"].includes(key)) map["1"] = odd;
        else if(["X","DRAW"].includes(key)) map["X"] = odd;
        else if(["2","AWAY"].includes(key)) map["2"] = odd;
      }
      if(Object.keys(map).length) out["1X2"] = map;
    }

    // BTTS
    const btts = getBet("Both Teams Score") || getBet("BTTS");
    if(btts){
      let gg=null, ng=null;
      for(const v of btts.values || []){
        const key = (v.value || "").toString().toLowerCase();
        const odd = parseFloat(v.odd);
        if(key.includes("yes")) gg = odd;
        if(key.includes("no")) ng = odd;
      }
      if(gg || ng) out["BTTS"] = { GG: gg, NG: ng };
    }

    // Over/Under 2.5
    const ou = getBet("Goals Over/Under") || getBet("Over/Under");
    if(ou){
      let o25=null, u25=null, o15=null, u15=null, u45=null, o45=null;
      for(const v of ou.values || []){
        const key = (v.value || "").toString();
        const odd = parseFloat(v.odd);
        if(key.includes("Over 2.5")) o25 = odd;
        if(key.includes("Under 2.5")) u25 = odd;
        if(key.includes("Over 1.5")) o15 = odd;
        if(key.includes("Under 1.5")) u15 = odd;
        if(key.includes("Over 4.5")) o45 = odd;
        if(key.includes("Under 4.5")) u45 = odd;
      }
      out["OU"] = { o15, u15, o25, u25, o45, u45 };
    }

    return Object.keys(out).length ? out : null;
  }catch(e){
    return null;
  }
}

function impliedProbPct(odd){
  if(!odd || odd <= 1.0001) return null;
  return (1/odd) * 100;
}

/* =========================
   ANALYSIS ENGINE (goals + odds + injuries + referee name)
   Corner/cards: mostrati solo se disponibili in statistiche pre-match (spesso non lo sono).
========================= */
function buildMarketsFromModel(model, odds){
  const { xgH, xgA } = model;
  const pGG  = probGG(xgH, xgA);
  const pO15 = probOverTotal(xgH, xgA, 1.5);
  const pO25 = probOverTotal(xgH, xgA, 2.5);
  const pU25 = 100 - pO25;
  const pU45 = 100 - probOverTotal(xgH, xgA, 4.5);
  const r1x2 = prob1X2(xgH, xgA);
  const dc = {
    "1X": r1x2["1"] + r1x2["X"],
    "X2": r1x2["X"] + r1x2["2"],
    "12": r1x2["1"] + r1x2["2"]
  };

  // Candidati “giocabili” (alta probabilità)
  const candidates = [
    { key:"O15", label:"Over 1.5", prob:pO15, odd: odds?.OU?.o15 },
    { key:"U45", label:"Under 4.5", prob:pU45, odd: odds?.OU?.u45 },
    { key:"BTTS_GG", label:"GG", prob:pGG, odd: odds?.BTTS?.GG },
    { key:"OU25_O", label:"Over 2.5", prob:pO25, odd: odds?.OU?.o25 },
    { key:"OU25_U", label:"Under 2.5", prob:pU25, odd: odds?.OU?.u25 },
    { key:"DC_1X", label:"1X", prob: dc["1X"], odd: null },
    { key:"DC_X2", label:"X2", prob: dc["X2"], odd: null },
    { key:"1X2_1", label:"1", prob: r1x2["1"], odd: odds?.["1X2"]?.["1"] },
    { key:"1X2_X", label:"X", prob: r1x2["X"], odd: odds?.["1X2"]?.["X"] },
    { key:"1X2_2", label:"2", prob: r1x2["2"], odd: odds?.["1X2"]?.["2"] }
  ];

  // calcolo “value” se c’è quota
  for(const c of candidates){
    const ip = impliedProbPct(c.odd);
    c.implied = ip;
    c.valueEdge = (ip==null) ? null : (c.prob - ip);
  }

  // TOP = più probabile, ma evito pronostici “banali” oltre 92% (spesso irreali)
  const sorted = [...candidates].sort((a,b) => b.prob - a.prob);
  let top = sorted.find(x => x.prob <= 92) || sorted[0];

  // confidence (0-100) = funzione della probabilità top e stabilità (distanza da 50)
  const conf = clamp(40, 35 + (top.prob * 0.65) + (Math.abs(top.prob-50) * 0.25), 95);

  return { pGG, pO25, top, conf, candidates, r1x2, dc };
}

/* =========================
   LOAD LEAGUES (dynamic)
========================= */
async function loadLeagues(){
  const btn = $("btnLeagues");
  setBusy(btn, true, "Carico...");
  $("leaguesList").innerHTML = `<div class="muted">Caricamento leghe...</div>`;
  try{
    // tenta con current=true per ridurre
